<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="stay hungry,stay foolish"><meta name=author content=Kaliarch><link href=https://redhatxl.github.io/cloud-native/servicemesh/istio/istio%E7%AC%94%E8%AE%B0/ rel=canonical><link href=../Istio%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%BB%9C/ rel=prev><link href=../../../operator/other/k8s%20%E9%9B%86%E7%BE%A4etcd%E6%8E%92%E9%94%99/ rel=next><link rel=icon href=../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.16"><title>istio笔记 - Kaliarch Blog</title><link rel=stylesheet href=../../../../assets/stylesheets/main.bcfcd587.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-G9D2HRH134"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-G9D2HRH134",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-G9D2HRH134",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#istio class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../.. title="Kaliarch Blog" class="md-header__button md-logo" aria-label="Kaliarch Blog" data-md-component=logo> <img src=../../../../assets/images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kaliarch Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> istio笔记 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=light-blue data-md-color-accent=purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/redhatxl/redhatxl.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> redhatxl.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> 首页 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../develop/01-k8s%20%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D/ class=md-tabs__link> 云原生 </a> </li> <li class=md-tabs__item> <a href=../../../../devops/Gitlab%20CI/01%E6%95%8F%E6%8D%B7%E6%97%A0%E6%95%8C%E4%B9%8B%E5%AE%9E%E6%88%98Gitlab%20CI/ class=md-tabs__link> devops </a> </li> <li class=md-tabs__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/ class=md-tabs__link> 开发技术 </a> </li> <li class=md-tabs__item> <a href=../../../../linux/system/Linux%20grub%3Agrub2%E8%AF%A6%E8%A7%A3/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../../other/ class=md-tabs__link> 其他 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Kaliarch Blog" class="md-nav__button md-logo" aria-label="Kaliarch Blog" data-md-component=logo> <img src=../../../../assets/images/logo.png alt=logo> </a> Kaliarch Blog </label> <div class=md-nav__source> <a href=https://github.com/redhatxl/redhatxl.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> redhatxl.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> 云原生 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> 云原生 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> 开发 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../develop/01-k8s%20%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D/ class=md-nav__link> <span class=md-ellipsis> 1.K8s 开发概念简介 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/02-K8s%20API%20%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.K8s API访问方式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/03-Client-go%20%E4%BD%BF%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 3.Client-go 的使用 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/04-Cobra%20%2B%20Client-go%E5%AE%9E%E7%8E%B0K8s%E7%AE%80%E5%8D%95%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 4.Cobra+Client-go实现K8s插件开发 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/05-client-go%E4%B9%8BListWatcher%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 5.Client-go源码分析之ListerWatcher </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/06-client-go%E4%B9%8BReflector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 6.Client-go源码分析之Reflector </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/07-client-go%E4%B9%8BDeltaFIFO%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 7.Client-go源码分析之DeltaFIFO </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/08-client-go%E4%B9%8BInformer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 8.Client-go源码分析之Informer </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/09-client-go%E4%B9%8BSharedInformer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 9.Client-go源码分析之SharedInformer </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/10-client-go%E4%B9%8BIndexer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 10.Client-go源码分析之Indexer </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/11-client-go%E4%B9%8BWorkqueue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 11.Client-go源码分析之WorkQueue </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/12-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0Controller/ class=md-nav__link> <span class=md-ellipsis> 12.自定义实现Controller </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/13-%E8%AE%A4%E8%AF%86CRD/ class=md-nav__link> <span class=md-ellipsis> 13.认识CRD </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/x-Informer%E5%AE%9E%E6%88%98%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96K8s%E4%BA%8B%E4%BB%B6%E8%87%B3ElasticSearch/ class=md-nav__link> <span class=md-ellipsis> x-Informer实战之持久化K8s事件至ElasticSearch </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/x-DeltaFIFO%E5%92%8Cindexer%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AF%B9%E6%AF%94/ class=md-nav__link> <span class=md-ellipsis> x-DeltaFIFO 与 Indexer关系 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2 checked> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> 运维 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 运维 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1> <label class=md-nav__link for=__nav_2_2_1 id=__nav_2_2_1_label tabindex=0> <span class=md-ellipsis> 工具 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1> <span class="md-nav__icon md-icon"></span> 工具 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operator/tools/K8s%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E4%B9%8BKUR8/ class=md-nav__link> <span class=md-ellipsis> K8s可视化工具之KUR8 </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/K8s%E5%BF%AB%E6%8D%B7%E6%93%8D%E4%BD%9C%E5%B7%A5%E5%85%B7%E4%B9%8BK9s/ class=md-nav__link> <span class=md-ellipsis> K8s快捷操作工具之K9s </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/K8s%E8%89%B2%E5%BD%A9%E8%BE%93%E5%87%BA%E5%B7%A5%E5%85%B7%E4%B9%8Bkubecolor/ class=md-nav__link> <span class=md-ellipsis> K8s色彩输出工具之kubecolor </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/K8s%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B%E7%A5%9E%E5%99%A8%E4%B9%8Bkubetail/ class=md-nav__link> <span class=md-ellipsis> K8s日志查看利器之kubetail </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/K8s%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7%E4%B9%8Bsniff/ class=md-nav__link> <span class=md-ellipsis> K8s 网络抓包之sniff </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/Kubernetes%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> Kubernetes 六款备份还原工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/k8s%E6%8F%92%E4%BB%B6%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E4%B9%8Bkrew/ class=md-nav__link> <span class=md-ellipsis> k8s 插件管理工具之krew </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/%E6%9E%B6%E6%9E%84%E5%9B%BE%E7%A5%9E%E5%99%A8DaC%E4%B9%8BDiagram/ class=md-nav__link> <span class=md-ellipsis> 架构图神器DaC之Diagram </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/tools/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E4%B9%8Bvelero%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 云原生备份恢复之velero实战 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2 id=__nav_2_2_2_label tabindex=0> <span class=md-ellipsis> 部署 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> 部署 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operator/deploy/Ceph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/ class=md-nav__link> <span class=md-ellipsis> Ceph机器安装部署 </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E4%B9%8Bminikube/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之Minikube </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B9%8BK3s/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之K3s </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B9%8BKind/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之Kind </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B9%8BMicroK8s/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之MicroK8s </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3 checked> <label class=md-nav__link for=__nav_2_2_3 id=__nav_2_2_3_label tabindex=0> <span class=md-ellipsis> servicemesh </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2_3> <span class="md-nav__icon md-icon"></span> servicemesh </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_1 checked> <label class=md-nav__link for=__nav_2_2_3_1 id=__nav_2_2_3_1_label tabindex=0> <span class=md-ellipsis> istio </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2_3_1> <span class="md-nav__icon md-icon"></span> istio </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Envoy%E7%AC%94%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> Envoy笔记 </span> </a> </li> <li class=md-nav__item> <a href=../服务网格进阶实战.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../详解.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../Istio%E4%B9%8BXDS%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> Istio之XDS协议解析 </span> </a> </li> <li class=md-nav__item> <a href=../Istio%E7%AC%94%E8%AE%B0%E4%B9%8BGateway/ class=md-nav__link> <span class=md-ellipsis> Istio笔记之Gateway </span> </a> </li> <li class=md-nav__item> <a href=../Istio%E7%AC%94%E8%AE%B0%E4%B9%8Bpilot/ class=md-nav__link> <span class=md-ellipsis> Istio笔记之pilot </span> </a> </li> <li class=md-nav__item> <a href=../Istio%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/ class=md-nav__link> <span class=md-ellipsis> Istio灰度发布 </span> </a> </li> <li class=md-nav__item> <a href=../Istio之流量管理.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../Istio%E7%AE%80%E4%BB%8B%E5%8F%8A%E6%9E%B6%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> Istio简介及架构 </span> </a> </li> <li class=md-nav__item> <a href=../Istio%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E7%AC%94%E8%AE%B0%28%E4%B8%80%29/ class=md-nav__link> <span class=md-ellipsis> Istio微服务治理笔记(一) </span> </a> </li> <li class=md-nav__item> <a href=../Istio%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%BB%9C/ class=md-nav__link> <span class=md-ellipsis> Istio基础之服务网络 </span> </a> </li> <li class=md-nav__item> <a href=../微服务金丝雀发布.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> istio笔记 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_4> <label class=md-nav__link for=__nav_2_2_4 id=__nav_2_2_4_label tabindex=0> <span class=md-ellipsis> 排错 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_4> <span class="md-nav__icon md-icon"></span> 排错 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operator/other/k8s%20%E9%9B%86%E7%BE%A4etcd%E6%8E%92%E9%94%99/ class=md-nav__link> <span class=md-ellipsis> k8s 集群etcd排错 </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/other/CronHPA/ class=md-nav__link> <span class=md-ellipsis> CronHPA初探 </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/other/%E8%AE%B0%E4%B8%80%E6%AC%A1K8smaster%20%E8%8A%82%E7%82%B9%E4%B8%80%E6%AC%A1%E6%8E%92%E9%94%99%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 记一次K8smaster 节点一次排错实战 </span> </a> </li> <li class=md-nav__item> <a href=../../../operator/other/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8Ak8s%E8%8A%82%E7%82%B9%E7%BB%B4%E6%8A%A4/ class=md-nav__link> <span class=md-ellipsis> 记一次线上k8s节点维护 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_5> <label class=md-nav__link for=__nav_2_2_5 id=__nav_2_2_5_label tabindex=0> <span class=md-ellipsis> 容器 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_5> <span class="md-nav__icon md-icon"></span> 容器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../%E5%AE%B9%E5%99%A8/Dockerfile%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Dockerfile 最佳实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%B9%E5%99%A8/Docker%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> Docker底层原理 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%B9%E5%99%A8/podman%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Podman详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%B9%E5%99%A8/%E5%88%A9%E7%94%A8katacoda%20%E5%AE%9E%E7%8E%B0%E6%8B%89%E5%8F%96%E5%9B%BD%E5%A4%96%E9%95%9C%E5%83%8F/ class=md-nav__link> <span class=md-ellipsis> 利用katacoda实现拉取国外镜像 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%B9%E5%99%A8/%E9%95%9C%E5%83%8F%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 镜像底层原理 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%B9%E5%99%A8/Harbor%E5%92%8Cregistry%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/ class=md-nav__link> <span class=md-ellipsis> Harbor/registry镜像仓库部署 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> 安全 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 安全 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BKube-bench/ class=md-nav__link> <span class=md-ellipsis> K8s 安全之Kube-bench </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/Kubeeye%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> KubeEye源码分析 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BKubeeye/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全之KubeEye </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BNPD/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全之NPD </span> </a> </li> <li class=md-nav__item> <a href="../../../安全/Kubernetes安全之Open/ Policy/ Agent.md" class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8Bopenebs/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全之openebs </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全分析 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BPolaris/ class=md-nav__link> <span class=md-ellipsis> kubernetes安全之Polaris </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8Bkubescape/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全扫描之kubescape </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%AE%89%E5%85%A8%E4%B9%8BTrivy/ class=md-nav__link> <span class=md-ellipsis> 镜像安全扫描之Trivy </span> </a> </li> <li class=md-nav__item> <a href=../../../%E5%AE%89%E5%85%A8/%E5%BC%80%E6%BA%90%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8%E5%B9%B3%E5%8F%B0%E4%B9%8BNeuVector/ class=md-nav__link> <span class=md-ellipsis> 开源容器安全平台之NeuVector </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../other/inside-kubernetes%20controller/ class=md-nav__link> <span class=md-ellipsis> Inside Kubernetes controller </span> </a> </li> <li class=md-nav__item> <a href=../../../other/Kubectl插件开发及开业分享.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../../other/KubeEdge/ class=md-nav__link> <span class=md-ellipsis> KubeEdge初探 </span> </a> </li> <li class=md-nav__item> <a href=../../../other/Kubernetes%E5%BC%80%E5%8F%91%E6%8E%92%E9%94%99%E6%9D%82%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> Kubernetes开发排错杂记 </span> </a> </li> <li class=md-nav__item> <a href=../../../other/Kubernetes%E7%94%9F%E6%88%90kubeconfig/ class=md-nav__link> <span class=md-ellipsis> Kubernetes生成kubeconfig </span> </a> </li> <li class=md-nav__item> <a href=../../../other/%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%8E%9F%E7%94%9FCCE%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 华为云原生CCE实战 </span> </a> </li> <li class=md-nav__item> <a href=../../../other/%E5%BE%AE%E6%9C%8D%E5%8A%A1API%E7%BD%91%E5%85%B3-Kong/ class=md-nav__link> <span class=md-ellipsis> 微服务API网关-Kong </span> </a> </li> <li class=md-nav__item> <a href=../../../other/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%AD10%E7%A7%8D%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 微服务架构中10种常用设计模式 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> devops </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> devops </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> GitLab CI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> GitLab CI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/Gitlab%20CI/01%E6%95%8F%E6%8D%B7%E6%97%A0%E6%95%8C%E4%B9%8B%E5%AE%9E%E6%88%98Gitlab%20CI/ class=md-nav__link> <span class=md-ellipsis> 1.敏捷无敌之Gitlab CI </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/Gitlab%20CI/02%E6%95%8F%E6%8D%B7%E6%97%A0%E6%95%8C%E4%B9%8BGitlab%20CI%E6%9E%B6%E6%9E%84%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> 2.敏捷无敌之Gitlab CI架构流程详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/Gitlab%20CI/03%E5%AE%9E%E6%88%98Gitlab%20CI%20%2B%20Supervisor%20%E5%8F%91%E5%B8%83Python%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> 3.实战Gitlab CI + Supervisor 发布Python项目 </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/Gitlab%20CI/04%E5%AE%9E%E6%88%98%E5%89%8D%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE%E5%8F%8A%E6%B7%B7%E5%90%88%E7%8E%AF%E5%A2%83Gitlab%20CI/ class=md-nav__link> <span class=md-ellipsis> 4.实战前后端项目及混合环境Gitlab CI </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/Gitlab%20CI/05%E5%AE%9E%E6%88%98Gitlab%20CI%20%2B%20Kubernetes%20%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83/ class=md-nav__link> <span class=md-ellipsis> 5.实战Kubernetes Gitlab CI </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/Gitlab%20CI/Gitlab%20CI%E4%B9%8B%20%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E4%BB%A3%E7%A0%81%E6%89%AB%E6%8F%8F/ class=md-nav__link> <span class=md-ellipsis> Gitlab CI之单元测试和代码扫描 </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/Gitlab%20CI/Gitlab%20CI%E8%BF%9B%E9%98%B6%E4%B9%8B%E5%85%B1%E4%BA%ABCI%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> Gitlab CI进阶之共享CI库 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> IaC </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> IaC </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/IaC/Terraform/IaC%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7%E4%B9%8BTerrascan/ class=md-nav__link> <span class=md-ellipsis> IaC扫描工具之Terrascan </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/IaC/Terraform/IaC%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E4%B9%8BTerratest/ class=md-nav__link> <span class=md-ellipsis> IaC测试工具之Terratest </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/IaC/Terraform/terraform-book/ class=md-nav__link> <span class=md-ellipsis> Terraform book </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/IaC/Terraform/Terraform%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> Terraform 相关概念及函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/IaC/Terraform/terraform%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Terraform 最佳实践 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/other/Argo%20CD/ class=md-nav__link> <span class=md-ellipsis> Argo CD </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/other/IaC%E4%B9%8BTerraform%20%E4%B8%8EPulumi%E4%BD%BF%E7%94%A8%E5%AF%B9%E6%AF%94/ class=md-nav__link> <span class=md-ellipsis> IaC之Terraform 与Pulumi使用对比 </span> </a> </li> <li class=md-nav__item> <a href=../../../../devops/other/Packer/ class=md-nav__link> <span class=md-ellipsis> 镜像定义工具Packer实战 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> 开发技术 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 开发技术 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> 设计模式 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> 设计模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_1> <label class=md-nav__link for=__nav_4_1_1 id=__nav_4_1_1_label tabindex=0> <span class=md-ellipsis> 创建型 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_1> <span class="md-nav__icon md-icon"></span> 创建型 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 1.简单工厂模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/02-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.工厂方法模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/03-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 3.抽象工厂模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/04-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 4.建造者(生成器)模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/05-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 5.单例模式 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_2> <label class=md-nav__link for=__nav_4_1_2 id=__nav_4_1_2_label tabindex=0> <span class=md-ellipsis> 结构型 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_2> <span class="md-nav__icon md-icon"></span> 结构型 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 1.装饰器模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/02-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.代理模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/03-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 3.桥接模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/04-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 4.适配器模式 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_3> <label class=md-nav__link for=__nav_4_1_3 id=__nav_4_1_3_label tabindex=0> <span class=md-ellipsis> 行为型 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_3> <span class="md-nav__icon md-icon"></span> 行为型 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 1.策略模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/02-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.观察者模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/03-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%A8%A1%E7%89%88%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.模版模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/04-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%81%8C%E8%B4%A3%E9%93%BE%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 4.职责链模式 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Golang </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_1> <label class=md-nav__link for=__nav_4_2_1 id=__nav_4_2_1_label tabindex=0> <span class=md-ellipsis> Gin </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_1> <span class="md-nav__icon md-icon"></span> Gin </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../develop/Golang/gin/gin%20%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E7%83%AD%E5%8A%A0%E8%BD%BD/ class=md-nav__link> <span class=md-ellipsis> Gin框架热加载 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/Golang/gin/gin-swagger/ class=md-nav__link> <span class=md-ellipsis> Gin + Swagger快速生成API文档 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/Golang/gin/gin-validator%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/ class=md-nav__link> <span class=md-ellipsis> gin-validator参数校验 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/Golang/gin/gin%E6%A1%86%E6%9E%B6%E4%BC%98%E9%9B%85%E5%85%B3%E6%9C%BA%E9%87%8D%E5%90%AF/ class=md-nav__link> <span class=md-ellipsis> Gin框架优雅关机和重启 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_2> <label class=md-nav__link for=__nav_4_2_2 id=__nav_4_2_2_label tabindex=0> <span class=md-ellipsis> 开发规范 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_2> <span class="md-nav__icon md-icon"></span> 开发规范 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%80%A7%E8%83%BD01/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之性能01 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8301/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范01 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8302/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范02 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8303/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范03 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8304/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范04 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9901/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则01 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F01/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之编程模式01 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9902/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则02 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9903/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则03 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9904/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则04 </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9905/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则05 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_3> <label class=md-nav__link for=__nav_4_2_3 id=__nav_4_2_3_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_3> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../develop/Golang/golang%20%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E6%9C%80%E7%BB%88%E4%B9%8Bjaeger/ class=md-nav__link> <span class=md-ellipsis> Golang 分布式链路追踪之jaeger </span> </a> </li> <li class=md-nav__item> <a href=../../../../develop/Golang/golang%20%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/ class=md-nav__link> <span class=md-ellipsis> Go 内存对齐 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1 id=__nav_5_1_label tabindex=0> <span class=md-ellipsis> 系统相关 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> 系统相关 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/system/Linux%20grub%3Agrub2%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Linux grub/grub2详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/system/Linux%20%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Linux 内核引导详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Linux 系统安全加固最佳实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/system/virtio%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Virtio 详解 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> Shell </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/shell/Shell%E7%AE%80%E4%BB%8B/ class=md-nav__link> <span class=md-ellipsis> Shell 教程概述 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/ class=md-nav__link> <span class=md-ellipsis> 1.第一个 Shell 程序 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/2.Shell%E5%8F%98%E9%87%8F/ class=md-nav__link> <span class=md-ellipsis> 2.Shell 变量 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/3.Shell%E5%8F%82%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 3.Shell 参数 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/4.Shell%E6%95%B0%E7%BB%84/ class=md-nav__link> <span class=md-ellipsis> 4.Shell数组 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/ class=md-nav__link> <span class=md-ellipsis> 5.Shell 运算符 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/6.Shell%20echo%3Aprintf%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 6.Shell echo/printf 命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 7.Shell test 命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> 8.Shell 流程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/9.Shell%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 8.Shell 函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/10.Shell%E8%BE%93%E5%85%A5%3A%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/ class=md-nav__link> <span class=md-ellipsis> 10.Shell输入/输出重定向 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 11.Shell 正则表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/ class=md-nav__link> <span class=md-ellipsis> 12.Shell 三剑客之grep </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/ class=md-nav__link> <span class=md-ellipsis> 13.Shell三剑客之sed </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/ class=md-nav__link> <span class=md-ellipsis> 14.Shell三剑客之awk </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> 15.Shell常用工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../../linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> 16.Shell实战项目 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../other/ class=md-nav__link> <span class=md-ellipsis> 工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../../other/ class=md-nav__link> <span class=md-ellipsis> 杂记 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=istio>istio笔记<a class=headerlink href=#istio title="Permanent link">&para;</a></h1> <h1 id=_1>一 基础概念<a class=headerlink href=#_1 title="Permanent link">&para;</a></h1> <h2 id=11-istio>1.1 istio是什么<a class=headerlink href=#11-istio title="Permanent link">&para;</a></h2> <p>Istio 允许您连接、保护、控制和观测微服务，在较高的层次上，Istio 有助于降低这些部署的复杂性，并减轻开发团队的压力。它是一个完全开源的服务网格，可以透明地分层到现有的分布式应用程序上。它也是一个平台，包括允许它集成到任何日志记录平台、遥测或策略系统的 API。Istio 的多样化功能集使您能够成功高效地运行分布式微服务架构，并提供保护、连接和监控微服务的统一方法。</p> <h2 id=12-service-mesh>1.2 什么是service mesh<a class=headerlink href=#12-service-mesh title="Permanent link">&para;</a></h2> <p>在从单体应用程序向分布式微服务架构的转型过程中，开发人员和运维人员面临诸多挑战，使用 Istio 可以解决这些问题。</p> <p>服务网格（Service Mesh）这个术语通常用于描述构成这些应用程序的微服务网络以及应用之间的交互。随着规模和复杂性的增长，服务网格越来越难以理解和管理。它的需求包括服务发现、负载均衡、故障恢复、指标收集和监控以及通常更加复杂的运维需求，例如 A/B 测试、金丝雀发布、限流、访问控制和端到端认证等。</p> <p>Istio 提供了一个完整的解决方案，通过为整个服务网格提供行为洞察和操作控制来满足微服务应用程序的多样化需求。</p> <h2 id=13-istio>1.3 为什么使用istio<a class=headerlink href=#13-istio title="Permanent link">&para;</a></h2> <p>Istio 提供一种简单的方式来为已部署的服务建立网络，该网络具有负载均衡、服务间认证、监控等功能，只需要对服务的代码进行<a href=https://istio.io/zh/docs/tasks/telemetry/distributed-tracing/overview/#trace-context-propagation>一点</a>或不需要做任何改动。想要让服务支持 Istio，只需要在您的环境中部署一个特殊的 sidecar 代理，使用 Istio 控制平面功能配置和管理代理，拦截微服务之间的所有网络通信：</p> <ul> <li>HTTP、gRPC、WebSocket 和 TCP 流量的自动负载均衡。</li> <li>通过丰富的路由规则、重试、故障转移和故障注入，可以对流量行为进行细粒度控制。</li> <li>可插入的策略层和配置 API，支持访问控制、速率限制和配额。</li> <li>对出入集群入口和出口中所有流量的自动度量指标、日志记录和追踪。</li> <li>通过强大的基于身份的验证和授权，在集群中实现安全的服务间通信。</li> </ul> <p>Istio 旨在实现可扩展性，满足各种部署需求。</p> <h1 id=_2>二 核心功能<a class=headerlink href=#_2 title="Permanent link">&para;</a></h1> <h2 id=21>2.1 流量管理<a class=headerlink href=#21 title="Permanent link">&para;</a></h2> <p>通过简单的规则配置和流量路由，您可以控制服务之间的流量和 API 调用。Istio 简化了断路器、超时和重试等服务级别属性的配置，并且可以轻松设置 A/B测试、金丝雀部署和基于百分比的流量分割的分阶段部署等重要任务。</p> <p>通过更好地了解您的流量和开箱即用的故障恢复功能，您可以在问题出现之前先发现问题，使调用更可靠，并且使您的网络更加强大——无论您面临什么条件。</p> <h2 id=22>2.2 安全<a class=headerlink href=#22 title="Permanent link">&para;</a></h2> <p>Istio 的安全功能使开发人员可以专注于应用程序级别的安全性。Istio 提供底层安全通信信道，并大规模管理服务通信的认证、授权和加密。使用Istio，服务通信在默认情况下是安全的，它允许您跨多种协议和运行时一致地实施策略——所有这些都很少或根本不需要应用程序更改。</p> <p>虽然 Istio 与平台无关，但将其与 Kubernetes（或基础架构）网络策略结合使用，其优势会更大，包括在网络和应用层保护 pod 间或服务间通信的能力。</p> <h2 id=23>2.3 可观察行<a class=headerlink href=#23 title="Permanent link">&para;</a></h2> <p>Istio 强大的追踪、监控和日志记录可让您深入了解服务网格部署。通过 Istio 的监控功能，可以真正了解服务性能如何影响上游和下游的功能，而其自定义仪表板可以提供对所有服务性能的可视性，并让您了解该性能如何影响您的其他进程。</p> <p>Istio 的 Mixer 组件负责策略控制和遥测收集。它提供后端抽象和中介，将 Istio 的其余部分与各个基础架构后端的实现细节隔离开来，并为运维提供对网格和基础架构后端之间所有交互的细粒度控制。</p> <p>所有这些功能可以让您可以更有效地设置、监控和实施服务上的 SLO。当然，最重要的是，您可以快速有效地检测和修复问题。</p> <h2 id=24>2.4 平台支持<a class=headerlink href=#24 title="Permanent link">&para;</a></h2> <p>stio 是独立于平台的，旨在运行在各种环境中，包括跨云、内部部署、Kubernetes、Mesos 等。您可以在 Kubernetes 上部署 Istio 或具有 Consul 的 Nomad 上部署。Istio 目前支持：</p> <ul> <li>在 Kubernetes 上部署的服务</li> <li>使用 Consul 注册的服务</li> <li>在虚拟机上部署的服务</li> </ul> <h2 id=25>2.5 集成和定制<a class=headerlink href=#25 title="Permanent link">&para;</a></h2> <p>策略执行组件可以扩展和定制，以便与现有的 ACL、日志、监控、配额、审计等方案集成。</p> <h1 id=_3>三 架构<a class=headerlink href=#_3 title="Permanent link">&para;</a></h1> <p>Istio 服务网格逻辑上分为**数据平面**和**控制平面**。</p> <ul> <li>**数据平面**由一组以 sidecar 方式部署的智能代理（<a href=https://www.envoyproxy.io/ >Envoy</a>）组成。这些代理可以调节和控制微服务及 <a href=https://istio.io/zh/docs/concepts/policies-and-telemetry/ >Mixer</a> 之间所有的网络通信。</li> <li>**控制平面**负责管理和配置代理来路由流量。此外控制平面配置 Mixer 以实施策略和收集遥测数据。</li> </ul> <h2 id=31>3.1 架构图<a class=headerlink href=#31 title="Permanent link">&para;</a></h2> <p><img alt=image-20190803233405428 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190803233405428.png"></p> <h2 id=32>3.2 组件<a class=headerlink href=#32 title="Permanent link">&para;</a></h2> <h3 id=321-envoy>3.2.1 Envoy<a class=headerlink href=#321-envoy title="Permanent link">&para;</a></h3> <p>Istio 使用 <a href=https://www.envoyproxy.io/ >Envoy</a> 代理的扩展版本，Envoy 是以 C++ 开发的高性能代理，用于调解服务网格中所有服务的所有入站和出站流量。Envoy 的许多内置功能被 Istio 发扬光大，例如：</p> <ul> <li>动态服务发现</li> <li>负载均衡</li> <li>TLS 终止</li> <li>HTTP/2 &amp; gRPC 代理</li> <li>熔断器</li> <li>健康检查、基于百分比流量拆分的灰度发布</li> <li>故障注入</li> <li>丰富的度量指标</li> </ul> <p>Envoy 被部署为 <strong>sidecar</strong>，和对应服务在同一个 Kubernetes pod 中。这允许 Istio 将大量关于流量行为的信号作为<a href=https://istio.io/zh/docs/concepts/policies-and-telemetry/#属性>属性</a>提取出来，而这些属性又可以在 <a href=https://istio.io/zh/docs/concepts/policies-and-telemetry/ >Mixer</a> 中用于执行策略决策，并发送给监控系统，以提供整个网格行为的信息。</p> <p>Sidecar 代理模型还可以将 Istio 的功能添加到现有部署中，而无需重新构建或重写代码。可以阅读更多来了解为什么我们在<a href=https://istio.io/zh/docs/concepts/what-is-istio/#设计目标>设计目标</a>中选择这种方式。</p> <h3 id=322-mixer>3.2.2 Mixer<a class=headerlink href=#322-mixer title="Permanent link">&para;</a></h3> <p><a href=https://istio.io/zh/docs/concepts/policies-and-telemetry/ >Mixer</a> 是一个独立于平台的组件，负责在服务网格上执行访问控制和使用策略，并从 Envoy 代理和其他服务收集遥测数据。代理提取请求级<a href=https://istio.io/zh/docs/concepts/policies-and-telemetry/#属性>属性</a>，发送到 Mixer 进行评估。有关属性提取和策略评估的更多信息，请参见 <a href=https://istio.io/zh/docs/concepts/policies-and-telemetry/#配置模型>Mixer 配置</a>。</p> <p>Mixer 中包括一个灵活的插件模型，使其能够接入到各种主机环境和基础设施后端，从这些细节中抽象出 Envoy 代理和 Istio 管理的服务。</p> <h3 id=323-pilot>3.2.3 Pilot<a class=headerlink href=#323-pilot title="Permanent link">&para;</a></h3> <p><a href=https://istio.io/zh/docs/concepts/traffic-management/#pilot-和-envoy>Pilot</a> 为 Envoy sidecar 提供服务发现功能，为智能路由（例如 A/B 测试、金丝雀部署等）和弹性（超时、重试、熔断器等）提供流量管理功能。它将控制流量行为的高级路由规则转换为特定于 Envoy 的配置，并在运行时将它们传播到 sidecar。</p> <p>Pilot 将平台特定的服务发现机制抽象化并将其合成为符合 <a href=https://github.com/envoyproxy/data-plane-api>Envoy 数据平面 API</a> 的任何 sidecar 都可以使用的标准格式。这种松散耦合使得 Istio 能够在多种环境下运行（例如，Kubernetes、Consul、Nomad），同时保持用于流量管理的相同操作界面。</p> <h3 id=324-citadel>3.2.4 Citadel<a class=headerlink href=#324-citadel title="Permanent link">&para;</a></h3> <p><a href=https://istio.io/zh/docs/concepts/security/ >Citadel</a> 通过内置身份和凭证管理赋能强大的服务间和最终用户身份验证。可用于升级服务网格中未加密的流量，并为运维人员提供基于服务标识而不是网络控制的强制执行策略的能力。从 0.5 版本开始，Istio 支持<a href=https://istio.io/zh/docs/concepts/security/#认证>基于角色的访问控制</a>，以控制谁可以访问您的服务，而不是基于不稳定的三层或四层网络标识。</p> <h3 id=325-galley>3.2.5 Galley<a class=headerlink href=#325-galley title="Permanent link">&para;</a></h3> <p>Galley 代表其他的 Istio 控制平面组件，用来验证用户编写的 Istio API 配置。随着时间的推移，Galley 将接管 Istio 获取配置、 处理和分配组件的顶级责任。它将负责将其他的 Istio 组件与从底层平台（例如 Kubernetes）获取用户配置的细节中隔离开来。</p> <h2 id=33>3.3 设计目标<a class=headerlink href=#33 title="Permanent link">&para;</a></h2> <ul> <li><strong>最大化透明度</strong>：若想 Istio 被采纳，应该让运维和开发人员只需付出很少的代价就可以从中受益。为此，Istio 将自身自动注入到服务间所有的网络路径中。Istio 使用 sidecar 代理来捕获流量，并且在尽可能的地方自动编程网络层，以路由流量通过这些代理，而无需对已部署的应用程序代码进行任何改动。在 Kubernetes中，代理被注入到 pod 中，通过编写 iptables 规则来捕获流量。注入 sidecar 代理到 pod 中并且修改路由规则后，Istio 就能够调解所有流量。这个原则也适用于性能。当将 Istio 应用于部署时，运维人员可以发现，为提供这些功能而增加的资源开销是很小的。所有组件和 API 在设计时都必须考虑性能和规模。</li> <li><strong>可扩展性</strong>：随着运维人员和开发人员越来越依赖 Istio 提供的功能，系统必然和他们的需求一起成长。虽然我们期望继续自己添加新功能，但是我们预计最大的需求是扩展策略系统，集成其他策略和控制来源，并将网格行为信号传播到其他系统进行分析。策略运行时支持标准扩展机制以便插入到其他服务中。此外，它允许扩展词汇表，以允许基于网格生成的新信号来执行策略。</li> <li><strong>可移植性</strong>：使用 Istio 的生态系统将在很多维度上有差异。Istio 必须能够以最少的代价运行在任何云或预置环境中。将基于 Istio 的服务移植到新环境应该是轻而易举的，而使用 Istio 将一个服务同时部署到多个环境中也是可行的（例如，在多个云上进行冗余部署）。</li> <li><strong>策略一致性</strong>：在服务间的 API 调用中，策略的应用使得可以对网格间行为进行全面的控制，但对于无需在 API 级别表达的资源来说，对资源应用策略也同样重要。例如，将配额应用到 ML 训练任务消耗的 CPU 数量上，比将配额应用到启动这个工作的调用上更为有用。因此，策略系统作为独特的服务来维护，具有自己的 API，而不是将其放到代理/sidecar 中，这容许服务根据需要直接与其集成。</li> </ul> <h1 id=_4>四 安装部署<a class=headerlink href=#_4 title="Permanent link">&para;</a></h1> <h2 id=41-katacoda-istio>4.1 katacoda 部署istio<a class=headerlink href=#41-katacoda-istio title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># 安装cli工具</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>curl<span class=w> </span>-L<span class=w> </span>https://git.io/getLatestIstio<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>ISTIO_VERSION</span><span class=o>=</span><span class=m>1</span>.0.0<span class=w> </span>sh<span class=w> </span>-
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=nb>export</span><span class=w> </span><span class=nv>PATH</span><span class=o>=</span><span class=s2>&quot;</span><span class=nv>$PATH</span><span class=s2>:/root/istio-1.0.0/bin&quot;</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=nb>cd</span><span class=w> </span>/root/istio-1.0.0
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=c1># 配置istio crd</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>install/kubernetes/helm/istio/templates/crds.yaml<span class=w> </span>-n<span class=w> </span>istio-system
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=c1># 配置TLS</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>install/kubernetes/istio-demo-auth.yaml
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=c1># 检测配置</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>istio-system
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=c1># 配置Katacoda Service</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>/root/katacoda.yaml
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=c1># 安装配置实例</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>&lt;<span class=o>(</span>istioctl<span class=w> </span>kube-inject<span class=w> </span>-f<span class=w> </span>samples/bookinfo/platform/kube/bookinfo.yaml<span class=o>)</span>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=c1># 部署网关</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>samples/bookinfo/networking/bookinfo-gateway.yaml
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=c1># 应用默认规则</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>samples/bookinfo/networking/destination-rule-all-mtls.yaml
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>
<a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>
<a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=c1># 查看虚拟服务</span>
<a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>istioctl<span class=w> </span>get<span class=w> </span>virtualservices
</code></pre></div> <p><img alt=image-20190804095128570 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190804095128570.png"></p> <h2 id=42-minikube-istio>4.2 minikube 中体验istio<a class=headerlink href=#42-minikube-istio title="Permanent link">&para;</a></h2> <p>安装脚本</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>curl<span class=w> </span>-o<span class=w> </span>/etc/yum.repos.d/docker-ce.repo<span class=w> </span>https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>cat<span class=w> </span>&gt;&gt;/etc/yum.repos.d/kuberetes.repo<span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=s>[kuberneres]</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=s>name=Kubernetes</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=s>gpgcheck=0</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=s>enabled=1</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=s>EOF</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>yum<span class=w> </span>install<span class=w> </span>docker-ce<span class=w> </span>kubelet<span class=w> </span>kubectl<span class=w> </span>kubeadm<span class=w> </span>-y
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>systemctl<span class=w> </span>start<span class=w> </span>docker
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>docker
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>kubelet
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=c1># 下载minikube</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>curl<span class=w> </span>-Lo<span class=w> </span>minikube<span class=w> </span>http://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.2.0/minikube-linux-amd64<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>minikube<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>sudo<span class=w> </span>mv<span class=w> </span>minikube<span class=w> </span>/usr/local/bin/
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>
<a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=c1># 启动--vm-driver=none 选项来在本机运行 Kubernetes 组件</span>
<a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>minikube<span class=w> </span>start<span class=w> </span>--vm-driver<span class=o>=</span>none<span class=w> </span>--registry-mirror<span class=o>=</span>https://registry.docker-cn.com
<a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>minikube<span class=w> </span>dashboard
</code></pre></div> <h3 id=421-minikube>4.2.1 minikube安装<a class=headerlink href=#421-minikube title="Permanent link">&para;</a></h3> <p>注意：服务器至少2颗CPU,由于强的原因，国内建议使用阿里的源，在linux服务器不启动virtualbox，则需要在宿主机安装docker和kubelet</p> <ul> <li>设置 docker 源</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>curl<span class=w> </span>-o<span class=w> </span>/etc/yum.repos.d/docker-ce.repo<span class=w> </span>https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre></div> <ul> <li>设置 k8s 源</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>cat<span class=w> </span>&gt;&gt;/etc/yum.repos.d/kuberetes.repo<span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=s>[kuberneres]</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=s>name=Kubernetes</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=s>gpgcheck=0</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=s>enabled=1</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>安装 docker-ce 和 kubelet kubectl</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>yum<span class=w> </span>install<span class=w> </span>docker-ce<span class=w> </span>kubelet<span class=w> </span>kubectl<span class=w> </span>kubeadm<span class=w> </span>-y
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>systemctl<span class=w> </span>start<span class=w> </span>docker
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>docker
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>kubelet
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=c1># 下载minikube</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>curl<span class=w> </span>-Lo<span class=w> </span>minikube<span class=w> </span>http://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.2.0/minikube-linux-amd64<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>minikube<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>sudo<span class=w> </span>mv<span class=w> </span>minikube<span class=w> </span>/usr/local/bin/
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=c1># 启动--vm-driver=none 选项来在本机运行 Kubernetes 组件</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>minikube<span class=w> </span>start<span class=w> </span>--vm-driver<span class=o>=</span>none<span class=w> </span>--registry-mirror<span class=o>=</span>https://registry.docker-cn.com
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>sudo<span class=w> </span>mv<span class=w> </span>/root/.kube<span class=w> </span>/root/.minikube<span class=w> </span><span class=nv>$HOME</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>sudo<span class=w> </span>chown<span class=w> </span>-R<span class=w> </span><span class=nv>$USER</span><span class=w> </span><span class=nv>$HOME</span>/.kube<span class=w> </span><span class=nv>$HOME</span>/.minikube
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=c1># 启动dashboard</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>minikube<span class=w> </span>dashboard
</code></pre></div> <p><img alt=image-20190805155430847 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805155430847.png"></p> <h3 id=422-istio>4.2.2 istio 安装<a class=headerlink href=#422-istio title="Permanent link">&para;</a></h3> <ul> <li>下载istio包</li> </ul> <p>下载 Istio 发布包,</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>curl<span class=w> </span>-L<span class=w> </span>https://git.io/getLatestIstio<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>ISTIO_VERSION</span><span class=o>=</span><span class=m>1</span>.2.2<span class=w> </span>sh<span class=w> </span>-
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=nb>cd</span><span class=w> </span>istio-1.2.2
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=c1># 将istioctl 添加入PATH</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>cp<span class=w> </span>bin/istioctl<span class=w> </span>/usr/bin/
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=nb>export</span><span class=w> </span><span class=nv>PATH</span><span class=o>=</span><span class=nv>$PWD</span>/bin:<span class=nv>$PATH</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=c1># 加载istioctl mainfest   </span>
</code></pre></div> <ul> <li>安装</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1># 安装CRD</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>for</span><span class=w> </span>i<span class=w> </span><span class=k>in</span><span class=w> </span>install/kubernetes/helm/istio-init/files/crd*yaml<span class=p>;</span><span class=w> </span><span class=k>do</span><span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span><span class=nv>$i</span><span class=p>;</span><span class=w> </span><span class=k>done</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=c1># 宽松模式mutual TLS</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>install/kubernetes/istio-demo.yaml
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=c1># 确认结果</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>kubectl<span class=w> </span>get<span class=w> </span>svc<span class=w> </span>-n<span class=w> </span>istio-system
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=c1># 查看istio-ingressgateway 如果没有lb，则为一种pending状态，可以将其修改为NodePort模式</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get service -n istio-system</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>NAME<span class=w>                     </span>TYPE<span class=w>        </span>CLUSTER-IP<span class=w>       </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>                                                                                                                                      </span>AGE
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>grafana<span class=w>                  </span>ClusterIP<span class=w>   </span><span class=m>10</span>.98.106.233<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>3000</span>/TCP<span class=w>                                                                                                                                     </span>29m
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>istio-citadel<span class=w>            </span>ClusterIP<span class=w>   </span><span class=m>10</span>.105.117.162<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>8060</span>/TCP,15014/TCP<span class=w>                                                                                                                           </span>29m
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>istio-egressgateway<span class=w>      </span>ClusterIP<span class=w>   </span><span class=m>10</span>.96.101.47<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>80</span>/TCP,443/TCP,15443/TCP<span class=w>                                                                                                                     </span>29m
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>istio-galley<span class=w>             </span>ClusterIP<span class=w>   </span><span class=m>10</span>.97.227.4<span class=w>      </span>&lt;none&gt;<span class=w>        </span><span class=m>443</span>/TCP,15014/TCP,9901/TCP<span class=w>                                                                                                                   </span>29m
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>istio-ingressgateway<span class=w>     </span>NodePort<span class=w>    </span><span class=m>10</span>.108.162.3<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>15020</span>:31931/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32205/TCP,15030:31540/TCP,15031:30722/TCP,15032:32366/TCP,15443:31319/TCP<span class=w>   </span>29m
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>istio-pilot<span class=w>              </span>ClusterIP<span class=w>   </span><span class=m>10</span>.111.150.44<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>15010</span>/TCP,15011/TCP,8080/TCP,15014/TCP<span class=w>                                                                                                       </span>29m
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>istio-policy<span class=w>             </span>ClusterIP<span class=w>   </span><span class=m>10</span>.101.26.145<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>9091</span>/TCP,15004/TCP,15014/TCP<span class=w>                                                                                                                 </span>29m
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>istio-sidecar-injector<span class=w>   </span>ClusterIP<span class=w>   </span><span class=m>10</span>.110.244.53<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>443</span>/TCP<span class=w>                                                                                                                                      </span>29m
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>istio-telemetry<span class=w>          </span>ClusterIP<span class=w>   </span><span class=m>10</span>.100.238.134<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>9091</span>/TCP,15004/TCP,15014/TCP,42422/TCP<span class=w>                                                                                                       </span>29m
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>jaeger-agent<span class=w>             </span>ClusterIP<span class=w>   </span>None<span class=w>             </span>&lt;none&gt;<span class=w>        </span><span class=m>5775</span>/UDP,6831/UDP,6832/UDP<span class=w>                                                                                                                   </span>29m
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>jaeger-collector<span class=w>         </span>ClusterIP<span class=w>   </span><span class=m>10</span>.99.246.30<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>14267</span>/TCP,14268/TCP<span class=w>                                                                                                                          </span>29m
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>jaeger-query<span class=w>             </span>ClusterIP<span class=w>   </span><span class=m>10</span>.109.225.169<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>16686</span>/TCP<span class=w>                                                                                                                                    </span>29m
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>kiali<span class=w>                    </span>ClusterIP<span class=w>   </span><span class=m>10</span>.106.46.153<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>20001</span>/TCP<span class=w>                                                                                                                                    </span>29m
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a>prometheus<span class=w>               </span>ClusterIP<span class=w>   </span><span class=m>10</span>.101.148.126<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>9090</span>/TCP<span class=w>                                                                                                                                     </span>29m
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a>tracing<span class=w>                  </span>ClusterIP<span class=w>   </span><span class=m>10</span>.109.118.137<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>80</span>/TCP<span class=w>                                                                                                                                       </span>29m
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a>zipkin<span class=w>                   </span>ClusterIP<span class=w>   </span><span class=m>10</span>.109.133.46<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>9411</span>/TCP<span class=w>                                                                                                                                     </span>29m
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=c1># 确认必要的 Kubernetes Pod 都已经创建并且其 STATUS 的值是 Running：</span>
<a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a>
<a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get pods -n istio-system</span>
<a id=__codelineno-6-36 name=__codelineno-6-36 href=#__codelineno-6-36></a>NAME<span class=w>                                      </span>READY<span class=w>   </span>STATUS<span class=w>      </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-6-37 name=__codelineno-6-37 href=#__codelineno-6-37></a>grafana-6575997f54-zlq9d<span class=w>                  </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-38 name=__codelineno-6-38 href=#__codelineno-6-38></a>istio-citadel-894d98c85-hqd8m<span class=w>             </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-39 name=__codelineno-6-39 href=#__codelineno-6-39></a>istio-cleanup-secrets-1.2.2-6qdt8<span class=w>         </span><span class=m>0</span>/1<span class=w>     </span>Completed<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-40 name=__codelineno-6-40 href=#__codelineno-6-40></a>istio-egressgateway-9b7866bf5-26q2n<span class=w>       </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-41 name=__codelineno-6-41 href=#__codelineno-6-41></a>istio-galley-5b984f89b-95c4c<span class=w>              </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-42 name=__codelineno-6-42 href=#__codelineno-6-42></a>istio-grafana-post-install-1.2.2-lv7xg<span class=w>    </span><span class=m>0</span>/1<span class=w>     </span>Completed<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-43 name=__codelineno-6-43 href=#__codelineno-6-43></a>istio-ingressgateway-75ddf64567-jlhf8<span class=w>     </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-44 name=__codelineno-6-44 href=#__codelineno-6-44></a>istio-pilot-5d77c559d4-4c5tg<span class=w>              </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-45 name=__codelineno-6-45 href=#__codelineno-6-45></a>istio-policy-86478df5d4-qd79g<span class=w>             </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>     </span><span class=m>5</span><span class=w>          </span>10m
<a id=__codelineno-6-46 name=__codelineno-6-46 href=#__codelineno-6-46></a>istio-security-post-install-1.2.2-lpvmc<span class=w>   </span><span class=m>0</span>/1<span class=w>     </span>Completed<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-47 name=__codelineno-6-47 href=#__codelineno-6-47></a>istio-sidecar-injector-7b98dd6bcc-kc622<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-48 name=__codelineno-6-48 href=#__codelineno-6-48></a>istio-telemetry-786747687f-h9vs6<span class=w>          </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>     </span><span class=m>5</span><span class=w>          </span>10m
<a id=__codelineno-6-49 name=__codelineno-6-49 href=#__codelineno-6-49></a>istio-tracing-555cf644d-z8pt2<span class=w>             </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-50 name=__codelineno-6-50 href=#__codelineno-6-50></a>kiali-6cd6f9dfb5-5ncxr<span class=w>                    </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
<a id=__codelineno-6-51 name=__codelineno-6-51 href=#__codelineno-6-51></a>prometheus-7d7b9f7844-wfdcl<span class=w>               </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>10m
</code></pre></div> <p>如果你的集群在一个没有外部负载均衡器支持的环境中运行（例如 Minikube），<code>istio-ingressgateway</code> 的 <code>EXTERNAL-IP</code> 会是 <code>&lt;pending&gt;</code>。要访问这个网关，只能通过服务的 <code>NodePort</code> 或者使用端口转发来进行访问。</p> <h3 id=423-bookinfo-demo>4.2.3 Bookinfo demo体验<a class=headerlink href=#423-bookinfo-demo title="Permanent link">&para;</a></h3> <ul> <li> <h4 id=_5>实验概述<a class=headerlink href=#_5 title="Permanent link">&para;</a></h4> </li> </ul> <p>部署一个样例应用，它由四个单独的微服务构成，用来演示多种 Istio 特性。这个应用模仿在线书店的一个分类，显示一本书的信息。页面上会显示一本书的描述，书籍的细节（ISBN、页数等），以及关于这本书的一些评论。</p> <p>Bookinfo 应用分为四个单独的微服务：</p> <ul> <li><code>productpage</code> ：<code>productpage</code> 微服务会调用 <code>details</code> 和 <code>reviews</code> 两个微服务，用来生成页面。</li> <li><code>details</code> ：这个微服务包含了书籍的信息。</li> <li><code>reviews</code> ：这个微服务包含了书籍相关的评论。它还会调用 <code>ratings</code> 微服务。</li> <li><code>ratings</code> ：<code>ratings</code> 微服务中包含了由书籍评价组成的评级信息。</li> </ul> <p><code>reviews</code> 微服务有 3 个版本：</p> <ul> <li>v1 版本不会调用 <code>ratings</code> 服务。</li> <li>v2 版本会调用 <code>ratings</code> 服务，并使用 1 到 5 个黑色星形图标来显示评分信息。</li> <li> <p>v3 版本会调用 <code>ratings</code> 服务，并使用 1 到 5 个红色星形图标来显示评分信息。</p> </li> <li> <h4 id=_6>架构拓扑<a class=headerlink href=#_6 title="Permanent link">&para;</a></h4> </li> </ul> <p><img alt=image-20190805161944923 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805161944923.png"></p> <p>Bookinfo 是一个异构应用，几个微服务是由不同的语言编写的。这些服务对 Istio 并无依赖，但是构成了一个有代表性的服务网格的例子：它由多个服务、多个语言构成，并且 <code>reviews</code> 服务具有多个版本。</p> <ul> <li> <h4 id=_7>部署应用<a class=headerlink href=#_7 title="Permanent link">&para;</a></h4> </li> </ul> <p>要在 Istio 中运行这一应用，无需对应用自身做出任何改变。我们只要简单的在 Istio 环境中对服务进行配置和运行，具体一点说就是把 Envoy sidecar 注入到每个服务之中。这个过程所需的具体命令和配置方法由运行时环境决定，而部署结果较为一致，如下图所示：</p> <p><img alt=image-20190805162157638 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805162157638.png"></p> <p>所有的微服务都和 Envoy sidecar 集成在一起，被集成服务所有的出入流量都被 sidecar 所劫持，这样就为外部控制准备了所需的 Hook，然后就可以利用 Istio 控制平面为应用提供服务路由、遥测数据收集以及策略实施等功能。</p> <ul> <li> <h4 id=bookinfo>部署bookinfo<a class=headerlink href=#bookinfo title="Permanent link">&para;</a></h4> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1># 在使用 kubectl apply 进行应用部署的时候，如果目标命名空间已经打上了标签 istio-injection=enabled，Istio sidecar injector 会自动把 Envoy 容器注入到你的应用 Pod 之中。</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>kubectl<span class=w> </span>label<span class=w> </span>namespace<span class=w> </span>default<span class=w> </span>istio-injection<span class=o>=</span>enabled
</code></pre></div> <p>如果目标命名空间中没有打上 <code>istio-injection</code> 标签， 可以使用 <a href=https://istio.io/zh/docs/reference/commands/istioctl/#istioctl-kube-inject><code>istioctl kube-inject</code></a> 命令，在部署之前手工把 Envoy 容器注入到应用 Pod 之中：<code>istioctl kube-inject -f &lt;your-app-spec&gt;.yaml | kubectl apply -f -</code></p> <h4 id=bookinfo_1>部署bookinfo：<a class=headerlink href=#bookinfo_1 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>service/details<span class=w> </span>created
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>serviceaccount/bookinfo-details<span class=w> </span>created
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>deployment.apps/details-v1<span class=w> </span>created
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>service/ratings<span class=w> </span>created
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>serviceaccount/bookinfo-ratings<span class=w> </span>created
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>deployment.apps/ratings-v1<span class=w> </span>created
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>service/reviews<span class=w> </span>created
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>serviceaccount/bookinfo-reviews<span class=w> </span>created
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>deployment.apps/reviews-v1<span class=w> </span>created
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>deployment.apps/reviews-v2<span class=w> </span>created
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>deployment.apps/reviews-v3<span class=w> </span>created
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>service/productpage<span class=w> </span>created
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>serviceaccount/bookinfo-productpage<span class=w> </span>created
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>deployment.apps/productpage-v1<span class=w> </span>created
</code></pre></div> <p>上面的命令会启动全部的四个服务，其中也包括了 <code>reviews</code> 服务的三个版本（<code>v1</code>、<code>v2</code> 以及 <code>v3</code>）</p> <h4 id=bookinfo_2>验证bookinfo服务是否启动完成<a class=headerlink href=#bookinfo_2 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1># 查看pods和svc</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get pods</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>NAME<span class=w>                             </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>details-v1-677976f7dc-m7mgw<span class=w>      </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m32s
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>productpage-v1-f76db69c5-vqkjv<span class=w>   </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m32s
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>ratings-v1-7f66cd4c87-8b4q6<span class=w>      </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m33s
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>reviews-v1-77bcd5d4f5-nggcv<span class=w>      </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m33s
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>reviews-v2-7cdb7475fb-hz8km<span class=w>      </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m33s
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>reviews-v3-8496dbbbbf-rzwb6<span class=w>      </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m33s
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get svc</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>NAME<span class=w>          </span>TYPE<span class=w>        </span>CLUSTER-IP<span class=w>       </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>    </span>AGE
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>details<span class=w>       </span>ClusterIP<span class=w>   </span><span class=m>10</span>.102.51.14<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>9080</span>/TCP<span class=w>   </span>4m46s
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>kubernetes<span class=w>    </span>ClusterIP<span class=w>   </span><span class=m>10</span>.96.0.1<span class=w>        </span>&lt;none&gt;<span class=w>        </span><span class=m>443</span>/TCP<span class=w>    </span>57m
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>productpage<span class=w>   </span>ClusterIP<span class=w>   </span><span class=m>10</span>.102.140.244<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>9080</span>/TCP<span class=w>   </span>4m46s
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>ratings<span class=w>       </span>ClusterIP<span class=w>   </span><span class=m>10</span>.96.187.95<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>9080</span>/TCP<span class=w>   </span>4m46s
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>reviews<span class=w>       </span>ClusterIP<span class=w>   </span><span class=m>10</span>.98.206.234<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>9080</span>/TCP<span class=w>   </span>4m46s
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=c1># 检查一下pod，看istio的sidecar自动注入是否成功</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>kubectl<span class=w> </span>describe<span class=w> </span>pods<span class=w> </span>details-v1-677976f7dc-m7mgw
<a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a>
<a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=c1># 要确认 Bookinfo 应用程序正在运行，请通过某个 pod 中的 curl 命令向其发送请求，例如来自 ratings：</span>
<a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath=&#39;{.items[0].metadata.name}&#39;) -c ratings -- curl productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span>
<a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a>&lt;title&gt;Simple<span class=w> </span>Bookstore<span class=w> </span>App&lt;/title&gt;
</code></pre></div> <h4 id=ingress-ip>确定 Ingress 的 IP 和端口<a class=headerlink href=#ingress-ip title="Permanent link">&para;</a></h4> <p>现在 Bookinfo 服务启动并运行中，你需要使应用程序可以从外部访问 Kubernetes 集群，例如使用浏览器。一个 <a href=https://istio.io/zh/docs/concepts/traffic-management/#gateway>Istio Gateway</a>应用到了目标中。</p> <ul> <li>为应用程序定义入口网关：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>gateway.networking.istio.io/bookinfo-gateway<span class=w> </span>created
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>virtualservice.networking.istio.io/bookinfo<span class=w> </span>created
</code></pre></div> <ul> <li>确认网关创建完成：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get gateway</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>NAME<span class=w>               </span>AGE
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>bookinfo-gateway<span class=w>   </span>28s
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservice</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>NAME<span class=w>       </span>GATEWAYS<span class=w>             </span>HOSTS<span class=w>   </span>AGE
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>bookinfo<span class=w>   </span><span class=o>[</span>bookinfo-gateway<span class=o>]</span><span class=w>   </span><span class=o>[</span>*<span class=o>]</span><span class=w>     </span>37s
</code></pre></div> <ul> <li>根据<a href=https://istio.io/zh/docs/tasks/traffic-management/ingress/#使用外部负载均衡器时确定-ip-和端口>文档</a>设置访问网关的 <code>INGRESS_HOST</code> 和 <code>INGRESS_PORT</code> 变量。确认并设置。</li> </ul> <p>启动 <a href=https://github.com/istio/istio/tree/release-1.2/samples/httpbin>httpbin</a> 样本，该样本将用作要在外部公开的目标服务。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f &lt;(istioctl kube-inject -f samples/httpbin/httpbin.yaml)</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>service/httpbin<span class=w> </span>created
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>deployment.extensions/httpbin<span class=w> </span>created
</code></pre></div> <p>确定入口 IP 和端口</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get svc istio-ingressgateway -n istio-system</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>NAME<span class=w>                   </span>TYPE<span class=w>       </span>CLUSTER-IP<span class=w>     </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>                                                                                                                                      </span>AGE
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>istio-ingressgateway<span class=w>   </span>NodePort<span class=w>   </span><span class=m>10</span>.108.162.3<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>15020</span>:31931/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32205/TCP,15030:31540/TCP,15031:30722/TCP,15032:32366/TCP,15443:31319/TCP<span class=w>   </span>36m
</code></pre></div> <p>如果 <code>EXTERNAL-IP</code> 有值（IP 地址或主机名），则说明您的环境具有可用于 Ingress 网关的外部负载均衡器。如果 <code>EXTERNAL-IP</code> 值是 <code>&lt;none&gt;</code>（或一直是 <code>&lt;pending&gt;</code> ），则说明可能您的环境并没有为 Ingress 网关提供外部负载均衡器的功能。在这种情况下，您可以使用 Service 的 <a href=https://kubernetes.io/docs/concepts/services-networking/service/#nodeport>node port</a> 方式访问网关。</p> <h4 id=node-port-ingress-ip>确定使用 Node Port 时的 ingress IP 和端口<a class=headerlink href=#node-port-ingress-ip title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=nb>export</span><span class=w> </span><span class=nv>INGRESS_PORT</span><span class=o>=</span><span class=k>$(</span>kubectl<span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span>get<span class=w> </span>service<span class=w> </span>istio-ingressgateway<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class=k>)</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=nb>export</span><span class=w> </span><span class=nv>SECURE_INGRESS_PORT</span><span class=o>=</span><span class=k>$(</span>kubectl<span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span>get<span class=w> </span>service<span class=w> </span>istio-ingressgateway<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class=k>)</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=nb>export</span><span class=w> </span><span class=nv>INGRESS_HOST</span><span class=o>=</span><span class=k>$(</span>minikube<span class=w> </span>ip<span class=k>)</span>
</code></pre></div> <ul> <li>设置 <code>GATEWAY_URL</code>：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># echo $GATEWAY_URL</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=m>172</span>.16.0.2:31380
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=c1># 确认应用</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># curl -s http://${GATEWAY_URL}/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>&lt;title&gt;Simple<span class=w> </span>Bookstore<span class=w> </span>App&lt;/title&gt;
</code></pre></div> <h4 id=istio_1>istio 功能测试(流量管理)<a class=headerlink href=#istio_1 title="Permanent link">&para;</a></h4> <p>由于demo环境为腾讯云CVM，使用公网IP进行访问</p> <h5 id=_8><img alt=image-20190805172532752 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805172532752.png"><img alt=image-20190805172543950 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805172543950.png"><img alt=image-20190805172553721 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805172553721.png">请求路由<a class=headerlink href=#_8 title="Permanent link">&para;</a></h5> <h6 id=_9>应用缺省目标规则<a class=headerlink href=#_9 title="Permanent link">&para;</a></h6> <p>在使用 Istio 控制 Bookinfo 版本路由之前，你需要在目标规则中定义好可用的版本，命名为 <em>subsets</em> 。</p> <p>运行以下命令为 Bookinfo 服务创建的默认的目标规则：</p> <p>如果不需要启用双向TLS，请执行以下命令：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>destinationrule.networking.istio.io/productpage<span class=w> </span>created
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>destinationrule.networking.istio.io/reviews<span class=w> </span>created
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>destinationrule.networking.istio.io/ratings<span class=w> </span>created
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>destinationrule.networking.istio.io/details<span class=w> </span>created
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=c1># 查看目标规则</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get destinationrules -o yaml</span>
</code></pre></div> <h5 id=_10><a class=headerlink href=#_10 title="Permanent link">&para;</a></h5> <p>Istio <a href=https://istio.io/zh/docs/examples/bookinfo/ >Bookinfo</a> 示例包含四个独立的微服务，每个微服务都有多个版本。 其中一个微服务 <code>reviews</code> 的三个不同版本已经部署并同时运行。 为了说明这导致的问题，在浏览器中访问 Bookinfo 应用程序的 <code>/productpage</code> 并刷新几次。 您会注意到，有时书评的输出包含星级评分，有时则不包含。 这是因为没有明确的默认服务版本路由，Istio 将以循环方式请求路由到所有可用版本。</p> <p>此任务的最初目标是应用将所有流量路由到微服务的 <code>v1</code> 版本的规则。稍后， 您将应用规则根据 HTTP 请求 header 的值路由流量。</p> <p>应用 virtual service</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>virtualservice.networking.istio.io/productpage<span class=w> </span>created
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>virtualservice.networking.istio.io/reviews<span class=w> </span>created
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>virtualservice.networking.istio.io/ratings<span class=w> </span>created
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>virtualservice.networking.istio.io/details<span class=w> </span>created
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservices</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>NAME<span class=w>          </span>GATEWAYS<span class=w>             </span>HOSTS<span class=w>           </span>AGE
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>bookinfo<span class=w>      </span><span class=o>[</span>bookinfo-gateway<span class=o>]</span><span class=w>   </span><span class=o>[</span>*<span class=o>]</span><span class=w>             </span>54m
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>details<span class=w>                            </span><span class=o>[</span>details<span class=o>]</span><span class=w>       </span>44s
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>productpage<span class=w>                        </span><span class=o>[</span>productpage<span class=o>]</span><span class=w>   </span>44s
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>ratings<span class=w>                            </span><span class=o>[</span>ratings<span class=o>]</span><span class=w>       </span>44s
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a>reviews<span class=w>                            </span><span class=o>[</span>reviews<span class=o>]</span><span class=w>       </span>44s
<a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a>
<a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get destinationrules</span>
<a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a>NAME<span class=w>          </span>HOST<span class=w>          </span>AGE
<a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a>details<span class=w>       </span>details<span class=w>       </span>21m
<a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a>productpage<span class=w>   </span>productpage<span class=w>   </span>21m
<a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a>ratings<span class=w>       </span>ratings<span class=w>       </span>21m
<a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a>reviews<span class=w>       </span>reviews<span class=w>       </span>21m
</code></pre></div> <p>请注意，无论您刷新多少次，页面的评论部分都不会显示评级星标。这是因为您将 Istio 配置为将评论服务的所有流量路由到版本 <code>reviews:v1</code>，并且此版本的服务不访问星级评分服务。</p> <p><img alt=image-20190805175037187 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805175037187.png"></p> <p>测试将流量路由到下一个服务</p> <h6 id=_11>基于用户身份的路由<a class=headerlink href=#_11 title="Permanent link">&para;</a></h6> <p>接下来，您将更改路由配置，以便将来自特定用户的所有流量路由到特定服务版本。在这种情况下，来自名为 Jason 的用户的所有流量将被路由到服务 <code>reviews:v2</code>。</p> <p>请注意，Istio 对用户身份没有任何特殊的内置机制。这个例子的基础在于， <code>productpage</code> 服务在所有针对 <code>reviews</code> 服务的调用请求中 都加自定义的 HTTP header，从而达到在流量中对最终用户身份识别的这一效果。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1>#运行以下命令以启用基于用户的路由</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</span>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>virtualservice.networking.istio.io/reviews<span class=w> </span>configured
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservice reviews -o yaml</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>kind:<span class=w> </span>VirtualService
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>metadata:
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=w>  </span>annotations:
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=w>    </span>kubectl.kubernetes.io/last-applied-configuration:<span class=w> </span><span class=p>|</span>
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=w>      </span><span class=o>{</span><span class=s2>&quot;apiVersion&quot;</span>:<span class=s2>&quot;networking.istio.io/v1alpha3&quot;</span>,<span class=s2>&quot;kind&quot;</span>:<span class=s2>&quot;VirtualService&quot;</span>,<span class=s2>&quot;metadata&quot;</span>:<span class=o>{</span><span class=s2>&quot;annotations&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;namespace&quot;</span>:<span class=s2>&quot;default&quot;</span><span class=o>}</span>,<span class=s2>&quot;spec&quot;</span>:<span class=o>{</span><span class=s2>&quot;hosts&quot;</span>:<span class=o>[</span><span class=s2>&quot;reviews&quot;</span><span class=o>]</span>,<span class=s2>&quot;http&quot;</span>:<span class=o>[{</span><span class=s2>&quot;match&quot;</span>:<span class=o>[{</span><span class=s2>&quot;headers&quot;</span>:<span class=o>{</span><span class=s2>&quot;end-user&quot;</span>:<span class=o>{</span><span class=s2>&quot;exact&quot;</span>:<span class=s2>&quot;jason&quot;</span><span class=o>}}}]</span>,<span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v2&quot;</span><span class=o>}}]}</span>,<span class=o>{</span><span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v1&quot;</span><span class=o>}}]}]}}</span>
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=w>  </span>creationTimestamp:<span class=w> </span><span class=s2>&quot;2019-08-05T09:48:04Z&quot;</span>
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=w>  </span>generation:<span class=w> </span><span class=m>2</span>
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=w>  </span>name:<span class=w> </span>reviews
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=w>  </span>namespace:<span class=w> </span>default
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=w>  </span>resourceVersion:<span class=w> </span><span class=s2>&quot;10861&quot;</span>
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=w>  </span>selfLink:<span class=w> </span>/apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/reviews
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=w>  </span>uid:<span class=w> </span>f7c51bdf-0023-4520-ba1b-4d38ad65212e
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a>spec:
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=w>  </span>hosts:
<a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=w>  </span>-<span class=w> </span>reviews
<a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=w>  </span>http:
<a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a><span class=w>  </span>-<span class=w> </span>match:
<a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=w>    </span>-<span class=w> </span>headers:
<a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=w>        </span>end-user:
<a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a><span class=w>          </span>exact:<span class=w> </span>jason
<a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=w>    </span>route:
<a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=w>        </span>host:<span class=w> </span>reviews
<a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a><span class=w>        </span>subset:<span class=w> </span>v2
<a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a><span class=w>  </span>-<span class=w> </span>route:
<a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-18-32 name=__codelineno-18-32 href=#__codelineno-18-32></a><span class=w>        </span>host:<span class=w> </span>reviews
<a id=__codelineno-18-33 name=__codelineno-18-33 href=#__codelineno-18-33></a><span class=w>        </span>subset:<span class=w> </span>v1
</code></pre></div> <p>在 Bookinfo 应用程序的 <code>/productpage</code> 上，以用户 <code>jason</code> 身份登录。</p> <p><img alt=image-20190805175449249 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805175449249.png"></p> <p>以其他用户身份登录（选择您想要的任何名称），刷新浏览器。现在星星消失了。这是因为除了 Jason 之外，所有用户的流量都被路由到 <code>reviews:v1</code>。</p> <ul> <li><code>productpage</code> → <code>reviews:v2</code> → <code>ratings</code> (<code>jason</code> 用户)</li> <li><code>productpage</code> → <code>reviews:v1</code> (其他用户)</li> </ul> <h6 id=_12>原理<a class=headerlink href=#_12 title="Permanent link">&para;</a></h6> <p>在此任务中，您首先使用 Istio 将 100% 的请求流量都路由到了 Bookinfo 服务的 v1 版本。 然后再设置了一条路由规则，在 <code>productpage</code> 服务中添加了路由规则，这一规则根据请求的 <code>end-user</code> 自定义 header 内容，选择性地将特定的流量路由到了 <code>reviews</code> 服务的 <code>v2</code> 版本。</p> <p>请注意，为了利用 Istio 的 L7 路由功能，Kubernetes 中的服务（如本任务中使用的 Bookinfo 服务）必须遵守某些特定限制。 参考 <a href=https://istio.io/zh/docs/setup/kubernetes/additional-setup/requirements>sidecar 注入文档</a>了解详情。</p> <p>在<a href=https://istio.io/zh/docs/tasks/traffic-management/traffic-shifting>流量转移</a>任务中，您将按照在此处学习的相同基本模式来配置路由规则，以逐步将流量从服务的一个版本发送到另一个版本。</p> <h6 id=_13>清理<a class=headerlink href=#_13 title="Permanent link">&para;</a></h6> <p>如果不操作后续实验，可以进行清理</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div> <h5 id=_14>故障注入<a class=headerlink href=#_14 title="Permanent link">&para;</a></h5> <h6 id=http>使用 HTTP 延迟进行故障注入<a class=headerlink href=#http title="Permanent link">&para;</a></h6> <p>为了测试微服务应用程序 Bookinfo 的弹性，我们将为用户 <code>jason</code> 在 <code>reviews:v2</code> 和 <code>ratings</code> 服务之间注入一个 7 秒的延迟。 这个测试将会发现故意引入 Bookinfo 应用程序中的错误。</p> <p>由于 <code>reviews:v2</code> 服务对其 ratings 服务的调用具有 10 秒的硬编码连接超时，比我们设置的 7s 延迟要大，因此我们期望端到端流程是正常的（没有任何错误）。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>virtualservice.networking.istio.io/ratings<span class=w> </span>configured
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservices</span>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>NAME<span class=w>          </span>GATEWAYS<span class=w>             </span>HOSTS<span class=w>           </span>AGE
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>bookinfo<span class=w>      </span><span class=o>[</span>bookinfo-gateway<span class=o>]</span><span class=w>   </span><span class=o>[</span>*<span class=o>]</span><span class=w>             </span>70m
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>details<span class=w>                            </span><span class=o>[</span>details<span class=o>]</span><span class=w>       </span>17m
<a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>productpage<span class=w>                        </span><span class=o>[</span>productpage<span class=o>]</span><span class=w>   </span>17m
<a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>ratings<span class=w>                            </span><span class=o>[</span>ratings<span class=o>]</span><span class=w>       </span>17m
<a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>reviews<span class=w>                            </span><span class=o>[</span>reviews<span class=o>]</span><span class=w>       </span>17m
<a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservices ratings -o yaml</span>
<a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>kind:<span class=w> </span>VirtualService
<a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a>metadata:
<a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=w>  </span>annotations:
<a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=w>    </span>kubectl.kubernetes.io/last-applied-configuration:<span class=w> </span><span class=p>|</span>
<a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=w>      </span><span class=o>{</span><span class=s2>&quot;apiVersion&quot;</span>:<span class=s2>&quot;networking.istio.io/v1alpha3&quot;</span>,<span class=s2>&quot;kind&quot;</span>:<span class=s2>&quot;VirtualService&quot;</span>,<span class=s2>&quot;metadata&quot;</span>:<span class=o>{</span><span class=s2>&quot;annotations&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;ratings&quot;</span>,<span class=s2>&quot;namespace&quot;</span>:<span class=s2>&quot;default&quot;</span><span class=o>}</span>,<span class=s2>&quot;spec&quot;</span>:<span class=o>{</span><span class=s2>&quot;hosts&quot;</span>:<span class=o>[</span><span class=s2>&quot;ratings&quot;</span><span class=o>]</span>,<span class=s2>&quot;http&quot;</span>:<span class=o>[{</span><span class=s2>&quot;fault&quot;</span>:<span class=o>{</span><span class=s2>&quot;delay&quot;</span>:<span class=o>{</span><span class=s2>&quot;fixedDelay&quot;</span>:<span class=s2>&quot;7s&quot;</span>,<span class=s2>&quot;percentage&quot;</span>:<span class=o>{</span><span class=s2>&quot;value&quot;</span>:100<span class=o>}}}</span>,<span class=s2>&quot;match&quot;</span>:<span class=o>[{</span><span class=s2>&quot;headers&quot;</span>:<span class=o>{</span><span class=s2>&quot;end-user&quot;</span>:<span class=o>{</span><span class=s2>&quot;exact&quot;</span>:<span class=s2>&quot;jason&quot;</span><span class=o>}}}]</span>,<span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;ratings&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v1&quot;</span><span class=o>}}]}</span>,<span class=o>{</span><span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;ratings&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v1&quot;</span><span class=o>}}]}]}}</span>
<a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=w>  </span>creationTimestamp:<span class=w> </span><span class=s2>&quot;2019-08-05T09:48:04Z&quot;</span>
<a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=w>  </span>generation:<span class=w> </span><span class=m>2</span>
<a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=w>  </span>name:<span class=w> </span>ratings
<a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a><span class=w>  </span>namespace:<span class=w> </span>default
<a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=w>  </span>resourceVersion:<span class=w> </span><span class=s2>&quot;11757&quot;</span>
<a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a><span class=w>  </span>selfLink:<span class=w> </span>/apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/ratings
<a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a><span class=w>  </span>uid:<span class=w> </span>212f39f7-9797-4ec0-99d9-f4ed7df7beb6
<a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a>spec:
<a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=w>  </span>hosts:
<a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a><span class=w>  </span>-<span class=w> </span>ratings
<a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=w>  </span>http:
<a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a><span class=w>  </span>-<span class=w> </span>fault:
<a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=w>      </span>delay:
<a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=w>        </span>fixedDelay:<span class=w> </span>7s
<a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a><span class=w>        </span>percentage:
<a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a><span class=w>          </span>value:<span class=w> </span><span class=m>100</span>
<a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=w>    </span>match:
<a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a><span class=w>    </span>-<span class=w> </span>headers:
<a id=__codelineno-20-35 name=__codelineno-20-35 href=#__codelineno-20-35></a><span class=w>        </span>end-user:
<a id=__codelineno-20-36 name=__codelineno-20-36 href=#__codelineno-20-36></a><span class=w>          </span>exact:<span class=w> </span>jason
<a id=__codelineno-20-37 name=__codelineno-20-37 href=#__codelineno-20-37></a><span class=w>    </span>route:
<a id=__codelineno-20-38 name=__codelineno-20-38 href=#__codelineno-20-38></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-20-39 name=__codelineno-20-39 href=#__codelineno-20-39></a><span class=w>        </span>host:<span class=w> </span>ratings
<a id=__codelineno-20-40 name=__codelineno-20-40 href=#__codelineno-20-40></a><span class=w>        </span>subset:<span class=w> </span>v1
<a id=__codelineno-20-41 name=__codelineno-20-41 href=#__codelineno-20-41></a><span class=w>  </span>-<span class=w> </span>route:
<a id=__codelineno-20-42 name=__codelineno-20-42 href=#__codelineno-20-42></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-20-43 name=__codelineno-20-43 href=#__codelineno-20-43></a><span class=w>        </span>host:<span class=w> </span>ratings
<a id=__codelineno-20-44 name=__codelineno-20-44 href=#__codelineno-20-44></a><span class=w>        </span>subset:<span class=w> </span>v1
</code></pre></div> <p>使用用户 <code>jason</code> 登陆到 <code>/productpage</code> 界面。你期望 Bookinfo 主页在大约 7 秒钟加载完成并且没有错误。但是，出现了一个问题，Reviews 部分显示了错误消息：</p> <p><img alt=image-20190805180735189 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805180735189.png"></p> <h6 id=_15>原理<a class=headerlink href=#_15 title="Permanent link">&para;</a></h6> <p>你发现了一个 bug。在微服务中有硬编码超时，导致 <code>reviews</code> 服务失败。</p> <p>在 <code>productpage</code> 和 <code>reviews</code> 服务之间超时时间是 6s - 编码 3s + 1 次重试总共 6s ，<code>reviews</code> 和 <code>ratings</code> 服务之间的硬编码连接超时为 10s 。由于我们引入的延时，<code>/productpage</code> 提前超时并引发错误。</p> <p>这些类型的错误可能发生在典型的企业应用程序中，其中不同的团队独立地开发不同的微服务。Istio 的故障注入规则可帮助您识别此类异常，而不会影响最终用户。</p> <h6 id=_16>错误修复<a class=headerlink href=#_16 title="Permanent link">&para;</a></h6> <p>你通常会解决这样的问题：</p> <ol> <li>要么增加 <code>/productpage</code> 的超时或者减少 <code>reviews</code> 到 <code>ratings</code> 服务的超时</li> <li>终止并重启微服务</li> <li>确认 <code>productpage</code> 正常响应并且没有任何错误。</li> </ol> <p>但是，我们已经在 <code>reviews</code> 服务的 v3 版中运行此修复程序，因此我们可以通过将所有流量迁移到 <code>reviews:v3</code> 来解决问题， 如<a href=https://istio.io/zh/docs/tasks/traffic-management/traffic-shifting/ >流量转移</a>中所述任务。</p> <h6 id=http-abort>使用 HTTP abort 进行故障注入<a class=headerlink href=#http-abort title="Permanent link">&para;</a></h6> <p>测试微服务弹性的另一种方法是引入 HTTP abort 故障。在这个任务中，在 <code>ratings</code> 微服务中引入 HTTP abort ，测试用户为 <code>jason</code> 。</p> <p>在这个案例中，我们希望页面能够立即加载，同时显示 <code>Ratings service is currently unavailable</code> 这样的消息。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>virtualservice.networking.istio.io/ratings<span class=w> </span>configured
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservice ratings -o yaml</span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>kind:<span class=w> </span>VirtualService
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>metadata:
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>  </span>annotations:
<a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=w>    </span>kubectl.kubernetes.io/last-applied-configuration:<span class=w> </span><span class=p>|</span>
<a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=w>      </span><span class=o>{</span><span class=s2>&quot;apiVersion&quot;</span>:<span class=s2>&quot;networking.istio.io/v1alpha3&quot;</span>,<span class=s2>&quot;kind&quot;</span>:<span class=s2>&quot;VirtualService&quot;</span>,<span class=s2>&quot;metadata&quot;</span>:<span class=o>{</span><span class=s2>&quot;annotations&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;ratings&quot;</span>,<span class=s2>&quot;namespace&quot;</span>:<span class=s2>&quot;default&quot;</span><span class=o>}</span>,<span class=s2>&quot;spec&quot;</span>:<span class=o>{</span><span class=s2>&quot;hosts&quot;</span>:<span class=o>[</span><span class=s2>&quot;ratings&quot;</span><span class=o>]</span>,<span class=s2>&quot;http&quot;</span>:<span class=o>[{</span><span class=s2>&quot;fault&quot;</span>:<span class=o>{</span><span class=s2>&quot;abort&quot;</span>:<span class=o>{</span><span class=s2>&quot;httpStatus&quot;</span>:500,<span class=s2>&quot;percentage&quot;</span>:<span class=o>{</span><span class=s2>&quot;value&quot;</span>:100<span class=o>}}}</span>,<span class=s2>&quot;match&quot;</span>:<span class=o>[{</span><span class=s2>&quot;headers&quot;</span>:<span class=o>{</span><span class=s2>&quot;end-user&quot;</span>:<span class=o>{</span><span class=s2>&quot;exact&quot;</span>:<span class=s2>&quot;jason&quot;</span><span class=o>}}}]</span>,<span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;ratings&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v1&quot;</span><span class=o>}}]}</span>,<span class=o>{</span><span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;ratings&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v1&quot;</span><span class=o>}}]}]}}</span>
<a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=w>  </span>creationTimestamp:<span class=w> </span><span class=s2>&quot;2019-08-05T09:48:04Z&quot;</span>
<a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=w>  </span>generation:<span class=w> </span><span class=m>3</span>
<a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=w>  </span>name:<span class=w> </span>ratings
<a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=w>  </span>namespace:<span class=w> </span>default
<a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=w>  </span>resourceVersion:<span class=w> </span><span class=s2>&quot;12538&quot;</span>
<a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>  </span>selfLink:<span class=w> </span>/apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/ratings
<a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>  </span>uid:<span class=w> </span>212f39f7-9797-4ec0-99d9-f4ed7df7beb6
<a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>spec:
<a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=w>  </span>hosts:
<a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=w>  </span>-<span class=w> </span>ratings
<a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=w>  </span>http:
<a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=w>  </span>-<span class=w> </span>fault:
<a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=w>      </span>abort:
<a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a><span class=w>        </span>httpStatus:<span class=w> </span><span class=m>500</span>
<a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a><span class=w>        </span>percentage:
<a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a><span class=w>          </span>value:<span class=w> </span><span class=m>100</span>
<a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a><span class=w>    </span>match:
<a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a><span class=w>    </span>-<span class=w> </span>headers:
<a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a><span class=w>        </span>end-user:
<a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a><span class=w>          </span>exact:<span class=w> </span>jason
<a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a><span class=w>    </span>route:
<a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a><span class=w>        </span>host:<span class=w> </span>ratings
<a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a><span class=w>        </span>subset:<span class=w> </span>v1
<a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a><span class=w>  </span>-<span class=w> </span>route:
<a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a><span class=w>        </span>host:<span class=w> </span>ratings
<a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a><span class=w>        </span>subset:<span class=w> </span>v1
</code></pre></div> <p>使用用户 <code>jason</code> 登陆到 <code>/productpage</code> 界面。</p> <p><img alt=image-20190805181756521 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190805181756521.png"></p> <h6 id=_17>清理<a class=headerlink href=#_17 title="Permanent link">&para;</a></h6> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div> <h5 id=_18>流量迁移<a class=headerlink href=#_18 title="Permanent link">&para;</a></h5> <p>一个常见的用例是将流量从一个版本的微服务逐渐迁移到另一个版本。在 Istio 中，您可以通过配置一系列规则来实现此目标，这些规则将一定百分比的流量路由到一个或另一个服务。在此任务中，您将 50％ 的流量发送到 <code>reviews:v1</code>，另外 50％ 的流量发送到 <code>reviews:v3</code>。然后将 100％ 的流量发送到 <code>reviews:v3</code> 来完成迁移。</p> <h6 id=_19>应用基于权重的路由<a class=headerlink href=#_19 title="Permanent link">&para;</a></h6> <ol> <li>将所有流量路由到 <code>v1</code> 版本的各个微服务。</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span>
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>virtualservice.networking.istio.io/productpage<span class=w> </span>unchanged
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>virtualservice.networking.istio.io/reviews<span class=w> </span>configured
<a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>virtualservice.networking.istio.io/ratings<span class=w> </span>configured
<a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>virtualservice.networking.istio.io/details<span class=w> </span>unchanged
</code></pre></div> <p>请注意，不管刷新多少次，页面的评论部分都不会显示评级星号。这是因为 Istio 被配置为将 reviews 服务的的所有流量都路由到了 <code>reviews:v1</code> 版本， 而该版本的服务不会访问带星级的 ratings 服务。</p> <ol> <li>把 50% 的流量从 <code>reviews:v1</code> 转移到 <code>reviews:v3</code>：</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>virtualservice.networking.istio.io/reviews<span class=w> </span>configured
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservice reviews -o yaml</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>kind:<span class=w> </span>VirtualService
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>metadata:
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>  </span>annotations:
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>    </span>kubectl.kubernetes.io/last-applied-configuration:<span class=w> </span><span class=p>|</span>
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>      </span><span class=o>{</span><span class=s2>&quot;apiVersion&quot;</span>:<span class=s2>&quot;networking.istio.io/v1alpha3&quot;</span>,<span class=s2>&quot;kind&quot;</span>:<span class=s2>&quot;VirtualService&quot;</span>,<span class=s2>&quot;metadata&quot;</span>:<span class=o>{</span><span class=s2>&quot;annotations&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;namespace&quot;</span>:<span class=s2>&quot;default&quot;</span><span class=o>}</span>,<span class=s2>&quot;spec&quot;</span>:<span class=o>{</span><span class=s2>&quot;hosts&quot;</span>:<span class=o>[</span><span class=s2>&quot;reviews&quot;</span><span class=o>]</span>,<span class=s2>&quot;http&quot;</span>:<span class=o>[{</span><span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v1&quot;</span><span class=o>}</span>,<span class=s2>&quot;weight&quot;</span>:50<span class=o>}</span>,<span class=o>{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v3&quot;</span><span class=o>}</span>,<span class=s2>&quot;weight&quot;</span>:50<span class=o>}]}]}}</span>
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>  </span>creationTimestamp:<span class=w> </span><span class=s2>&quot;2019-08-05T09:48:04Z&quot;</span>
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>  </span>generation:<span class=w> </span><span class=m>4</span>
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>  </span>name:<span class=w> </span>reviews
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>  </span>namespace:<span class=w> </span>default
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>  </span>resourceVersion:<span class=w> </span><span class=s2>&quot;13220&quot;</span>
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>  </span>selfLink:<span class=w> </span>/apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/reviews
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>  </span>uid:<span class=w> </span>f7c51bdf-0023-4520-ba1b-4d38ad65212e
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a>spec:
<a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=w>  </span>hosts:
<a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=w>  </span>-<span class=w> </span>reviews
<a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=w>  </span>http:
<a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=w>  </span>-<span class=w> </span>route:
<a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=w>        </span>host:<span class=w> </span>reviews
<a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a><span class=w>        </span>subset:<span class=w> </span>v1
<a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a><span class=w>      </span>weight:<span class=w> </span><span class=m>50</span>
<a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a><span class=w>        </span>host:<span class=w> </span>reviews
<a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a><span class=w>        </span>subset:<span class=w> </span>v3
<a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a><span class=w>      </span>weight:<span class=w> </span><span class=m>50</span>
</code></pre></div> <p>刷新浏览器中的 <code>/productpage</code> 页面，大约有 50% 的几率会看到页面中出带红色星级的评价内容。这是因为 <code>v3</code> 版本的 <code>reviews</code>访问了带星级评级的 <code>ratings</code> 服务，但 <code>v1</code> 版本却没有。</p> <ol> <li>如果您认为 <code>reviews:v3</code> 微服务已经稳定，你可以通过应用此 virtual service 将 100% 的流量路由到 <code>reviews:v3</code></li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>virtualservice.networking.istio.io/reviews<span class=w> </span>configured
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservice reviews -o yaml</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a>kind:<span class=w> </span>VirtualService
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a>metadata:
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>  </span>annotations:
<a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>    </span>kubectl.kubernetes.io/last-applied-configuration:<span class=w> </span><span class=p>|</span>
<a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=w>      </span><span class=o>{</span><span class=s2>&quot;apiVersion&quot;</span>:<span class=s2>&quot;networking.istio.io/v1alpha3&quot;</span>,<span class=s2>&quot;kind&quot;</span>:<span class=s2>&quot;VirtualService&quot;</span>,<span class=s2>&quot;metadata&quot;</span>:<span class=o>{</span><span class=s2>&quot;annotations&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;namespace&quot;</span>:<span class=s2>&quot;default&quot;</span><span class=o>}</span>,<span class=s2>&quot;spec&quot;</span>:<span class=o>{</span><span class=s2>&quot;hosts&quot;</span>:<span class=o>[</span><span class=s2>&quot;reviews&quot;</span><span class=o>]</span>,<span class=s2>&quot;http&quot;</span>:<span class=o>[{</span><span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;reviews&quot;</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v3&quot;</span><span class=o>}}]}]}}</span>
<a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>  </span>creationTimestamp:<span class=w> </span><span class=s2>&quot;2019-08-05T09:48:04Z&quot;</span>
<a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>  </span>generation:<span class=w> </span><span class=m>5</span>
<a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>  </span>name:<span class=w> </span>reviews
<a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>  </span>namespace:<span class=w> </span>default
<a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=w>  </span>resourceVersion:<span class=w> </span><span class=s2>&quot;13348&quot;</span>
<a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a><span class=w>  </span>selfLink:<span class=w> </span>/apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/reviews
<a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=w>  </span>uid:<span class=w> </span>f7c51bdf-0023-4520-ba1b-4d38ad65212e
<a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a>spec:
<a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=w>  </span>hosts:
<a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=w>  </span>-<span class=w> </span>reviews
<a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a><span class=w>  </span>http:
<a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=w>  </span>-<span class=w> </span>route:
<a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=w>        </span>host:<span class=w> </span>reviews
<a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=w>        </span>subset:<span class=w> </span>v3
</code></pre></div> <p>刷新 <code>/productpage</code> 时，您将始终看到带有红色星级评分的书评。</p> <p>在这项任务中，我们使用 Istio 的加权路由功能将流量从旧版本的 <code>reviews</code> 服务迁移到新版本。请注意，这和使用容器编排平台的部署功能来进行版本迁移完全不同，后者使用了实例扩容来对流量进行管理。</p> <p>使用 Istio，两个版本的 <code>reviews</code> 服务可以独立地进行扩容和缩容，并不会影响这两个版本服务之间的流量分发。</p> <p>如果想了解支持自动伸缩的版本路由的更多信息，请查看<a href=https://istio.io/blog/2017/0.1-canary/ >使用 Istio 的 Canary Deployments</a> 。</p> <h6 id=_20>清理<a class=headerlink href=#_20 title="Permanent link">&para;</a></h6> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div> <h5 id=tcp>TCP流量转移<a class=headerlink href=#tcp title="Permanent link">&para;</a></h5> <h6 id=tcp_1>应用基于权重的 TCP 路由<a class=headerlink href=#tcp_1 title="Permanent link">&para;</a></h6> <ul> <li>第一个步骤是部署 <code>tcp-echo</code> 微服务的 <code>v1</code> 版本。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f &lt;(istioctl kube-inject -f samples/tcp-echo/tcp-echo-services.yaml)</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>service/tcp-echo<span class=w> </span>created
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get all |grep tcp-echo</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>pod/tcp-echo-v1-55d4546c49-tnvb2<span class=w>     </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>32s
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>pod/tcp-echo-v2-c8566b665-4jp47<span class=w>      </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>32s
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>service/tcp-echo<span class=w>      </span>ClusterIP<span class=w>   </span><span class=m>10</span>.111.220.32<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>9000</span>/TCP<span class=w>   </span>34s
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a>deployment.apps/tcp-echo-v1<span class=w>      </span><span class=m>1</span>/1<span class=w>     </span><span class=m>1</span><span class=w>            </span><span class=m>1</span><span class=w>           </span>34s
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a>deployment.apps/tcp-echo-v2<span class=w>      </span><span class=m>1</span>/1<span class=w>     </span><span class=m>1</span><span class=w>            </span><span class=m>1</span><span class=w>           </span>33s
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>replicaset.apps/tcp-echo-v1-55d4546c49<span class=w>     </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>       </span>33s
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a>replicaset.apps/tcp-echo-v2-c8566b665<span class=w>      </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>       </span>33s
</code></pre></div> <ul> <li>下一步，把所有目标是 <code>tcp-echo</code> 微服务的 TCP 流量路由到 <code>v1</code> 版本</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/tcp-echo/tcp-echo-all-v1.yaml</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>gateway.networking.istio.io/tcp-echo-gateway<span class=w> </span>created
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>destinationrule.networking.istio.io/tcp-echo-destination<span class=w> </span>created
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>virtualservice.networking.istio.io/tcp-echo<span class=w> </span>created
</code></pre></div> <ul> <li>确认 <code>tcp-echo</code> 服务已经启动并开始运行</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].port}&#39;)</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># echo $INGRESS_PORT</span>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=m>31400</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># export INGRESS_HOST=$(minikube ip)</span>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># echo $INGRESS_HOST</span>
<a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=m>172</span>.16.0.2
<a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>
<a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=c1># 向 tcp-echo 微服务发送一些 TCP 流量：</span>
<a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># for i in {1..10}; do \</span>
<a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>&gt;<span class=w> </span>docker<span class=w> </span>run<span class=w> </span>-e<span class=w> </span><span class=nv>INGRESS_HOST</span><span class=o>=</span><span class=nv>$INGRESS_HOST</span><span class=w> </span>-e<span class=w> </span><span class=nv>INGRESS_PORT</span><span class=o>=</span><span class=nv>$INGRESS_PORT</span><span class=w> </span>-it<span class=w> </span>--rm<span class=w> </span>busybox<span class=w> </span>sh<span class=w> </span>-c<span class=w> </span><span class=s2>&quot;(date; sleep 1) | nc </span><span class=nv>$INGRESS_HOST</span><span class=s2> </span><span class=nv>$INGRESS_PORT</span><span class=s2>&quot;</span><span class=p>;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>&gt;<span class=w> </span><span class=k>done</span>
<a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a>Unable<span class=w> </span>to<span class=w> </span>find<span class=w> </span>image<span class=w> </span><span class=s1>&#39;busybox:latest&#39;</span><span class=w> </span>locally
<a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>latest:<span class=w> </span>Pulling<span class=w> </span>from<span class=w> </span>library/busybox
<a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a>ee153a04d683:<span class=w> </span>Pull<span class=w> </span><span class=nb>complete</span>
<a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>Digest:<span class=w> </span>sha256:9f1003c480699be56815db0f8146ad2e22efea85129b5b5983d0e0fb52d9ab70
<a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a>Status:<span class=w> </span>Downloaded<span class=w> </span>newer<span class=w> </span>image<span class=w> </span><span class=k>for</span><span class=w> </span>busybox:latest
<a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:40:31<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:40:35<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:40:38<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:40:42<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
</code></pre></div> <p>不难发现，所有的时间戳都有一个 <code>one</code> 前缀，这代表所有访问 <code>tcp-echo</code> 服务的流量都被路由到了 <code>v1</code> 版本。</p> <ul> <li>用下面的命令把 20% 的流量从 <code>tcp-echo:v1</code> 转移到 <code>tcp-echo:v2</code>：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f samples/tcp-echo/tcp-echo-20-v2.yaml</span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>virtualservice.networking.istio.io/tcp-echo<span class=w> </span>configured
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get virtualservice tcp-echo -o yaml</span>
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a>kind:<span class=w> </span>VirtualService
<a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a>metadata:
<a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>  </span>annotations:
<a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=w>    </span>kubectl.kubernetes.io/last-applied-configuration:<span class=w> </span><span class=p>|</span>
<a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=w>      </span><span class=o>{</span><span class=s2>&quot;apiVersion&quot;</span>:<span class=s2>&quot;networking.istio.io/v1alpha3&quot;</span>,<span class=s2>&quot;kind&quot;</span>:<span class=s2>&quot;VirtualService&quot;</span>,<span class=s2>&quot;metadata&quot;</span>:<span class=o>{</span><span class=s2>&quot;annotations&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;tcp-echo&quot;</span>,<span class=s2>&quot;namespace&quot;</span>:<span class=s2>&quot;default&quot;</span><span class=o>}</span>,<span class=s2>&quot;spec&quot;</span>:<span class=o>{</span><span class=s2>&quot;gateways&quot;</span>:<span class=o>[</span><span class=s2>&quot;tcp-echo-gateway&quot;</span><span class=o>]</span>,<span class=s2>&quot;hosts&quot;</span>:<span class=o>[</span><span class=s2>&quot;*&quot;</span><span class=o>]</span>,<span class=s2>&quot;tcp&quot;</span>:<span class=o>[{</span><span class=s2>&quot;match&quot;</span>:<span class=o>[{</span><span class=s2>&quot;port&quot;</span>:31400<span class=o>}]</span>,<span class=s2>&quot;route&quot;</span>:<span class=o>[{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;tcp-echo&quot;</span>,<span class=s2>&quot;port&quot;</span>:<span class=o>{</span><span class=s2>&quot;number&quot;</span>:9000<span class=o>}</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v1&quot;</span><span class=o>}</span>,<span class=s2>&quot;weight&quot;</span>:80<span class=o>}</span>,<span class=o>{</span><span class=s2>&quot;destination&quot;</span>:<span class=o>{</span><span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;tcp-echo&quot;</span>,<span class=s2>&quot;port&quot;</span>:<span class=o>{</span><span class=s2>&quot;number&quot;</span>:9000<span class=o>}</span>,<span class=s2>&quot;subset&quot;</span>:<span class=s2>&quot;v2&quot;</span><span class=o>}</span>,<span class=s2>&quot;weight&quot;</span>:20<span class=o>}]}]}}</span>
<a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=w>  </span>creationTimestamp:<span class=w> </span><span class=s2>&quot;2019-08-06T06:01:54Z&quot;</span>
<a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>  </span>generation:<span class=w> </span><span class=m>2</span>
<a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=w>  </span>name:<span class=w> </span>tcp-echo
<a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>  </span>namespace:<span class=w> </span>default
<a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>  </span>resourceVersion:<span class=w> </span><span class=s2>&quot;112275&quot;</span>
<a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>  </span>selfLink:<span class=w> </span>/apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/tcp-echo
<a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=w>  </span>uid:<span class=w> </span>c03f8d6b-0967-45cf-8cf5-465d08634318
<a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a>spec:
<a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a><span class=w>  </span>gateways:
<a id=__codelineno-30-20 name=__codelineno-30-20 href=#__codelineno-30-20></a><span class=w>  </span>-<span class=w> </span>tcp-echo-gateway
<a id=__codelineno-30-21 name=__codelineno-30-21 href=#__codelineno-30-21></a><span class=w>  </span>hosts:
<a id=__codelineno-30-22 name=__codelineno-30-22 href=#__codelineno-30-22></a><span class=w>  </span>-<span class=w> </span><span class=s1>&#39;*&#39;</span>
<a id=__codelineno-30-23 name=__codelineno-30-23 href=#__codelineno-30-23></a><span class=w>  </span>tcp:
<a id=__codelineno-30-24 name=__codelineno-30-24 href=#__codelineno-30-24></a><span class=w>  </span>-<span class=w> </span>match:
<a id=__codelineno-30-25 name=__codelineno-30-25 href=#__codelineno-30-25></a><span class=w>    </span>-<span class=w> </span>port:<span class=w> </span><span class=m>31400</span>
<a id=__codelineno-30-26 name=__codelineno-30-26 href=#__codelineno-30-26></a><span class=w>    </span>route:
<a id=__codelineno-30-27 name=__codelineno-30-27 href=#__codelineno-30-27></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-30-28 name=__codelineno-30-28 href=#__codelineno-30-28></a><span class=w>        </span>host:<span class=w> </span>tcp-echo
<a id=__codelineno-30-29 name=__codelineno-30-29 href=#__codelineno-30-29></a><span class=w>        </span>port:
<a id=__codelineno-30-30 name=__codelineno-30-30 href=#__codelineno-30-30></a><span class=w>          </span>number:<span class=w> </span><span class=m>9000</span>
<a id=__codelineno-30-31 name=__codelineno-30-31 href=#__codelineno-30-31></a><span class=w>        </span>subset:<span class=w> </span>v1
<a id=__codelineno-30-32 name=__codelineno-30-32 href=#__codelineno-30-32></a><span class=w>      </span>weight:<span class=w> </span><span class=m>80</span>
<a id=__codelineno-30-33 name=__codelineno-30-33 href=#__codelineno-30-33></a><span class=w>    </span>-<span class=w> </span>destination:
<a id=__codelineno-30-34 name=__codelineno-30-34 href=#__codelineno-30-34></a><span class=w>        </span>host:<span class=w> </span>tcp-echo
<a id=__codelineno-30-35 name=__codelineno-30-35 href=#__codelineno-30-35></a><span class=w>        </span>port:
<a id=__codelineno-30-36 name=__codelineno-30-36 href=#__codelineno-30-36></a><span class=w>          </span>number:<span class=w> </span><span class=m>9000</span>
<a id=__codelineno-30-37 name=__codelineno-30-37 href=#__codelineno-30-37></a><span class=w>        </span>subset:<span class=w> </span>v2
<a id=__codelineno-30-38 name=__codelineno-30-38 href=#__codelineno-30-38></a><span class=w>      </span>weight:<span class=w> </span><span class=m>20</span>
</code></pre></div> <ul> <li>测试向 <code>tcp-echo</code> 微服务发送更多 TCP 流量：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># for i in {1..10}; do docker run -e INGRESS_HOST=$INGRESS_HOST -e INGRESS_PORT=$INGRESS_PORT -it --rm busybox sh -c &quot;(date; sleep 1) | nc $INGRESS_HOST $INGRESS_PORT&quot;; done</span>
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:23<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>two<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:27<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:29<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:31<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:33<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:35<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:37<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a>one<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:39<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a>two<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:41<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
<a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a>two<span class=w> </span>Tue<span class=w> </span>Aug<span class=w>  </span><span class=m>6</span><span class=w> </span><span class=m>08</span>:43:43<span class=w> </span>UTC<span class=w> </span><span class=m>2019</span>
</code></pre></div> <p>现在应该会看到，输出内容中有 20% 的时间戳前缀为 <code>two</code>，这意味着 80% 的流量被路由到 <code>tcp-echo:v1</code>，其余 20% 流量被路由到了 <code>v2</code>。</p> <p>这个任务里，用 Istio 的权重路由功能，把一部分访问 <code>tcp-echo</code> 服务的 TCP 流量被从旧版本迁移到了新版本。容器编排平台中的版本迁移使用的是对特定组别的实例进行伸缩来完成对流量的控制的，两种迁移方式显然大相径庭。</p> <p>在 Istio 中可以对两个版本的 <code>tcp-echo</code> 服务进行独立的扩缩容，伸缩过程中不会对流量的分配结果造成影响，可以阅读博客：<a href=https://istio.io/zh/blog/2017/0.1-canary/ >使用 Istio 进行金丝雀部署</a>，进一步了解相关内容。</p> <h6 id=_21>清理<a class=headerlink href=#_21 title="Permanent link">&para;</a></h6> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>samples/tcp-echo/tcp-echo-all-v1.yaml
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>samples/tcp-echo/tcp-echo-services.yaml
</code></pre></div> <h5 id=_22>设置超时时间<a class=headerlink href=#_22 title="Permanent link">&para;</a></h5> <p>初始化bookinfo</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div> <h6 id=_23>请求超时<a class=headerlink href=#_23 title="Permanent link">&para;</a></h6> <p>可以在<a href=https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#httproute>路由规则</a>的 <code>timeout</code> 字段中来给 http 请求设置请求超时。缺省情况下，超时被设置为 15 秒钟，本文任务中，会把 <code>reviews</code>服务的超时设置为一秒钟。为了能观察设置的效果，还需要在对 <code>ratings</code> 服务的调用中加入两秒钟的延迟。</p> <ul> <li>到 <code>reviews:v2</code> 服务的路由定义：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=s>metadata:</span>
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=s>  name: reviews</span>
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=s>spec:</span>
<a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=s>  hosts:</span>
<a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=s>    - reviews</span>
<a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=s>  http:</span>
<a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=s>  - route:</span>
<a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=s>    - destination:</span>
<a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=s>        host: reviews</span>
<a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=s>        subset: v2</span>
<a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>在对 <code>ratings</code> 服务的调用中加入两秒钟的延迟：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=s>metadata:</span>
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=s>  name: ratings</span>
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=s>spec:</span>
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=s>  hosts:</span>
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=s>  - ratings</span>
<a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=s>  http:</span>
<a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=s>  - fault:</span>
<a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=s>      delay:</span>
<a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=s>        percent: 100</span>
<a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=s>        fixedDelay: 2s</span>
<a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=s>    route:</span>
<a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=s>    - destination:</span>
<a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=s>        host: ratings</span>
<a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=s>        subset: v1</span>
<a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=s>EOF</span>
</code></pre></div> <ul> <li> <p><a href=http://106.52.172.132:31380/productpage,这时应该能看到>http://106.52.172.132:31380/productpage,这时应该能看到</a> Bookinfo 应用在正常运行（显示了评级的星形符号），但是每次刷新页面，都会出现两秒钟的延迟。</p> </li> <li> <p>接下来在目的为 <code>reviews:v2</code> 服务的请求加入一秒钟的请求超时：</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=s>metadata:</span>
<a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=s>  name: reviews</span>
<a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=s>spec:</span>
<a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=s>  hosts:</span>
<a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=s>  - reviews</span>
<a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=s>  http:</span>
<a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=s>  - route:</span>
<a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=s>    - destination:</span>
<a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=s>        host: reviews</span>
<a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=s>        subset: v2</span>
<a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=s>    timeout: 0.5s</span>
<a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>刷新 Bookinfo 的 Web 页面。</li> </ul> <p>这时候应该看到一秒钟就会返回，而不是之前的两秒钟，但 <code>reviews</code> 的显示已经不见了。</p> <p><img alt=image-20190806170132549 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190806170132549.png"></p> <h6 id=_24>原理<a class=headerlink href=#_24 title="Permanent link">&para;</a></h6> <p>上面的任务中，使用 Istio 为调用 <code>reviews</code> 微服务的请求中加入了一秒钟的超时控制，覆盖了缺省的 15 秒钟设置。页面刷新时，<code>reviews</code> 服务后面会调用 <code>ratings</code> 服务，使用 Istio 在对 <code>ratings</code> 的调用中注入了两秒钟的延迟，这样就让 <code>reviews</code> 服务要花费超过一秒钟的时间来调用 <code>ratings</code> 服务，从而触发了我们加入的超时控制。</p> <p>这样就会看到 Bookinfo 的页面（ 页面由 <code>reviews</code> 服务生成）上没有出现 <code>reviews</code> 服务的显示内容，取而代之的是错误信息：<strong>Sorry, product reviews are currently unavailable for this book</strong> ，出现这一信息的原因就是因为来自 <code>reviews</code> 服务的超时错误。</p> <p>如果测试了<a href=https://istio.io/zh/docs/tasks/traffic-management/fault-injection/ >故障注入任务</a>，会发现 <code>productpage</code> 微服务在调用 <code>reviews</code> 微服务时，还有自己的应用级超时设置（三秒钟）。注意这里我们用路由规则设置了一秒钟的超时。如果把超时设置为超过三秒钟（例如四秒钟）会毫无效果，这是因为内部的服务中设置了更为严格的超时要求。更多细节可以参见<a href=https://istio.io/zh/docs/concepts/traffic-management/#faq>故障处理 FAQ</a> 的相关内容。</p> <p>还有一点关于 Istio 中超时控制方面的补充说明，除了像本文一样在路由规则中进行超时设置之外，还可以进行请求一级的设置，只需在应用的外发流量中加入 <code>x-envoy-upstream-rq-timeout-ms</code> Header 即可。在这个 Header 中的超时设置单位是毫秒而不是秒。</p> <p>清理</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div> <h5 id=ingress>控制 Ingress 流量<a class=headerlink href=#ingress title="Permanent link">&para;</a></h5> <p>在 Kubernetes 环境中，<a href=https://kubernetes.io/docs/concepts/services-networking/ingress/ >Kubernetes Ingress 资源</a> 用于指定应在集群外部公开的服务。在 Istio 服务网格中，更好的方法（也适用于 Kubernetes 和其他环境）是使用不同的配置模型，即 <a href=https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#gateway>Istio <code>Gateway</code></a> 。 <code>Gateway</code> 允许将 Istio 功能（例如，监控和路由规则）应用于进入集群的流量。</p> <p>此任务描述如何配置 Istio 以使用 Istio 在服务网格外部公开服务 <code>Gateway</code>。</p> <h6 id=httpbin>暴露httpbin服务<a class=headerlink href=#httpbin title="Permanent link">&para;</a></h6> <ul> <li>部署httpbin服务</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>&lt;<span class=o>(</span>istioctl<span class=w> </span>kube-inject<span class=w> </span>-f<span class=w> </span>samples/httpbin/httpbin.yaml<span class=o>)</span>
</code></pre></div> <ul> <li>确定IP和端口</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;)</span>
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># echo $INGRESS_PORT</span>
<a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=m>31380</span>
<a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># export INGRESS_HOST=$(minikube ip)</span>
<a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># echo $INGRESS_HOST</span>
<a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=m>172</span>.16.0.2
</code></pre></div> <ul> <li>使用 Istio 网关配置 Ingress</li> </ul> <p>Ingress <a href=https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#gateway><code>Gateway</code></a> 描述了在网格边缘操作的负载平衡器，用于接收传入的 HTTP/TCP 连接。它配置暴露的端口、协议等，但与 <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/ >Kubernetes Ingress Resources</a> 不同，它不包括任何流量路由配置。流入流量的流量路由使用 Istio 路由规则进行配置，与内部服务请求完全相同。</p> <p>让我们看看如何为 <code>Gateway</code> 在 HTTP 80 端口上配置流量。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=c1># 创建一个 Istio Gateway：</span>
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f - &lt;&lt;EOF</span>
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>&gt;<span class=w> </span>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a>&gt;<span class=w> </span>kind:<span class=w> </span>Gateway
<a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a>&gt;<span class=w> </span>metadata:
<a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a>&gt;<span class=w>   </span>name:<span class=w> </span>httpbin-gateway
<a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a>&gt;<span class=w> </span>spec:
<a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a>&gt;<span class=w>   </span>selector:
<a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a>&gt;<span class=w>     </span>istio:<span class=w> </span>ingressgateway<span class=w> </span><span class=c1># use Istio default gateway implementation</span>
<a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a>&gt;<span class=w>   </span>servers:
<a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a>&gt;<span class=w>   </span>-<span class=w> </span>port:
<a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a>&gt;<span class=w>       </span>number:<span class=w> </span><span class=m>80</span>
<a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a>&gt;<span class=w>       </span>name:<span class=w> </span>http
<a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a>&gt;<span class=w>       </span>protocol:<span class=w> </span>HTTP
<a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a>&gt;<span class=w>     </span>hosts:
<a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a>&gt;<span class=w>     </span>-<span class=w> </span><span class=s2>&quot;httpbin.example.com&quot;</span>
<a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a>&gt;<span class=w> </span>EOF
<a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a>gateway.networking.istio.io/httpbin-gateway<span class=w> </span>created
<a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get gw httpbin-gateway</span>
<a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a>NAME<span class=w>              </span>AGE
<a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a>httpbin-gateway<span class=w>   </span>12s
<a id=__codelineno-40-22 name=__codelineno-40-22 href=#__codelineno-40-22></a>
<a id=__codelineno-40-23 name=__codelineno-40-23 href=#__codelineno-40-23></a>
<a id=__codelineno-40-24 name=__codelineno-40-24 href=#__codelineno-40-24></a><span class=c1># 为通过 Gateway 进入的流量配置路由：</span>
<a id=__codelineno-40-25 name=__codelineno-40-25 href=#__codelineno-40-25></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-40-26 name=__codelineno-40-26 href=#__codelineno-40-26></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-40-27 name=__codelineno-40-27 href=#__codelineno-40-27></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-40-28 name=__codelineno-40-28 href=#__codelineno-40-28></a><span class=s>metadata:</span>
<a id=__codelineno-40-29 name=__codelineno-40-29 href=#__codelineno-40-29></a><span class=s>  name: httpbin</span>
<a id=__codelineno-40-30 name=__codelineno-40-30 href=#__codelineno-40-30></a><span class=s>spec:</span>
<a id=__codelineno-40-31 name=__codelineno-40-31 href=#__codelineno-40-31></a><span class=s>  hosts:</span>
<a id=__codelineno-40-32 name=__codelineno-40-32 href=#__codelineno-40-32></a><span class=s>  - &quot;httpbin.example.com&quot;</span>
<a id=__codelineno-40-33 name=__codelineno-40-33 href=#__codelineno-40-33></a><span class=s>  gateways:</span>
<a id=__codelineno-40-34 name=__codelineno-40-34 href=#__codelineno-40-34></a><span class=s>  - httpbin-gateway</span>
<a id=__codelineno-40-35 name=__codelineno-40-35 href=#__codelineno-40-35></a><span class=s>  http:</span>
<a id=__codelineno-40-36 name=__codelineno-40-36 href=#__codelineno-40-36></a><span class=s>  - match:</span>
<a id=__codelineno-40-37 name=__codelineno-40-37 href=#__codelineno-40-37></a><span class=s>    - uri:</span>
<a id=__codelineno-40-38 name=__codelineno-40-38 href=#__codelineno-40-38></a><span class=s>        prefix: /status</span>
<a id=__codelineno-40-39 name=__codelineno-40-39 href=#__codelineno-40-39></a><span class=s>    - uri:</span>
<a id=__codelineno-40-40 name=__codelineno-40-40 href=#__codelineno-40-40></a><span class=s>        prefix: /delay</span>
<a id=__codelineno-40-41 name=__codelineno-40-41 href=#__codelineno-40-41></a><span class=s>    route:</span>
<a id=__codelineno-40-42 name=__codelineno-40-42 href=#__codelineno-40-42></a><span class=s>    - destination:</span>
<a id=__codelineno-40-43 name=__codelineno-40-43 href=#__codelineno-40-43></a><span class=s>        port:</span>
<a id=__codelineno-40-44 name=__codelineno-40-44 href=#__codelineno-40-44></a><span class=s>          number: 8000</span>
<a id=__codelineno-40-45 name=__codelineno-40-45 href=#__codelineno-40-45></a><span class=s>        host: httpbin</span>
<a id=__codelineno-40-46 name=__codelineno-40-46 href=#__codelineno-40-46></a><span class=s>EOF</span>
<a id=__codelineno-40-47 name=__codelineno-40-47 href=#__codelineno-40-47></a>
<a id=__codelineno-40-48 name=__codelineno-40-48 href=#__codelineno-40-48></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get vs httpbin</span>
<a id=__codelineno-40-49 name=__codelineno-40-49 href=#__codelineno-40-49></a>NAME<span class=w>      </span>GATEWAYS<span class=w>            </span>HOSTS<span class=w>                   </span>AGE
<a id=__codelineno-40-50 name=__codelineno-40-50 href=#__codelineno-40-50></a>httpbin<span class=w>   </span><span class=o>[</span>httpbin-gateway<span class=o>]</span><span class=w>   </span><span class=o>[</span>httpbin.example.com<span class=o>]</span><span class=w>   </span>7s
</code></pre></div> <p>在这里，我们为服务创建了一个<a href=https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#virtualservice>虚拟服务</a>配置 <code>httpbin</code> ，其中包含两条路由规则，允许路径 <code>/status</code> 和 路径的流量 <code>/delay</code>。</p> <p>该<a href=https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#virtualservice>网关</a>列表指定，只有通过我们的要求 <code>httpbin-gateway</code> 是允许的。所有其他外部请求将被拒绝，并返回 404 响应。</p> <p>请注意，在此配置中，来自网格中其他服务的内部请求不受这些规则约束，而是简单地默认为循环路由。要将这些（或其他规则）应用于内部调用，我们可以将特殊值 <code>mesh</code> 添加到 <code>gateways</code> 的列表中。</p> <ul> <li>使用 curl 访问 httpbin 服务：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># curl -I -HHost:httpbin.example.com http://$INGRESS_HOST:$INGRESS_PORT/status/200</span>
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>HTTP/1.1<span class=w> </span><span class=m>200</span><span class=w> </span>OK
<a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>server:<span class=w> </span>istio-envoy
<a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a>date:<span class=w> </span>Tue,<span class=w> </span><span class=m>06</span><span class=w> </span>Aug<span class=w> </span><span class=m>2019</span><span class=w> </span><span class=m>09</span>:26:53<span class=w> </span>GMT
<a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>content-type:<span class=w> </span>text/html<span class=p>;</span><span class=w> </span><span class=nv>charset</span><span class=o>=</span>utf-8
<a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a>access-control-allow-origin:<span class=w> </span>*
<a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a>access-control-allow-credentials:<span class=w> </span><span class=nb>true</span>
<a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a>content-length:<span class=w> </span><span class=m>0</span>
<a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a>x-envoy-upstream-service-time:<span class=w> </span><span class=m>268</span>
</code></pre></div> <p>请注意，这里使用该 <code>-H</code> 标志将 <code>Host</code> HTTP Header 设置为 “httpbin.example.com”。这一操作是必需的，因为上面的 Ingress <code>Gateway</code> 被配置为处理 “httpbin.example.com”，但在测试环境中没有该主机的 DNS 绑定，只是将请求发送到 Ingress IP。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1>#访问任何未明确公开的其他 URL，应该会看到一个 HTTP 404 错误：</span>
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># curl -I -HHost:httpbin.example.com http://$INGRESS_HOST:$INGRESS_PORT/headers</span>
<a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>HTTP/1.1<span class=w> </span><span class=m>404</span><span class=w> </span>Not<span class=w> </span>Found
<a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>date:<span class=w> </span>Tue,<span class=w> </span><span class=m>06</span><span class=w> </span>Aug<span class=w> </span><span class=m>2019</span><span class=w> </span><span class=m>09</span>:27:46<span class=w> </span>GMT
<a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>server:<span class=w> </span>istio-envoy
<a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a>transfer-encoding:<span class=w> </span>chunked
</code></pre></div> <ul> <li>使用浏览器访问 Ingress 服务</li> </ul> <p>在浏览器中输入 <code>httpbin</code> 服务的地址是不会生效的，这是因为因为我们没有办法让浏览器像 <code>curl</code> 一样装作访问 <code>httpbin.example.com</code>。而在现实世界中，因为有正常配置的主机和 DNS 记录，这种做法就能够成功了——只要简单的在浏览器中访问由域名构成的 URL 即可，例如 <code>https://httpbin.example.com/status/200</code>。</p> <p>要解决此问题以进行简单的测试和演示，我们可以在 <code>Gateway</code> 和 <code>VirtualService</code> 配置中为主机使用通配符值 <code>*</code>。例如，如果我们将 Ingress 配置更改为以下内容：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=s>kind: Gateway</span>
<a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=s>metadata:</span>
<a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=s>  name: httpbin-gateway</span>
<a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=s>spec:</span>
<a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=s>  selector:</span>
<a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=s>    istio: ingressgateway # use Istio default gateway implementation</span>
<a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=s>  servers:</span>
<a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=s>  - port:</span>
<a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=s>      number: 80</span>
<a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=s>      name: http</span>
<a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=s>      protocol: HTTP</span>
<a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a><span class=s>    hosts:</span>
<a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=s>    - &quot;*&quot;</span>
<a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=s>---</span>
<a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=s>metadata:</span>
<a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=s>  name: httpbin</span>
<a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=s>spec:</span>
<a id=__codelineno-43-22 name=__codelineno-43-22 href=#__codelineno-43-22></a><span class=s>  hosts:</span>
<a id=__codelineno-43-23 name=__codelineno-43-23 href=#__codelineno-43-23></a><span class=s>  - &quot;*&quot;</span>
<a id=__codelineno-43-24 name=__codelineno-43-24 href=#__codelineno-43-24></a><span class=s>  gateways:</span>
<a id=__codelineno-43-25 name=__codelineno-43-25 href=#__codelineno-43-25></a><span class=s>  - httpbin-gateway</span>
<a id=__codelineno-43-26 name=__codelineno-43-26 href=#__codelineno-43-26></a><span class=s>  http:</span>
<a id=__codelineno-43-27 name=__codelineno-43-27 href=#__codelineno-43-27></a><span class=s>  - match:</span>
<a id=__codelineno-43-28 name=__codelineno-43-28 href=#__codelineno-43-28></a><span class=s>    - uri:</span>
<a id=__codelineno-43-29 name=__codelineno-43-29 href=#__codelineno-43-29></a><span class=s>        prefix: /headers</span>
<a id=__codelineno-43-30 name=__codelineno-43-30 href=#__codelineno-43-30></a><span class=s>    route:</span>
<a id=__codelineno-43-31 name=__codelineno-43-31 href=#__codelineno-43-31></a><span class=s>    - destination:</span>
<a id=__codelineno-43-32 name=__codelineno-43-32 href=#__codelineno-43-32></a><span class=s>        port:</span>
<a id=__codelineno-43-33 name=__codelineno-43-33 href=#__codelineno-43-33></a><span class=s>          number: 8000</span>
<a id=__codelineno-43-34 name=__codelineno-43-34 href=#__codelineno-43-34></a><span class=s>        host: httpbin</span>
<a id=__codelineno-43-35 name=__codelineno-43-35 href=#__codelineno-43-35></a><span class=s>EOF</span>
</code></pre></div> <p>接下来就可以在浏览器的 URL 中使用,<a href=http://106.52.172.132:31380/headers>http://106.52.172.132:31380/headers</a></p> <p><img alt=image-20190806173530930 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190806173530930.png"></p> <h6 id=_25>原理<a class=headerlink href=#_25 title="Permanent link">&para;</a></h6> <p><code>Gateway</code> 配置资源允许外部流量进入 Istio 服务网，并使 Istio 的流量管理和策略功能可用于边缘服务。</p> <p>在前面的步骤中，我们在 Istio 服务网格中创建了一个服务，并展示了如何将服务的 HTTP 端点暴露给外部流量。</p> <h6 id=_26>清理<a class=headerlink href=#_26 title="Permanent link">&para;</a></h6> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>kubectl<span class=w> </span>delete<span class=w> </span>gateway<span class=w> </span>httpbin-gateway
<a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>kubectl<span class=w> </span>delete<span class=w> </span>virtualservice<span class=w> </span>httpbin
<a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>kubectl<span class=w> </span>delete<span class=w> </span>--ignore-not-found<span class=o>=</span><span class=nb>true</span><span class=w> </span>-f<span class=w> </span>samples/httpbin/httpbin.yaml
</code></pre></div> <h5 id=ingress-gateway>加密ingress gateway<a class=headerlink href=#ingress-gateway title="Permanent link">&para;</a></h5> <h6 id=sds-gateway-https>使用 SDS 为 Gateway 提供 HTTPS 加密支持<a class=headerlink href=#sds-gateway-https title="Permanent link">&para;</a></h6> <p><a href=https://istio.io/zh/docs/tasks/traffic-management/ingress>控制 Ingress 流量任务</a>中描述了如何进行配置，通过 Ingress Gateway 把服务的 HTTP 端点暴露给外部。这里更进一步，使用单向或者双向 TLS 来完成开放服务的任务。双向 TLS 所需的私钥、服务器证书以及根证书都由 Secret 发现服务（SDS）完成配置。</p> <ul> <li> <p>验证curl工具是否支持</p> </li> <li> <p>生成证书</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>yum<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>git
<a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>git<span class=w> </span>clone<span class=w> </span>https://github.com/nicholasjackson/mtls-go-example
<a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=c1># 进入代码库</span>
<a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=nb>pushd</span><span class=w> </span>mtls-go-example
<a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=c1># 为 httpbin.example.com 生成证书。注意要把下面命令中的 password 替换为其它值。</span>
<a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a>./generate.sh<span class=w> </span>httpbin.example.com<span class=w> </span>password
<a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a>
<a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=c1># 看到提示后，所有问题都输入 Y 即可。这个命令会生成四个目录：1_root、2_intermediate、3_application 以及 4_client。这些目录中包含了后续过程所需的客户端和服务端证书。</span>
<a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a>mkdir<span class=w> </span>../httpbin.example.com<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>mv<span class=w> </span>1_root<span class=w> </span>2_intermediate<span class=w> </span>3_application<span class=w> </span>4_client<span class=w> </span>../httpbin.example.com
</code></pre></div> <ul> <li>使用 SDS 配置 TLS Ingress 网关</li> </ul> <p>可以配置 TLS Ingress 网关，让它从 Ingress 网关代理通过 SDS 获取凭据。Ingress 网关代理和 Ingress 网关在同一个 Pod 中运行，监视 Ingress 网关所在命名空间中新建的 <code>Secret</code>。在 Ingress 网关中启用 SDS 具有如下好处：</p> <p>Ingress 网关无需重启，就可以动态的新增、删除或者更新密钥/证书对以及根证书。</p> <p>无需加载 <code>Secret</code> 卷。创建了 <code>kubernetes</code> <code>Secret</code> 之后，这个 <code>Secret</code> 就会被网关代理捕获，并以密钥/证书对和根证书的形式发送给 Ingress 网关。</p> <p>网关代理能够监视多个密钥/证书对。只需要为每个主机名创建 <code>Secret</code> 并更新网关定义就可以了。</p> <p>1.在 Ingress 网关上启用 SDS，并部署 Ingress 网关代理。</p> <p>这个功能缺省是禁用的，因此需要在 Helm 中打开 <a href=https://github.com/istio/istio/blob/release-1.2/install/kubernetes/helm/istio/charts/gateways/values.yaml><code>istio-ingressgateway.sds.enabled</code> 开关</a>，然后生成 <code>istio-ingressgateway.yaml</code> 文件：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>wget<span class=w> </span>https://get.helm.sh/helm-v2.14.2-linux-amd64.tar.gz
<a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a>tar<span class=w> </span>-xf<span class=w> </span>helm-v2.14.2-linux-amd64.tar.gz
<a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a>mv<span class=w> </span>linux-amd64/helm<span class=w> </span>/usr/bin/
<a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a>helm<span class=w> </span>version
<a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a>
<a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># helm template install/kubernetes/helm/istio/ --name istio \</span>
<a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a>&gt;<span class=w> </span>--namespace<span class=w> </span>istio-system<span class=w> </span>-x<span class=w> </span>charts/gateways/templates/deployment.yaml<span class=w> </span><span class=se>\</span>
<a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a>&gt;<span class=w> </span>--set<span class=w> </span>gateways.istio-egressgateway.enabled<span class=o>=</span><span class=nb>false</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a>&gt;<span class=w> </span>--set<span class=w> </span>gateways.istio-ingressgateway.sds.enabled<span class=o>=</span><span class=nb>true</span><span class=w> </span>&gt;<span class=w> </span><span class=se>\</span>
<a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a>&gt;<span class=w> </span><span class=nv>$HOME</span>/istio-ingressgateway.yaml
<a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl apply -f $HOME/istio-ingressgateway.yaml</span>
<a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a>deployment.apps/istio-ingressgateway<span class=w> </span>configured
</code></pre></div> <p>2.设置两个环境变量：<code>INGRESS_HOST</code> 和 <code>SECURE_INGRESS_PORT</code>：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=nb>export</span><span class=w> </span><span class=nv>SECURE_INGRESS_PORT</span><span class=o>=</span><span class=k>$(</span>kubectl<span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span><span class=se>\</span>
<a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a>get<span class=w> </span>service<span class=w> </span>istio-ingressgateway<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.ports[?(@.name==&quot;https&quot;)].port}&#39;</span><span class=k>)</span>
<a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a>
<a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=nb>export</span><span class=w> </span><span class=nv>INGRESS_HOST</span><span class=o>=</span><span class=k>$(</span>minikube<span class=w> </span>ip<span class=k>)</span>
</code></pre></div> <h6 id=1-tls-ingress>1.为单一主机配置 TLS Ingress 网关<a class=headerlink href=#1-tls-ingress title="Permanent link">&para;</a></h6> <p>1.启动 <code>httpbin</code> 样例：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | kubectl apply -f -</span>
<a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=s>apiVersion: v1</span>
<a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=s>kind: Service</span>
<a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=s>metadata:</span>
<a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=s>  name: httpbin</span>
<a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=s>  labels:</span>
<a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=s>    app: httpbin</span>
<a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=s>spec:</span>
<a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=s>  ports:</span>
<a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=s>  - name: http</span>
<a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a><span class=s>    port: 8000</span>
<a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a><span class=s>  selector:</span>
<a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=s>    app: httpbin</span>
<a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=s>---</span>
<a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a><span class=s>apiVersion: extensions/v1beta1</span>
<a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a><span class=s>kind: Deployment</span>
<a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=s>metadata:</span>
<a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a><span class=s>  name: httpbin</span>
<a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=s>spec:</span>
<a id=__codelineno-48-20 name=__codelineno-48-20 href=#__codelineno-48-20></a><span class=s>  replicas: 1</span>
<a id=__codelineno-48-21 name=__codelineno-48-21 href=#__codelineno-48-21></a><span class=s>  template:</span>
<a id=__codelineno-48-22 name=__codelineno-48-22 href=#__codelineno-48-22></a><span class=s>    metadata:</span>
<a id=__codelineno-48-23 name=__codelineno-48-23 href=#__codelineno-48-23></a><span class=s>      labels:</span>
<a id=__codelineno-48-24 name=__codelineno-48-24 href=#__codelineno-48-24></a><span class=s>        app: httpbin</span>
<a id=__codelineno-48-25 name=__codelineno-48-25 href=#__codelineno-48-25></a><span class=s>        version: v1</span>
<a id=__codelineno-48-26 name=__codelineno-48-26 href=#__codelineno-48-26></a><span class=s>    spec:</span>
<a id=__codelineno-48-27 name=__codelineno-48-27 href=#__codelineno-48-27></a><span class=s>      containers:</span>
<a id=__codelineno-48-28 name=__codelineno-48-28 href=#__codelineno-48-28></a><span class=s>      - image: docker.io/citizenstig/httpbin</span>
<a id=__codelineno-48-29 name=__codelineno-48-29 href=#__codelineno-48-29></a><span class=s>        imagePullPolicy: IfNotPresent</span>
<a id=__codelineno-48-30 name=__codelineno-48-30 href=#__codelineno-48-30></a><span class=s>        name: httpbin</span>
<a id=__codelineno-48-31 name=__codelineno-48-31 href=#__codelineno-48-31></a><span class=s>        ports:</span>
<a id=__codelineno-48-32 name=__codelineno-48-32 href=#__codelineno-48-32></a><span class=s>        - containerPort: 8000</span>
<a id=__codelineno-48-33 name=__codelineno-48-33 href=#__codelineno-48-33></a><span class=s>EOF</span>
</code></pre></div> <p>2.为 Ingress 网关创建 <code>Secret：</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl create -n istio-system secret generic httpbin-credential \</span>
<a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a>&gt;<span class=w> </span>--from-file<span class=o>=</span><span class=nv>key</span><span class=o>=</span>httpbin.example.com/3_application/private/httpbin.example.com.key.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a>&gt;<span class=w> </span>--from-file<span class=o>=</span><span class=nv>cert</span><span class=o>=</span>httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem
<a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a>secret/httpbin-credential<span class=w> </span>created
</code></pre></div> <p>3.创建一个网关，其 <code>servers:</code> 字段的端口为 443，设置 <code>credentialName</code> 的值为 <code>httpbin-credential</code>。这个值就是 <code>Secret</code> 的名字。TLS 模式设置为 <code>SIMPLE</code>。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | kubectl apply -f -</span>
<a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=s>kind: Gateway</span>
<a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=s>metadata:</span>
<a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=s>  name: mygateway</span>
<a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=s>spec:</span>
<a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=s>  selector:</span>
<a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=s>    istio: ingressgateway # 使用缺省的 Ingress 网关。</span>
<a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=s>  servers:</span>
<a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=s>  - port:</span>
<a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=s>      number: 443</span>
<a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a><span class=s>      name: https</span>
<a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a><span class=s>      protocol: HTTPS</span>
<a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a><span class=s>    tls:</span>
<a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a><span class=s>      mode: SIMPLE</span>
<a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a><span class=s>      credentialName: &quot;httpbin-credential&quot; # 和 Secret 名称一致</span>
<a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a><span class=s>    hosts:</span>
<a id=__codelineno-50-18 name=__codelineno-50-18 href=#__codelineno-50-18></a><span class=s>    - &quot;httpbin.example.com&quot;</span>
<a id=__codelineno-50-19 name=__codelineno-50-19 href=#__codelineno-50-19></a><span class=s>EOF</span>
</code></pre></div> <p>4.配置网关的 Ingress 流量路由，并配置对应的 <code>VirtualService</code>：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | kubectl apply -f -</span>
<a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=s>metadata:</span>
<a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=s>  name: httpbin</span>
<a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=s>spec:</span>
<a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=s>  hosts:</span>
<a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=s>  - &quot;httpbin.example.com&quot;</span>
<a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=s>  gateways:</span>
<a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=s>  - mygateway</span>
<a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=s>  http:</span>
<a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=s>  - match:</span>
<a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=s>    - uri:</span>
<a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=s>        prefix: /status</span>
<a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=s>    - uri:</span>
<a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=s>        prefix: /delay</span>
<a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=s>    route:</span>
<a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a><span class=s>    - destination:</span>
<a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a><span class=s>        port:</span>
<a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a><span class=s>          number: 8000</span>
<a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a><span class=s>        host: httpbin</span>
<a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a><span class=s>EOF</span>
</code></pre></div> <p>5.用 HTTPS 协议访问 <code>httpbin</code> 服务：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a>curl<span class=w> </span>-v<span class=w> </span>-HHost:httpbin.example.com<span class=w> </span><span class=se>\</span>
<a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a>--resolve<span class=w> </span>httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a>--cacert<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a>https://httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/status/418
</code></pre></div> <p><code>httpbin</code> 服务会返回 <a href=https://tools.ietf.org/html/rfc7168#section-2.3.3>418 I’m a Teapot</a>。</p> <p>6.删除网关的 <code>Secret</code>，并新建另外一个，然后修改 Ingress 网关的凭据：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a>kubectl<span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span>delete<span class=w> </span>secret<span class=w> </span>httpbin-credential
</code></pre></div> <p>7.使用curl访问</p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=o>[</span>root@VM_0_2_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:$SECURE_INGRESS_PORT:$INGRESS_HOST --cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem https://httpbin.example.com:$SECURE_INGRESS_PORT/status/418</span>
<a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a>*<span class=w> </span>Added<span class=w> </span>httpbin.example.com:443:10.108.162.3<span class=w> </span>to<span class=w> </span>DNS<span class=w> </span>cache
<a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a>*<span class=w> </span>About<span class=w> </span>to<span class=w> </span>connect<span class=o>()</span><span class=w> </span>to<span class=w> </span>httpbin.example.com<span class=w> </span>port<span class=w> </span><span class=m>443</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a>*<span class=w>   </span>Trying<span class=w> </span><span class=m>10</span>.108.162.3...
<a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a>*<span class=w> </span>Connected<span class=w> </span>to<span class=w> </span>httpbin.example.com<span class=w> </span><span class=o>(</span><span class=m>10</span>.108.162.3<span class=o>)</span><span class=w> </span>port<span class=w> </span><span class=m>443</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a>*<span class=w> </span>Initializing<span class=w> </span>NSS<span class=w> </span>with<span class=w> </span>certpath:<span class=w> </span>sql:/etc/pki/nssdb
<a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a>*<span class=w>   </span>CAfile:<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem
<a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=w>  </span>CApath:<span class=w> </span>none
<a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a>*<span class=w> </span>SSL<span class=w> </span>connection<span class=w> </span>using<span class=w> </span>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
<a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a>*<span class=w> </span>Server<span class=w> </span>certificate:
<a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a>*<span class=w>   </span>subject:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>httpbin.example.com,O<span class=o>=</span>Dis,L<span class=o>=</span>Springfield,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a>*<span class=w>   </span>start<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>06</span><span class=w> </span><span class=m>09</span>:48:13<span class=w> </span><span class=m>2019</span><span class=w> </span>GMT
<a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a>*<span class=w>   </span>expire<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>15</span><span class=w> </span><span class=m>09</span>:48:13<span class=w> </span><span class=m>2020</span><span class=w> </span>GMT
<a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a>*<span class=w>   </span>common<span class=w> </span>name:<span class=w> </span>httpbin.example.com
<a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a>*<span class=w>   </span>issuer:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>httpbin.example.com,O<span class=o>=</span>Dis,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a>&gt;<span class=w> </span>GET<span class=w> </span>/status/418<span class=w> </span>HTTP/1.1
<a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a>&gt;<span class=w> </span>User-Agent:<span class=w> </span>curl/7.29.0
<a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a>&gt;<span class=w> </span>Accept:<span class=w> </span>*/*
<a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a>&gt;<span class=w> </span>Host:httpbin.example.com
<a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a>&gt;
<a id=__codelineno-54-21 name=__codelineno-54-21 href=#__codelineno-54-21></a>&lt;<span class=w> </span>HTTP/1.1<span class=w> </span><span class=m>418</span><span class=w> </span>Unknown
<a id=__codelineno-54-22 name=__codelineno-54-22 href=#__codelineno-54-22></a>&lt;<span class=w> </span>server:<span class=w> </span>istio-envoy
<a id=__codelineno-54-23 name=__codelineno-54-23 href=#__codelineno-54-23></a>&lt;<span class=w> </span>date:<span class=w> </span>Wed,<span class=w> </span><span class=m>07</span><span class=w> </span>Aug<span class=w> </span><span class=m>2019</span><span class=w> </span><span class=m>10</span>:04:24<span class=w> </span>GMT
<a id=__codelineno-54-24 name=__codelineno-54-24 href=#__codelineno-54-24></a>&lt;<span class=w> </span>access-control-allow-origin:<span class=w> </span>*
<a id=__codelineno-54-25 name=__codelineno-54-25 href=#__codelineno-54-25></a>&lt;<span class=w> </span>x-more-info:<span class=w> </span>http://tools.ietf.org/html/rfc2324
<a id=__codelineno-54-26 name=__codelineno-54-26 href=#__codelineno-54-26></a>&lt;<span class=w> </span>access-control-allow-credentials:<span class=w> </span><span class=nb>true</span>
<a id=__codelineno-54-27 name=__codelineno-54-27 href=#__codelineno-54-27></a>&lt;<span class=w> </span>content-length:<span class=w> </span><span class=m>135</span>
<a id=__codelineno-54-28 name=__codelineno-54-28 href=#__codelineno-54-28></a>&lt;<span class=w> </span>x-envoy-upstream-service-time:<span class=w> </span><span class=m>94</span>
<a id=__codelineno-54-29 name=__codelineno-54-29 href=#__codelineno-54-29></a>&lt;
<a id=__codelineno-54-30 name=__codelineno-54-30 href=#__codelineno-54-30></a>
<a id=__codelineno-54-31 name=__codelineno-54-31 href=#__codelineno-54-31></a><span class=w>    </span>-<span class=o>=[</span><span class=w> </span>teapot<span class=w> </span><span class=o>]=</span>-
<a id=__codelineno-54-32 name=__codelineno-54-32 href=#__codelineno-54-32></a>
<a id=__codelineno-54-33 name=__codelineno-54-33 href=#__codelineno-54-33></a><span class=w>       </span>_...._
<a id=__codelineno-54-34 name=__codelineno-54-34 href=#__codelineno-54-34></a><span class=w>     </span>.<span class=err>&#39;</span><span class=w>  </span>_<span class=w> </span>_<span class=w> </span><span class=sb>`</span>.
<a id=__codelineno-54-35 name=__codelineno-54-35 href=#__codelineno-54-35></a><span class=w>    </span><span class=p>|</span><span class=w> </span>.<span class=s2>&quot;` ^ `&quot;</span>.<span class=w> </span>_,
<a id=__codelineno-54-36 name=__codelineno-54-36 href=#__codelineno-54-36></a><span class=w>    </span><span class=se>\_</span><span class=p>;</span><span class=sb>`</span><span class=s2>&quot;---&quot;</span><span class=sb>`</span><span class=p>|</span>//
<a id=__codelineno-54-37 name=__codelineno-54-37 href=#__codelineno-54-37></a><span class=w>      </span><span class=p>|</span><span class=w>       </span><span class=p>;</span>/
<a id=__codelineno-54-38 name=__codelineno-54-38 href=#__codelineno-54-38></a><span class=w>      </span><span class=se>\_</span><span class=w>     </span>_/
<a id=__codelineno-54-39 name=__codelineno-54-39 href=#__codelineno-54-39></a><span class=w>        </span><span class=sb>`</span><span class=s2>&quot;&quot;&quot;`</span>
<a id=__codelineno-54-40 name=__codelineno-54-40 href=#__codelineno-54-40></a><span class=s2>* Connection #0 to host httpbin.example.com left intact</span>
</code></pre></div> <p>为 TLS Ingress 网关配置多个主机名</p> <p>可以把多个主机名配置到同一个 Ingress 网关上，例如 <code>httpbin.example.com</code> 和 <code>helloworld-v1.example.com</code>。Ingress 网关会为每个 <code>credentialName</code> 获取一个唯一的凭据。</p> <h6 id=2-tls-ingress>2.为 TLS Ingress 网关配置多个主机名<a class=headerlink href=#2-tls-ingress title="Permanent link">&para;</a></h6> <p>可以把多个主机名配置到同一个 Ingress 网关上，例如 <code>httpbin.example.com</code> 和 <code>helloworld-v1.example.com</code>。Ingress 网关会为每个 <code>credentialName</code> 获取一个唯一的凭据。</p> <ul> <li>启动 <code>hellowworld-v1</code> 示例：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | kubectl apply -f -</span>
<a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=s>apiVersion: v1</span>
<a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=s>kind: Service</span>
<a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=s>metadata:</span>
<a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=s>  name: helloworld-v1</span>
<a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a><span class=s>  labels:</span>
<a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a><span class=s>    app: helloworld-v1</span>
<a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a><span class=s>spec:</span>
<a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=s>  ports:</span>
<a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a><span class=s>  - name: http</span>
<a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a><span class=s>    port: 5000</span>
<a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a><span class=s>  selector:</span>
<a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a><span class=s>    app: helloworld-v1</span>
<a id=__codelineno-55-14 name=__codelineno-55-14 href=#__codelineno-55-14></a><span class=s>---</span>
<a id=__codelineno-55-15 name=__codelineno-55-15 href=#__codelineno-55-15></a><span class=s>apiVersion: extensions/v1beta1</span>
<a id=__codelineno-55-16 name=__codelineno-55-16 href=#__codelineno-55-16></a><span class=s>kind: Deployment</span>
<a id=__codelineno-55-17 name=__codelineno-55-17 href=#__codelineno-55-17></a><span class=s>metadata:</span>
<a id=__codelineno-55-18 name=__codelineno-55-18 href=#__codelineno-55-18></a><span class=s>  name: helloworld-v1</span>
<a id=__codelineno-55-19 name=__codelineno-55-19 href=#__codelineno-55-19></a><span class=s>spec:</span>
<a id=__codelineno-55-20 name=__codelineno-55-20 href=#__codelineno-55-20></a><span class=s>  replicas: 1</span>
<a id=__codelineno-55-21 name=__codelineno-55-21 href=#__codelineno-55-21></a><span class=s>  template:</span>
<a id=__codelineno-55-22 name=__codelineno-55-22 href=#__codelineno-55-22></a><span class=s>    metadata:</span>
<a id=__codelineno-55-23 name=__codelineno-55-23 href=#__codelineno-55-23></a><span class=s>      labels:</span>
<a id=__codelineno-55-24 name=__codelineno-55-24 href=#__codelineno-55-24></a><span class=s>        app: helloworld-v1</span>
<a id=__codelineno-55-25 name=__codelineno-55-25 href=#__codelineno-55-25></a><span class=s>    spec:</span>
<a id=__codelineno-55-26 name=__codelineno-55-26 href=#__codelineno-55-26></a><span class=s>      containers:</span>
<a id=__codelineno-55-27 name=__codelineno-55-27 href=#__codelineno-55-27></a><span class=s>      - name: helloworld</span>
<a id=__codelineno-55-28 name=__codelineno-55-28 href=#__codelineno-55-28></a><span class=s>        image: istio/examples-helloworld-v1</span>
<a id=__codelineno-55-29 name=__codelineno-55-29 href=#__codelineno-55-29></a><span class=s>        resources:</span>
<a id=__codelineno-55-30 name=__codelineno-55-30 href=#__codelineno-55-30></a><span class=s>          requests:</span>
<a id=__codelineno-55-31 name=__codelineno-55-31 href=#__codelineno-55-31></a><span class=s>            cpu: &quot;100m&quot;</span>
<a id=__codelineno-55-32 name=__codelineno-55-32 href=#__codelineno-55-32></a><span class=s>        imagePullPolicy: IfNotPresent #Always</span>
<a id=__codelineno-55-33 name=__codelineno-55-33 href=#__codelineno-55-33></a><span class=s>        ports:</span>
<a id=__codelineno-55-34 name=__codelineno-55-34 href=#__codelineno-55-34></a><span class=s>        - containerPort: 5000</span>
<a id=__codelineno-55-35 name=__codelineno-55-35 href=#__codelineno-55-35></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>为 Ingress 网关创建一个 Ingress。如果已经创建了 <code>httpbin-credential</code>，就可以创建 <code>helloworld-credential</code> Secret 了。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=nb>pushd</span><span class=w> </span>mtls-go-example
<a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>./generate.sh<span class=w> </span>helloworld-v1.example.com<span class=w> </span>password
<a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a>mkdir<span class=w> </span>../helloworld-v1.example.com<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>mv<span class=w> </span>1_root<span class=w> </span>2_intermediate<span class=w> </span>3_application<span class=w> </span>4_client<span class=w> </span>../helloworld-v1.example.com
<a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=nb>popd</span>
<a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a>kubectl<span class=w> </span>create<span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span>secret<span class=w> </span>generic<span class=w> </span>helloworld-credential<span class=w> </span><span class=se>\</span>
<a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a>--from-file<span class=o>=</span><span class=nv>key</span><span class=o>=</span>helloworld-v1.example.com/3_application/private/helloworld-v1.example.com.key.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a>--from-file<span class=o>=</span><span class=nv>cert</span><span class=o>=</span>helloworld-v1.example.com/3_application/certs/helloworld-v1.example.com.cert.pem
<a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a>
<a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=o>[</span>root@VM_0_3_centos<span class=w> </span>~<span class=o>]</span><span class=c1># kubectl get secret -n istio-system</span>
<a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a>NAME<span class=w>                                                 </span>TYPE<span class=w>                                  </span>DATA<span class=w>   </span>AGE
<a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a>default-token-q69rn<span class=w>                                  </span>kubernetes.io/service-account-token<span class=w>   </span><span class=m>3</span><span class=w>      </span>9d
<a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a>helloworld-credential<span class=w>                                </span>Opaque<span class=w>                                </span><span class=m>2</span><span class=w>      </span>49s
</code></pre></div> <ul> <li>定义一个网关，其中包含了两个 <code>server</code>，都开放了 443 端口。两个 <code>credentialName</code> 字段分别赋值为 <code>httpbin-credential</code> 和 <code>helloworld-credential</code>。<code>serverCertificate</code> 以及 <code>privateKey</code> 应该为空。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | kubectl apply -f -</span>
<a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=s>kind: Gateway</span>
<a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=s>metadata:</span>
<a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=s>  name: mygateway</span>
<a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=s>spec:</span>
<a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=s>  selector:</span>
<a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=s>    istio: ingressgateway # 使用缺省的 Ingress 网关</span>
<a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a><span class=s>  servers:</span>
<a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a><span class=s>  - port:</span>
<a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a><span class=s>      number: 443</span>
<a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a><span class=s>      name: https-httpbin</span>
<a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a><span class=s>      protocol: HTTPS</span>
<a id=__codelineno-57-14 name=__codelineno-57-14 href=#__codelineno-57-14></a><span class=s>    tls:</span>
<a id=__codelineno-57-15 name=__codelineno-57-15 href=#__codelineno-57-15></a><span class=s>      mode: SIMPLE</span>
<a id=__codelineno-57-16 name=__codelineno-57-16 href=#__codelineno-57-16></a><span class=s>      credentialName: &quot;httpbin-credential&quot;</span>
<a id=__codelineno-57-17 name=__codelineno-57-17 href=#__codelineno-57-17></a><span class=s>    hosts:</span>
<a id=__codelineno-57-18 name=__codelineno-57-18 href=#__codelineno-57-18></a><span class=s>    - &quot;httpbin.example.com&quot;</span>
<a id=__codelineno-57-19 name=__codelineno-57-19 href=#__codelineno-57-19></a><span class=s>  - port:</span>
<a id=__codelineno-57-20 name=__codelineno-57-20 href=#__codelineno-57-20></a><span class=s>      number: 443</span>
<a id=__codelineno-57-21 name=__codelineno-57-21 href=#__codelineno-57-21></a><span class=s>      name: https-helloworld</span>
<a id=__codelineno-57-22 name=__codelineno-57-22 href=#__codelineno-57-22></a><span class=s>      protocol: HTTPS</span>
<a id=__codelineno-57-23 name=__codelineno-57-23 href=#__codelineno-57-23></a><span class=s>    tls:</span>
<a id=__codelineno-57-24 name=__codelineno-57-24 href=#__codelineno-57-24></a><span class=s>      mode: SIMPLE</span>
<a id=__codelineno-57-25 name=__codelineno-57-25 href=#__codelineno-57-25></a><span class=s>      credentialName: &quot;helloworld-credential&quot;</span>
<a id=__codelineno-57-26 name=__codelineno-57-26 href=#__codelineno-57-26></a><span class=s>    hosts:</span>
<a id=__codelineno-57-27 name=__codelineno-57-27 href=#__codelineno-57-27></a><span class=s>    - &quot;helloworld-v1.example.com&quot;</span>
<a id=__codelineno-57-28 name=__codelineno-57-28 href=#__codelineno-57-28></a><span class=s>EOF</span>
<a id=__codelineno-57-29 name=__codelineno-57-29 href=#__codelineno-57-29></a>
<a id=__codelineno-57-30 name=__codelineno-57-30 href=#__codelineno-57-30></a><span class=c1># 查看</span>
<a id=__codelineno-57-31 name=__codelineno-57-31 href=#__codelineno-57-31></a><span class=o>[</span>root@VM_0_3_centos<span class=w> </span>~<span class=o>]</span><span class=c1># kubectl describe gw mygateway</span>
<a id=__codelineno-57-32 name=__codelineno-57-32 href=#__codelineno-57-32></a>Name:<span class=w>         </span>mygateway
<a id=__codelineno-57-33 name=__codelineno-57-33 href=#__codelineno-57-33></a>Namespace:<span class=w>    </span>default
<a id=__codelineno-57-34 name=__codelineno-57-34 href=#__codelineno-57-34></a>Labels:<span class=w>       </span>&lt;none&gt;
<a id=__codelineno-57-35 name=__codelineno-57-35 href=#__codelineno-57-35></a>Annotations:<span class=w>  </span>kubectl.kubernetes.io/last-applied-configuration:
<a id=__codelineno-57-36 name=__codelineno-57-36 href=#__codelineno-57-36></a><span class=w>                </span><span class=o>{</span><span class=s2>&quot;apiVersion&quot;</span>:<span class=s2>&quot;networking.istio.io/v1alpha3&quot;</span>,<span class=s2>&quot;kind&quot;</span>:<span class=s2>&quot;Gateway&quot;</span>,<span class=s2>&quot;metadata&quot;</span>:<span class=o>{</span><span class=s2>&quot;annotations&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;mygateway&quot;</span>,<span class=s2>&quot;namespace&quot;</span>:<span class=s2>&quot;default&quot;</span><span class=o>}</span>,<span class=s2>&quot;spec...</span>
<a id=__codelineno-57-37 name=__codelineno-57-37 href=#__codelineno-57-37></a><span class=s2>API Version:  networking.istio.io/v1alpha3</span>
<a id=__codelineno-57-38 name=__codelineno-57-38 href=#__codelineno-57-38></a><span class=s2>Kind:         Gateway</span>
<a id=__codelineno-57-39 name=__codelineno-57-39 href=#__codelineno-57-39></a><span class=s2>Metadata:</span>
<a id=__codelineno-57-40 name=__codelineno-57-40 href=#__codelineno-57-40></a><span class=s2>  Creation Timestamp:  2019-08-07T09:48:12Z</span>
<a id=__codelineno-57-41 name=__codelineno-57-41 href=#__codelineno-57-41></a><span class=s2>  Generation:          2</span>
<a id=__codelineno-57-42 name=__codelineno-57-42 href=#__codelineno-57-42></a><span class=s2>  Resource Version:    676604</span>
<a id=__codelineno-57-43 name=__codelineno-57-43 href=#__codelineno-57-43></a><span class=s2>  Self Link:           /apis/networking.istio.io/v1alpha3/namespaces/default/gateways/mygateway</span>
<a id=__codelineno-57-44 name=__codelineno-57-44 href=#__codelineno-57-44></a><span class=s2>  UID:                 0e8f2445-2112-46c8-b450-00073f3da98e</span>
<a id=__codelineno-57-45 name=__codelineno-57-45 href=#__codelineno-57-45></a><span class=s2>Spec:</span>
<a id=__codelineno-57-46 name=__codelineno-57-46 href=#__codelineno-57-46></a><span class=s2>  Selector:</span>
<a id=__codelineno-57-47 name=__codelineno-57-47 href=#__codelineno-57-47></a><span class=s2>    Istio:  ingressgateway</span>
<a id=__codelineno-57-48 name=__codelineno-57-48 href=#__codelineno-57-48></a><span class=s2>  Servers:</span>
<a id=__codelineno-57-49 name=__codelineno-57-49 href=#__codelineno-57-49></a><span class=s2>    Hosts:</span>
<a id=__codelineno-57-50 name=__codelineno-57-50 href=#__codelineno-57-50></a><span class=s2>      httpbin.example.com</span>
<a id=__codelineno-57-51 name=__codelineno-57-51 href=#__codelineno-57-51></a><span class=s2>    Port:</span>
<a id=__codelineno-57-52 name=__codelineno-57-52 href=#__codelineno-57-52></a><span class=s2>      Name:      https-httpbin</span>
<a id=__codelineno-57-53 name=__codelineno-57-53 href=#__codelineno-57-53></a><span class=s2>      Number:    443</span>
<a id=__codelineno-57-54 name=__codelineno-57-54 href=#__codelineno-57-54></a><span class=s2>      Protocol:  HTTPS</span>
<a id=__codelineno-57-55 name=__codelineno-57-55 href=#__codelineno-57-55></a><span class=s2>    Tls:</span>
<a id=__codelineno-57-56 name=__codelineno-57-56 href=#__codelineno-57-56></a><span class=s2>      Credential Name:  httpbin-credential</span>
<a id=__codelineno-57-57 name=__codelineno-57-57 href=#__codelineno-57-57></a><span class=s2>      Mode:             SIMPLE</span>
<a id=__codelineno-57-58 name=__codelineno-57-58 href=#__codelineno-57-58></a><span class=s2>    Hosts:</span>
<a id=__codelineno-57-59 name=__codelineno-57-59 href=#__codelineno-57-59></a><span class=s2>      helloworld-v1.example.com</span>
<a id=__codelineno-57-60 name=__codelineno-57-60 href=#__codelineno-57-60></a><span class=s2>    Port:</span>
<a id=__codelineno-57-61 name=__codelineno-57-61 href=#__codelineno-57-61></a><span class=s2>      Name:      https-helloworld</span>
<a id=__codelineno-57-62 name=__codelineno-57-62 href=#__codelineno-57-62></a><span class=s2>      Number:    443</span>
<a id=__codelineno-57-63 name=__codelineno-57-63 href=#__codelineno-57-63></a><span class=s2>      Protocol:  HTTPS</span>
<a id=__codelineno-57-64 name=__codelineno-57-64 href=#__codelineno-57-64></a><span class=s2>    Tls:</span>
<a id=__codelineno-57-65 name=__codelineno-57-65 href=#__codelineno-57-65></a><span class=s2>      Credential Name:  helloworld-credential</span>
<a id=__codelineno-57-66 name=__codelineno-57-66 href=#__codelineno-57-66></a><span class=s2>      Mode:             SIMPLE</span>
<a id=__codelineno-57-67 name=__codelineno-57-67 href=#__codelineno-57-67></a><span class=s2>Events:                 &lt;none&gt;</span>
</code></pre></div> <ul> <li>配置网关的流量路由，配置 <code>VirtualService</code></li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | kubectl apply -f -</span>
<a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=s>metadata:</span>
<a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=s>  name: helloworld-v1</span>
<a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a><span class=s>spec:</span>
<a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=s>  hosts:</span>
<a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=s>  - &quot;helloworld-v1.example.com&quot;</span>
<a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a><span class=s>  gateways:</span>
<a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a><span class=s>  - mygateway</span>
<a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a><span class=s>  http:</span>
<a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a><span class=s>  - match:</span>
<a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a><span class=s>    - uri:</span>
<a id=__codelineno-58-14 name=__codelineno-58-14 href=#__codelineno-58-14></a><span class=s>        exact: /hello</span>
<a id=__codelineno-58-15 name=__codelineno-58-15 href=#__codelineno-58-15></a><span class=s>    route:</span>
<a id=__codelineno-58-16 name=__codelineno-58-16 href=#__codelineno-58-16></a><span class=s>    - destination:</span>
<a id=__codelineno-58-17 name=__codelineno-58-17 href=#__codelineno-58-17></a><span class=s>        host: helloworld-v1</span>
<a id=__codelineno-58-18 name=__codelineno-58-18 href=#__codelineno-58-18></a><span class=s>        port:</span>
<a id=__codelineno-58-19 name=__codelineno-58-19 href=#__codelineno-58-19></a><span class=s>          number: 5000</span>
<a id=__codelineno-58-20 name=__codelineno-58-20 href=#__codelineno-58-20></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>向 <code>helloworld-v1.example.com</code> 发送 HTTPS 请求</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a>curl<span class=w> </span>-v<span class=w> </span>-HHost:helloworld-v1.example.com<span class=w> </span><span class=se>\</span>
<a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a>--resolve<span class=w> </span>helloworld-v1.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a>--cacert<span class=w> </span>helloworld-v1.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a>https://helloworld-v1.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/hello
<a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a>
<a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a>
<a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=o>[</span>root@VM_0_3_centos<span class=w> </span>~<span class=o>]</span><span class=c1># curl -v -HHost:helloworld-v1.example.com \</span>
<a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a>&gt;<span class=w> </span>--resolve<span class=w> </span>helloworld-v1.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a>&gt;<span class=w> </span>--cacert<span class=w> </span>helloworld-v1.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a>&gt;<span class=w> </span>https://helloworld-v1.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/hello
<a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a>*<span class=w> </span>Added<span class=w> </span>helloworld-v1.example.com:31390:172.16.0.3<span class=w> </span>to<span class=w> </span>DNS<span class=w> </span>cache
<a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a>*<span class=w> </span>About<span class=w> </span>to<span class=w> </span>connect<span class=o>()</span><span class=w> </span>to<span class=w> </span>helloworld-v1.example.com<span class=w> </span>port<span class=w> </span><span class=m>31390</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a>*<span class=w>   </span>Trying<span class=w> </span><span class=m>172</span>.16.0.3...
<a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a>*<span class=w> </span>Connected<span class=w> </span>to<span class=w> </span>helloworld-v1.example.com<span class=w> </span><span class=o>(</span><span class=m>172</span>.16.0.3<span class=o>)</span><span class=w> </span>port<span class=w> </span><span class=m>31390</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a>*<span class=w> </span>Initializing<span class=w> </span>NSS<span class=w> </span>with<span class=w> </span>certpath:<span class=w> </span>sql:/etc/pki/nssdb
<a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a>*<span class=w>   </span>CAfile:<span class=w> </span>helloworld-v1.example.com/2_intermediate/certs/ca-chain.cert.pem
<a id=__codelineno-59-17 name=__codelineno-59-17 href=#__codelineno-59-17></a><span class=w>  </span>CApath:<span class=w> </span>none
<a id=__codelineno-59-18 name=__codelineno-59-18 href=#__codelineno-59-18></a>*<span class=w> </span>SSL<span class=w> </span>connection<span class=w> </span>using<span class=w> </span>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
<a id=__codelineno-59-19 name=__codelineno-59-19 href=#__codelineno-59-19></a>*<span class=w> </span>Server<span class=w> </span>certificate:
<a id=__codelineno-59-20 name=__codelineno-59-20 href=#__codelineno-59-20></a>*<span class=w>   </span>subject:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>helloworld-v1.example.com,O<span class=o>=</span>Dis,L<span class=o>=</span>Springfield,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-59-21 name=__codelineno-59-21 href=#__codelineno-59-21></a>*<span class=w>   </span>start<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>14</span><span class=w> </span><span class=m>08</span>:50:44<span class=w> </span><span class=m>2019</span><span class=w> </span>GMT
<a id=__codelineno-59-22 name=__codelineno-59-22 href=#__codelineno-59-22></a>*<span class=w>   </span>expire<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>23</span><span class=w> </span><span class=m>08</span>:50:44<span class=w> </span><span class=m>2020</span><span class=w> </span>GMT
<a id=__codelineno-59-23 name=__codelineno-59-23 href=#__codelineno-59-23></a>*<span class=w>   </span>common<span class=w> </span>name:<span class=w> </span>helloworld-v1.example.com
<a id=__codelineno-59-24 name=__codelineno-59-24 href=#__codelineno-59-24></a>*<span class=w>   </span>issuer:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>helloworld-v1.example.com,O<span class=o>=</span>Dis,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-59-25 name=__codelineno-59-25 href=#__codelineno-59-25></a>&gt;<span class=w> </span>GET<span class=w> </span>/hello<span class=w> </span>HTTP/1.1
<a id=__codelineno-59-26 name=__codelineno-59-26 href=#__codelineno-59-26></a>&gt;<span class=w> </span>User-Agent:<span class=w> </span>curl/7.29.0
<a id=__codelineno-59-27 name=__codelineno-59-27 href=#__codelineno-59-27></a>&gt;<span class=w> </span>Accept:<span class=w> </span>*/*
<a id=__codelineno-59-28 name=__codelineno-59-28 href=#__codelineno-59-28></a>&gt;<span class=w> </span>Host:helloworld-v1.example.com
<a id=__codelineno-59-29 name=__codelineno-59-29 href=#__codelineno-59-29></a>&gt;
<a id=__codelineno-59-30 name=__codelineno-59-30 href=#__codelineno-59-30></a>&lt;<span class=w> </span>HTTP/1.1<span class=w> </span><span class=m>200</span><span class=w> </span>OK
<a id=__codelineno-59-31 name=__codelineno-59-31 href=#__codelineno-59-31></a>&lt;<span class=w> </span>content-type:<span class=w> </span>text/html<span class=p>;</span><span class=w> </span><span class=nv>charset</span><span class=o>=</span>utf-8
<a id=__codelineno-59-32 name=__codelineno-59-32 href=#__codelineno-59-32></a>&lt;<span class=w> </span>content-length:<span class=w> </span><span class=m>59</span>
<a id=__codelineno-59-33 name=__codelineno-59-33 href=#__codelineno-59-33></a>&lt;<span class=w> </span>server:<span class=w> </span>istio-envoy
<a id=__codelineno-59-34 name=__codelineno-59-34 href=#__codelineno-59-34></a>&lt;<span class=w> </span>date:<span class=w> </span>Wed,<span class=w> </span><span class=m>14</span><span class=w> </span>Aug<span class=w> </span><span class=m>2019</span><span class=w> </span><span class=m>09</span>:14:02<span class=w> </span>GMT
<a id=__codelineno-59-35 name=__codelineno-59-35 href=#__codelineno-59-35></a>&lt;<span class=w> </span>x-envoy-upstream-service-time:<span class=w> </span><span class=m>132</span>
<a id=__codelineno-59-36 name=__codelineno-59-36 href=#__codelineno-59-36></a>&lt;
<a id=__codelineno-59-37 name=__codelineno-59-37 href=#__codelineno-59-37></a>Hello<span class=w> </span>version:<span class=w> </span>v1,<span class=w> </span>instance:<span class=w> </span>helloworld-v1-b99c6449c-xchbg
<a id=__codelineno-59-38 name=__codelineno-59-38 href=#__codelineno-59-38></a>*<span class=w> </span>Connection<span class=w> </span><span class=c1>#0 to host helloworld-v1.example.com left intact</span>
</code></pre></div> <ul> <li>发送 HTTPS 请求到 <code>httpbin.example.com</code>，还是会看到茶壶：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a>curl<span class=w> </span>-v<span class=w> </span>-HHost:httpbin.example.com<span class=w> </span><span class=se>\</span>
<a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a>--resolve<span class=w> </span>httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a>--cacert<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a>https://httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/status/418
</code></pre></div> <h6 id=3-tls-ingress>3.配置双向 TLS Ingress 网关<a class=headerlink href=#3-tls-ingress title="Permanent link">&para;</a></h6> <p>可以对网关的定义进行扩展，加入<a href=https://en.wikipedia.org/wiki/Mutual_authentication>双向 TLS</a> 的支持。要修改 Ingress 网关的凭据，就要删除并重建对应的 <code>Secret</code>。服务器会使用 CA 证书对客户端进行校验，因此需要使用 <code>cacert</code> 字段来保存 CA 证书：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a>kubectl<span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span>delete<span class=w> </span>secret<span class=w> </span>httpbin-credential
<a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a>kubectl<span class=w> </span>create<span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span>secret<span class=w> </span>generic<span class=w> </span>httpbin-credential<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a>--from-file<span class=o>=</span><span class=nv>key</span><span class=o>=</span>httpbin.example.com/3_application/private/httpbin.example.com.key.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a>--from-file<span class=o>=</span><span class=nv>cert</span><span class=o>=</span>httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a>--from-file<span class=o>=</span><span class=nv>cacert</span><span class=o>=</span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem
</code></pre></div> <ul> <li>修改网关定义，设置 TLS 的模式为 <code>MUTUAL</code>：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | kubectl apply -f -</span>
<a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=s>kind: Gateway</span>
<a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=s>metadata:</span>
<a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=s> name: mygateway</span>
<a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=s>spec:</span>
<a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=s> selector:</span>
<a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=s>   istio: ingressgateway # Istio 的缺省 Ingress 网关</span>
<a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=s> servers:</span>
<a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=s> - port:</span>
<a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=s>     number: 443</span>
<a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=s>     name: https</span>
<a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=s>     protocol: HTTPS</span>
<a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=s>   tls:</span>
<a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a><span class=s>     mode: MUTUAL</span>
<a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=s>     credentialName: &quot;httpbin-credential&quot; # 和 Secret 名称一致</span>
<a id=__codelineno-62-17 name=__codelineno-62-17 href=#__codelineno-62-17></a><span class=s>   hosts:</span>
<a id=__codelineno-62-18 name=__codelineno-62-18 href=#__codelineno-62-18></a><span class=s>   - &quot;httpbin.example.com&quot;</span>
<a id=__codelineno-62-19 name=__codelineno-62-19 href=#__codelineno-62-19></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>使用前面的方式尝试发出 HTTPS 请求，会看到失败的过程：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a>curl<span class=w> </span>-v<span class=w> </span>-HHost:httpbin.example.com<span class=w> </span><span class=se>\</span>
<a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a>--resolve<span class=w> </span>httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a>--cacert<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a>https://httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/status/418
<a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a>
<a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=o>[</span>root@VM_0_3_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># curl -v -HHost:httpbin.example.com \</span>
<a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a>&gt;<span class=w> </span>--resolve<span class=w> </span>httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a>&gt;<span class=w> </span>--cacert<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a>&gt;<span class=w> </span>https://httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/status/418
<a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a>*<span class=w> </span>Added<span class=w> </span>httpbin.example.com:31390:172.16.0.3<span class=w> </span>to<span class=w> </span>DNS<span class=w> </span>cache
<a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a>*<span class=w> </span>About<span class=w> </span>to<span class=w> </span>connect<span class=o>()</span><span class=w> </span>to<span class=w> </span>httpbin.example.com<span class=w> </span>port<span class=w> </span><span class=m>31390</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a>*<span class=w>   </span>Trying<span class=w> </span><span class=m>172</span>.16.0.3...
<a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a>*<span class=w> </span>Connected<span class=w> </span>to<span class=w> </span>httpbin.example.com<span class=w> </span><span class=o>(</span><span class=m>172</span>.16.0.3<span class=o>)</span><span class=w> </span>port<span class=w> </span><span class=m>31390</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a>*<span class=w> </span>Initializing<span class=w> </span>NSS<span class=w> </span>with<span class=w> </span>certpath:<span class=w> </span>sql:/etc/pki/nssdb
<a id=__codelineno-63-15 name=__codelineno-63-15 href=#__codelineno-63-15></a>*<span class=w>   </span>CAfile:<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem
<a id=__codelineno-63-16 name=__codelineno-63-16 href=#__codelineno-63-16></a><span class=w>  </span>CApath:<span class=w> </span>none
<a id=__codelineno-63-17 name=__codelineno-63-17 href=#__codelineno-63-17></a>*<span class=w> </span>NSS:<span class=w> </span>client<span class=w> </span>certificate<span class=w> </span>not<span class=w> </span>found<span class=w> </span><span class=o>(</span>nickname<span class=w> </span>not<span class=w> </span>specified<span class=o>)</span>
<a id=__codelineno-63-18 name=__codelineno-63-18 href=#__codelineno-63-18></a>*<span class=w> </span>NSS<span class=w> </span>error<span class=w> </span>-12227<span class=w> </span><span class=o>(</span>SSL_ERROR_HANDSHAKE_FAILURE_ALERT<span class=o>)</span>
<a id=__codelineno-63-19 name=__codelineno-63-19 href=#__codelineno-63-19></a>*<span class=w> </span>SSL<span class=w> </span>peer<span class=w> </span>was<span class=w> </span>unable<span class=w> </span>to<span class=w> </span>negotiate<span class=w> </span>an<span class=w> </span>acceptable<span class=w> </span><span class=nb>set</span><span class=w> </span>of<span class=w> </span>security<span class=w> </span>parameters.
<a id=__codelineno-63-20 name=__codelineno-63-20 href=#__codelineno-63-20></a>*<span class=w> </span>Closing<span class=w> </span>connection<span class=w> </span><span class=m>0</span>
<a id=__codelineno-63-21 name=__codelineno-63-21 href=#__codelineno-63-21></a>curl:<span class=w> </span><span class=o>(</span><span class=m>35</span><span class=o>)</span><span class=w> </span>NSS:<span class=w> </span>client<span class=w> </span>certificate<span class=w> </span>not<span class=w> </span>found<span class=w> </span><span class=o>(</span>nickname<span class=w> </span>not<span class=w> </span>specified<span class=o>)</span>
</code></pre></div> <ul> <li>在 <code>curl</code> 命令中加入客户端证书和私钥的参数，重新发送请求。（客户端证书参数为 <code>--cert</code>，私钥参数为 <code>--key</code>）</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a>curl<span class=w> </span>-v<span class=w> </span>-HHost:httpbin.example.com<span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a>--resolve<span class=w> </span>httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a>--cacert<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a>--cert<span class=w> </span>httpbin.example.com/4_client/certs/httpbin.example.com.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a>--key<span class=w> </span>httpbin.example.com/4_client/private/httpbin.example.com.key.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a>https://httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/status/418
<a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a>
<a id=__codelineno-64-8 name=__codelineno-64-8 href=#__codelineno-64-8></a><span class=o>[</span>root@VM_0_3_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># curl -v -HHost:httpbin.example.com \</span>
<a id=__codelineno-64-9 name=__codelineno-64-9 href=#__codelineno-64-9></a>&gt;<span class=w> </span>--resolve<span class=w> </span>httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-10 name=__codelineno-64-10 href=#__codelineno-64-10></a>&gt;<span class=w> </span>--cacert<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-11 name=__codelineno-64-11 href=#__codelineno-64-11></a>&gt;<span class=w> </span>--cert<span class=w> </span>httpbin.example.com/4_client/certs/httpbin.example.com.cert.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-12 name=__codelineno-64-12 href=#__codelineno-64-12></a>&gt;<span class=w> </span>--key<span class=w> </span>httpbin.example.com/4_client/private/httpbin.example.com.key.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-64-13 name=__codelineno-64-13 href=#__codelineno-64-13></a>&gt;<span class=w> </span>https://httpbin.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>/status/418
<a id=__codelineno-64-14 name=__codelineno-64-14 href=#__codelineno-64-14></a>*<span class=w> </span>Added<span class=w> </span>httpbin.example.com:31390:172.16.0.3<span class=w> </span>to<span class=w> </span>DNS<span class=w> </span>cache
<a id=__codelineno-64-15 name=__codelineno-64-15 href=#__codelineno-64-15></a>*<span class=w> </span>About<span class=w> </span>to<span class=w> </span>connect<span class=o>()</span><span class=w> </span>to<span class=w> </span>httpbin.example.com<span class=w> </span>port<span class=w> </span><span class=m>31390</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-64-16 name=__codelineno-64-16 href=#__codelineno-64-16></a>*<span class=w>   </span>Trying<span class=w> </span><span class=m>172</span>.16.0.3...
<a id=__codelineno-64-17 name=__codelineno-64-17 href=#__codelineno-64-17></a>*<span class=w> </span>Connected<span class=w> </span>to<span class=w> </span>httpbin.example.com<span class=w> </span><span class=o>(</span><span class=m>172</span>.16.0.3<span class=o>)</span><span class=w> </span>port<span class=w> </span><span class=m>31390</span><span class=w> </span><span class=o>(</span><span class=c1>#0)</span>
<a id=__codelineno-64-18 name=__codelineno-64-18 href=#__codelineno-64-18></a>*<span class=w> </span>Initializing<span class=w> </span>NSS<span class=w> </span>with<span class=w> </span>certpath:<span class=w> </span>sql:/etc/pki/nssdb
<a id=__codelineno-64-19 name=__codelineno-64-19 href=#__codelineno-64-19></a>*<span class=w>   </span>CAfile:<span class=w> </span>httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem
<a id=__codelineno-64-20 name=__codelineno-64-20 href=#__codelineno-64-20></a><span class=w>  </span>CApath:<span class=w> </span>none
<a id=__codelineno-64-21 name=__codelineno-64-21 href=#__codelineno-64-21></a>*<span class=w> </span>NSS:<span class=w> </span>client<span class=w> </span>certificate<span class=w> </span>from<span class=w> </span>file
<a id=__codelineno-64-22 name=__codelineno-64-22 href=#__codelineno-64-22></a>*<span class=w>   </span>subject:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>httpbin.example.com,O<span class=o>=</span>Dis,L<span class=o>=</span>Springfield,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-64-23 name=__codelineno-64-23 href=#__codelineno-64-23></a>*<span class=w>   </span>start<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>06</span><span class=w> </span><span class=m>09</span>:48:15<span class=w> </span><span class=m>2019</span><span class=w> </span>GMT
<a id=__codelineno-64-24 name=__codelineno-64-24 href=#__codelineno-64-24></a>*<span class=w>   </span>expire<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>15</span><span class=w> </span><span class=m>09</span>:48:15<span class=w> </span><span class=m>2020</span><span class=w> </span>GMT
<a id=__codelineno-64-25 name=__codelineno-64-25 href=#__codelineno-64-25></a>*<span class=w>   </span>common<span class=w> </span>name:<span class=w> </span>httpbin.example.com
<a id=__codelineno-64-26 name=__codelineno-64-26 href=#__codelineno-64-26></a>*<span class=w>   </span>issuer:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>httpbin.example.com,O<span class=o>=</span>Dis,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-64-27 name=__codelineno-64-27 href=#__codelineno-64-27></a>*<span class=w> </span>SSL<span class=w> </span>connection<span class=w> </span>using<span class=w> </span>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
<a id=__codelineno-64-28 name=__codelineno-64-28 href=#__codelineno-64-28></a>*<span class=w> </span>Server<span class=w> </span>certificate:
<a id=__codelineno-64-29 name=__codelineno-64-29 href=#__codelineno-64-29></a>*<span class=w>   </span>subject:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>httpbin.example.com,O<span class=o>=</span>Dis,L<span class=o>=</span>Springfield,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-64-30 name=__codelineno-64-30 href=#__codelineno-64-30></a>*<span class=w>   </span>start<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>06</span><span class=w> </span><span class=m>09</span>:48:13<span class=w> </span><span class=m>2019</span><span class=w> </span>GMT
<a id=__codelineno-64-31 name=__codelineno-64-31 href=#__codelineno-64-31></a>*<span class=w>   </span>expire<span class=w> </span>date:<span class=w> </span>8月<span class=w> </span><span class=m>15</span><span class=w> </span><span class=m>09</span>:48:13<span class=w> </span><span class=m>2020</span><span class=w> </span>GMT
<a id=__codelineno-64-32 name=__codelineno-64-32 href=#__codelineno-64-32></a>*<span class=w>   </span>common<span class=w> </span>name:<span class=w> </span>httpbin.example.com
<a id=__codelineno-64-33 name=__codelineno-64-33 href=#__codelineno-64-33></a>*<span class=w>   </span>issuer:<span class=w> </span><span class=nv>CN</span><span class=o>=</span>httpbin.example.com,O<span class=o>=</span>Dis,ST<span class=o>=</span>Denial,C<span class=o>=</span>US
<a id=__codelineno-64-34 name=__codelineno-64-34 href=#__codelineno-64-34></a>&gt;<span class=w> </span>GET<span class=w> </span>/status/418<span class=w> </span>HTTP/1.1
<a id=__codelineno-64-35 name=__codelineno-64-35 href=#__codelineno-64-35></a>&gt;<span class=w> </span>User-Agent:<span class=w> </span>curl/7.29.0
<a id=__codelineno-64-36 name=__codelineno-64-36 href=#__codelineno-64-36></a>&gt;<span class=w> </span>Accept:<span class=w> </span>*/*
<a id=__codelineno-64-37 name=__codelineno-64-37 href=#__codelineno-64-37></a>&gt;<span class=w> </span>Host:httpbin.example.com
<a id=__codelineno-64-38 name=__codelineno-64-38 href=#__codelineno-64-38></a>&gt;
<a id=__codelineno-64-39 name=__codelineno-64-39 href=#__codelineno-64-39></a>&lt;<span class=w> </span>HTTP/1.1<span class=w> </span><span class=m>418</span><span class=w> </span>Unknown
<a id=__codelineno-64-40 name=__codelineno-64-40 href=#__codelineno-64-40></a>&lt;<span class=w> </span>server:<span class=w> </span>istio-envoy
<a id=__codelineno-64-41 name=__codelineno-64-41 href=#__codelineno-64-41></a>&lt;<span class=w> </span>date:<span class=w> </span>Wed,<span class=w> </span><span class=m>14</span><span class=w> </span>Aug<span class=w> </span><span class=m>2019</span><span class=w> </span><span class=m>09</span>:24:53<span class=w> </span>GMT
<a id=__codelineno-64-42 name=__codelineno-64-42 href=#__codelineno-64-42></a>&lt;<span class=w> </span>access-control-allow-origin:<span class=w> </span>*
<a id=__codelineno-64-43 name=__codelineno-64-43 href=#__codelineno-64-43></a>&lt;<span class=w> </span>x-more-info:<span class=w> </span>http://tools.ietf.org/html/rfc2324
<a id=__codelineno-64-44 name=__codelineno-64-44 href=#__codelineno-64-44></a>&lt;<span class=w> </span>access-control-allow-credentials:<span class=w> </span><span class=nb>true</span>
<a id=__codelineno-64-45 name=__codelineno-64-45 href=#__codelineno-64-45></a>&lt;<span class=w> </span>content-length:<span class=w> </span><span class=m>135</span>
<a id=__codelineno-64-46 name=__codelineno-64-46 href=#__codelineno-64-46></a>&lt;<span class=w> </span>x-envoy-upstream-service-time:<span class=w> </span><span class=m>5</span>
<a id=__codelineno-64-47 name=__codelineno-64-47 href=#__codelineno-64-47></a>&lt;
<a id=__codelineno-64-48 name=__codelineno-64-48 href=#__codelineno-64-48></a>
<a id=__codelineno-64-49 name=__codelineno-64-49 href=#__codelineno-64-49></a><span class=w>    </span>-<span class=o>=[</span><span class=w> </span>teapot<span class=w> </span><span class=o>]=</span>-
<a id=__codelineno-64-50 name=__codelineno-64-50 href=#__codelineno-64-50></a>
<a id=__codelineno-64-51 name=__codelineno-64-51 href=#__codelineno-64-51></a><span class=w>       </span>_...._
<a id=__codelineno-64-52 name=__codelineno-64-52 href=#__codelineno-64-52></a><span class=w>     </span>.<span class=err>&#39;</span><span class=w>  </span>_<span class=w> </span>_<span class=w> </span><span class=sb>`</span>.
<a id=__codelineno-64-53 name=__codelineno-64-53 href=#__codelineno-64-53></a><span class=w>    </span><span class=p>|</span><span class=w> </span>.<span class=s2>&quot;` ^ `&quot;</span>.<span class=w> </span>_,
<a id=__codelineno-64-54 name=__codelineno-64-54 href=#__codelineno-64-54></a><span class=w>    </span><span class=se>\_</span><span class=p>;</span><span class=sb>`</span><span class=s2>&quot;---&quot;</span><span class=sb>`</span><span class=p>|</span>//
<a id=__codelineno-64-55 name=__codelineno-64-55 href=#__codelineno-64-55></a><span class=w>      </span><span class=p>|</span><span class=w>       </span><span class=p>;</span>/
<a id=__codelineno-64-56 name=__codelineno-64-56 href=#__codelineno-64-56></a><span class=w>      </span><span class=se>\_</span><span class=w>     </span>_/
<a id=__codelineno-64-57 name=__codelineno-64-57 href=#__codelineno-64-57></a><span class=w>        </span><span class=sb>`</span><span class=s2>&quot;&quot;&quot;`</span>
<a id=__codelineno-64-58 name=__codelineno-64-58 href=#__codelineno-64-58></a><span class=s2>* Connection #0 to host httpbin.example.com left intact</span>
</code></pre></div> <h6 id=_27>清理<a class=headerlink href=#_27 title="Permanent link">&para;</a></h6> <ul> <li>删除网关配置、<code>VirtualService</code> 以及 <code>Secret</code>：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a>$<span class=w> </span>kubectl<span class=w> </span>delete<span class=w> </span>gateway<span class=w> </span>mygateway
<a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a>$<span class=w> </span>kubectl<span class=w> </span>delete<span class=w> </span>virtualservice<span class=w> </span>httpbin
<a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a>$<span class=w> </span>kubectl<span class=w> </span>delete<span class=w> </span>--ignore-not-found<span class=o>=</span><span class=nb>true</span><span class=w> </span>-n<span class=w> </span>istio-system<span class=w> </span>secret<span class=w> </span>httpbin-credential<span class=w> </span><span class=se>\</span>
<a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a>helloworld-credential
<a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a>$<span class=w> </span>kubectl<span class=w> </span>delete<span class=w> </span>--ignore-not-found<span class=o>=</span><span class=nb>true</span><span class=w> </span>virtualservice<span class=w> </span>helloworld-v1
</code></pre></div> <ul> <li>删除证书目录以及用于生成证书的代码库：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a>$ rm -rf httpbin.example.com helloworld-v1.example.com mtls-go-example
</code></pre></div> <ul> <li>删除用于重新部署 Ingress 网关的文件：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a>$ rm -f $HOME/istio-ingressgateway.yaml
</code></pre></div> <ul> <li>关闭 <code>httpbin</code> 和 <code>helloworld-v1</code> 服务：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a>$ kubectl delete service --ignore-not-found=true helloworld-v1
<a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a>$ kubectl delete service --ignore-not-found=true httpbin
</code></pre></div> <h5 id=egress>控制 Egress 流量<a class=headerlink href=#egress title="Permanent link">&para;</a></h5> <p>缺省情况下，Istio 服务网格内的 Pod，由于其 iptables 将所有外发流量都透明的转发给了 Sidecar，所以这些集群内的服务无法访问集群之外的 URL，而只能处理集群内部的目标。</p> <p>本文的任务描述了如何将外部服务暴露给 Istio 集群中的客户端。你将会学到如何通过定义 <a href=https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#serviceentry><code>ServiceEntry</code></a> 来调用外部服务；或者简单的对 Istio 进行配置，要求其直接放行对特定 IP 范围的访问。</p> <h6 id=_28>启动示例应用<a class=headerlink href=#_28 title="Permanent link">&para;</a></h6> <div class=highlight><pre><span></span><code><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>&lt;<span class=o>(</span>istioctl<span class=w> </span>kube-inject<span class=w> </span>-f<span class=w> </span>samples/sleep/sleep.yaml<span class=o>)</span>
</code></pre></div> <p>将 <code>SOURCE_POD</code> 环境变量设置为已部署的 <code>sleep</code> pod：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=nb>export</span><span class=w> </span><span class=nv>SOURCE_POD</span><span class=o>=</span><span class=k>$(</span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>sleep<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>={</span>.items..metadata.name<span class=o>}</span><span class=k>)</span>
</code></pre></div> <h6 id=_29>配置外部服务<a class=headerlink href=#_29 title="Permanent link">&para;</a></h6> <p>通过配置 Istio <code>ServiceEntry</code>，可以从 Istio 集群中访问任何可公开访问的服务。 这里我们会使用 <a href=http://httpbin.org/ >httpbin.org</a> 以及 <a href=https://www.google.com/ >www.google.com</a> 进行试验。</p> <ul> <li>创建一个 <code>ServiceEntry</code> 对象，放行对一个外部 HTTP 服务的访问：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=s>kind: ServiceEntry</span>
<a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=s>metadata:</span>
<a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=s>  name: httpbin-ext</span>
<a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=s>spec:</span>
<a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=s>  hosts:</span>
<a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a><span class=s>  - httpbin.org</span>
<a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a><span class=s>  ports:</span>
<a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a><span class=s>  - number: 80</span>
<a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a><span class=s>    name: http</span>
<a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a><span class=s>    protocol: HTTP</span>
<a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a><span class=s>  resolution: DNS</span>
<a id=__codelineno-71-14 name=__codelineno-71-14 href=#__codelineno-71-14></a><span class=s>  location: MESH_EXTERNAL</span>
<a id=__codelineno-71-15 name=__codelineno-71-15 href=#__codelineno-71-15></a><span class=s>EOF</span>
<a id=__codelineno-71-16 name=__codelineno-71-16 href=#__codelineno-71-16></a>
<a id=__codelineno-71-17 name=__codelineno-71-17 href=#__codelineno-71-17></a><span class=o>[</span>root@VM_0_3_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl get se</span>
<a id=__codelineno-71-18 name=__codelineno-71-18 href=#__codelineno-71-18></a>NAME<span class=w>          </span>HOSTS<span class=w>           </span>LOCATION<span class=w>        </span>RESOLUTION<span class=w>   </span>AGE
<a id=__codelineno-71-19 name=__codelineno-71-19 href=#__codelineno-71-19></a>httpbin-ext<span class=w>   </span><span class=o>[</span>httpbin.org<span class=o>]</span><span class=w>   </span>MESH_EXTERNAL<span class=w>   </span>DNS<span class=w>          </span>3s
</code></pre></div> <ul> <li>创建一个 <code>ServiceEntry</code> 以及 <code>VirtualService</code>，允许访问外部 HTTPS 服务。注意：包括 HTTPS 在内的 TLS 协议，在 <code>ServiceEntry</code> 之外，还需要创建 TLS <code>VirtualService</code>。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=nv>$SOURCE_POD</span><span class=w> </span>-c<span class=w> </span>sleep<span class=w> </span>sh
</code></pre></div> <ul> <li>向外部 HTTP 服务发出请求：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a>curl<span class=w> </span>http://httpbin.org/headers
</code></pre></div> <h6 id=https>配置外部HTTPS服务<a class=headerlink href=#https title="Permanent link">&para;</a></h6> <ul> <li>创建一个 <code>ServiceEntry</code> 以允许访问外部 HTTPS 服务。 对于 TLS 协议（包括 HTTPS），除了 <code>ServiceEntry</code> 之外，还需要 <code>VirtualService</code>。 没有 <code>VirtualService</code>, <code>ServiceEntry</code> 所暴露的服务将不被定义。<code>VirtualService</code> 必须在 <code>match</code> 子句中包含 <code>tls</code> 规则和 <code>sni_hosts</code> 以启用 SNI 路由。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=s>kind: ServiceEntry</span>
<a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=s>metadata:</span>
<a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=s>  name: google</span>
<a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=s>spec:</span>
<a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=s>  hosts:</span>
<a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a><span class=s>  - www.google.com</span>
<a id=__codelineno-74-9 name=__codelineno-74-9 href=#__codelineno-74-9></a><span class=s>  ports:</span>
<a id=__codelineno-74-10 name=__codelineno-74-10 href=#__codelineno-74-10></a><span class=s>  - number: 443</span>
<a id=__codelineno-74-11 name=__codelineno-74-11 href=#__codelineno-74-11></a><span class=s>    name: https</span>
<a id=__codelineno-74-12 name=__codelineno-74-12 href=#__codelineno-74-12></a><span class=s>    protocol: HTTPS</span>
<a id=__codelineno-74-13 name=__codelineno-74-13 href=#__codelineno-74-13></a><span class=s>  resolution: DNS</span>
<a id=__codelineno-74-14 name=__codelineno-74-14 href=#__codelineno-74-14></a><span class=s>  location: MESH_EXTERNAL</span>
<a id=__codelineno-74-15 name=__codelineno-74-15 href=#__codelineno-74-15></a><span class=s>---</span>
<a id=__codelineno-74-16 name=__codelineno-74-16 href=#__codelineno-74-16></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-74-17 name=__codelineno-74-17 href=#__codelineno-74-17></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-74-18 name=__codelineno-74-18 href=#__codelineno-74-18></a><span class=s>metadata:</span>
<a id=__codelineno-74-19 name=__codelineno-74-19 href=#__codelineno-74-19></a><span class=s>  name: google</span>
<a id=__codelineno-74-20 name=__codelineno-74-20 href=#__codelineno-74-20></a><span class=s>spec:</span>
<a id=__codelineno-74-21 name=__codelineno-74-21 href=#__codelineno-74-21></a><span class=s>  hosts:</span>
<a id=__codelineno-74-22 name=__codelineno-74-22 href=#__codelineno-74-22></a><span class=s>  - www.google.com</span>
<a id=__codelineno-74-23 name=__codelineno-74-23 href=#__codelineno-74-23></a><span class=s>  tls:</span>
<a id=__codelineno-74-24 name=__codelineno-74-24 href=#__codelineno-74-24></a><span class=s>  - match:</span>
<a id=__codelineno-74-25 name=__codelineno-74-25 href=#__codelineno-74-25></a><span class=s>    - port: 443</span>
<a id=__codelineno-74-26 name=__codelineno-74-26 href=#__codelineno-74-26></a><span class=s>      sni_hosts:</span>
<a id=__codelineno-74-27 name=__codelineno-74-27 href=#__codelineno-74-27></a><span class=s>      - www.google.com</span>
<a id=__codelineno-74-28 name=__codelineno-74-28 href=#__codelineno-74-28></a><span class=s>    route:</span>
<a id=__codelineno-74-29 name=__codelineno-74-29 href=#__codelineno-74-29></a><span class=s>    - destination:</span>
<a id=__codelineno-74-30 name=__codelineno-74-30 href=#__codelineno-74-30></a><span class=s>        host: www.google.com</span>
<a id=__codelineno-74-31 name=__codelineno-74-31 href=#__codelineno-74-31></a><span class=s>        port:</span>
<a id=__codelineno-74-32 name=__codelineno-74-32 href=#__codelineno-74-32></a><span class=s>          number: 443</span>
<a id=__codelineno-74-33 name=__codelineno-74-33 href=#__codelineno-74-33></a><span class=s>      weight: 100</span>
<a id=__codelineno-74-34 name=__codelineno-74-34 href=#__codelineno-74-34></a><span class=s>EOF</span>
<a id=__codelineno-74-35 name=__codelineno-74-35 href=#__codelineno-74-35></a>
<a id=__codelineno-74-36 name=__codelineno-74-36 href=#__codelineno-74-36></a>
<a id=__codelineno-74-37 name=__codelineno-74-37 href=#__codelineno-74-37></a><span class=c1># 测试由于网络因素，访问https的百度</span>
<a id=__codelineno-74-38 name=__codelineno-74-38 href=#__codelineno-74-38></a>
<a id=__codelineno-74-39 name=__codelineno-74-39 href=#__codelineno-74-39></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-74-40 name=__codelineno-74-40 href=#__codelineno-74-40></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-74-41 name=__codelineno-74-41 href=#__codelineno-74-41></a><span class=s>kind: ServiceEntry</span>
<a id=__codelineno-74-42 name=__codelineno-74-42 href=#__codelineno-74-42></a><span class=s>metadata:</span>
<a id=__codelineno-74-43 name=__codelineno-74-43 href=#__codelineno-74-43></a><span class=s>  name: baidu</span>
<a id=__codelineno-74-44 name=__codelineno-74-44 href=#__codelineno-74-44></a><span class=s>spec:</span>
<a id=__codelineno-74-45 name=__codelineno-74-45 href=#__codelineno-74-45></a><span class=s>  hosts:</span>
<a id=__codelineno-74-46 name=__codelineno-74-46 href=#__codelineno-74-46></a><span class=s>  - www.baidu.com</span>
<a id=__codelineno-74-47 name=__codelineno-74-47 href=#__codelineno-74-47></a><span class=s>  ports:</span>
<a id=__codelineno-74-48 name=__codelineno-74-48 href=#__codelineno-74-48></a><span class=s>  - number: 443</span>
<a id=__codelineno-74-49 name=__codelineno-74-49 href=#__codelineno-74-49></a><span class=s>    name: https</span>
<a id=__codelineno-74-50 name=__codelineno-74-50 href=#__codelineno-74-50></a><span class=s>    protocol: HTTPS</span>
<a id=__codelineno-74-51 name=__codelineno-74-51 href=#__codelineno-74-51></a><span class=s>  resolution: DNS</span>
<a id=__codelineno-74-52 name=__codelineno-74-52 href=#__codelineno-74-52></a><span class=s>  location: MESH_EXTERNAL</span>
<a id=__codelineno-74-53 name=__codelineno-74-53 href=#__codelineno-74-53></a><span class=s>---</span>
<a id=__codelineno-74-54 name=__codelineno-74-54 href=#__codelineno-74-54></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-74-55 name=__codelineno-74-55 href=#__codelineno-74-55></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-74-56 name=__codelineno-74-56 href=#__codelineno-74-56></a><span class=s>metadata:</span>
<a id=__codelineno-74-57 name=__codelineno-74-57 href=#__codelineno-74-57></a><span class=s>  name: baidu</span>
<a id=__codelineno-74-58 name=__codelineno-74-58 href=#__codelineno-74-58></a><span class=s>spec:</span>
<a id=__codelineno-74-59 name=__codelineno-74-59 href=#__codelineno-74-59></a><span class=s>  hosts:</span>
<a id=__codelineno-74-60 name=__codelineno-74-60 href=#__codelineno-74-60></a><span class=s>  - www.baidu.com</span>
<a id=__codelineno-74-61 name=__codelineno-74-61 href=#__codelineno-74-61></a><span class=s>  tls:</span>
<a id=__codelineno-74-62 name=__codelineno-74-62 href=#__codelineno-74-62></a><span class=s>  - match:</span>
<a id=__codelineno-74-63 name=__codelineno-74-63 href=#__codelineno-74-63></a><span class=s>    - port: 443</span>
<a id=__codelineno-74-64 name=__codelineno-74-64 href=#__codelineno-74-64></a><span class=s>      sni_hosts:</span>
<a id=__codelineno-74-65 name=__codelineno-74-65 href=#__codelineno-74-65></a><span class=s>      - www.baidu.com</span>
<a id=__codelineno-74-66 name=__codelineno-74-66 href=#__codelineno-74-66></a><span class=s>    route:</span>
<a id=__codelineno-74-67 name=__codelineno-74-67 href=#__codelineno-74-67></a><span class=s>    - destination:</span>
<a id=__codelineno-74-68 name=__codelineno-74-68 href=#__codelineno-74-68></a><span class=s>        host: www.baidu.com</span>
<a id=__codelineno-74-69 name=__codelineno-74-69 href=#__codelineno-74-69></a><span class=s>        port:</span>
<a id=__codelineno-74-70 name=__codelineno-74-70 href=#__codelineno-74-70></a><span class=s>          number: 443</span>
<a id=__codelineno-74-71 name=__codelineno-74-71 href=#__codelineno-74-71></a><span class=s>      weight: 100</span>
<a id=__codelineno-74-72 name=__codelineno-74-72 href=#__codelineno-74-72></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>执行 <code>sleep service</code> 源 pod：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=nv>$SOURCE_POD</span><span class=w> </span>-c<span class=w> </span>sleep<span class=w> </span>sh
</code></pre></div> <ul> <li>向外部 HTTPS 服务发出请求：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a>curl<span class=w> </span>https://www.baidu.com
</code></pre></div> <h6 id=_30>为外部服务设置路由规则<a class=headerlink href=#_30 title="Permanent link">&para;</a></h6> <p>通过 <code>ServiceEntry</code> 访问外部服务的流量，和网格内流量类似，都可以进行 Istio <a href=https://istio.io/zh/docs/concepts/traffic-management/#规则配置>路由规则</a> 的配置。下面我们使用 <a href=https://istio.io/zh/docs/reference/commands/istioctl/ ><code>istioctl</code></a> 为 httpbin.org 服务设置一个超时规则。</p> <ul> <li>在测试 Pod 内部，使用 <code>curl</code> 调用 httpbin.org 这一外部服务的 <code>/delay</code> 端点：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=nv>$SOURCE_POD</span><span class=w> </span>-c<span class=w> </span>sleep<span class=w> </span>sh
<a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=nb>time</span><span class=w> </span>curl<span class=w> </span>-o<span class=w> </span>/dev/null<span class=w> </span>-s<span class=w> </span>-w<span class=w> </span><span class=s2>&quot;%{http_code}\n&quot;</span><span class=w> </span>http://httpbin.org/delay/5
</code></pre></div> <p>这个请求会在大概五秒钟左右返回一个内容为 <code>200 (OK)</code> 的响应。</p> <ul> <li>退出测试 Pod，使用 <code>kubectl</code> 为 httpbin.org 外部服务的访问设置一个 3 秒钟的超时：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-78-4 name=__codelineno-78-4 href=#__codelineno-78-4></a><span class=s>metadata:</span>
<a id=__codelineno-78-5 name=__codelineno-78-5 href=#__codelineno-78-5></a><span class=s>  name: httpbin-ext</span>
<a id=__codelineno-78-6 name=__codelineno-78-6 href=#__codelineno-78-6></a><span class=s>spec:</span>
<a id=__codelineno-78-7 name=__codelineno-78-7 href=#__codelineno-78-7></a><span class=s>  hosts:</span>
<a id=__codelineno-78-8 name=__codelineno-78-8 href=#__codelineno-78-8></a><span class=s>    - httpbin.org</span>
<a id=__codelineno-78-9 name=__codelineno-78-9 href=#__codelineno-78-9></a><span class=s>  http:</span>
<a id=__codelineno-78-10 name=__codelineno-78-10 href=#__codelineno-78-10></a><span class=s>  - timeout: 3s</span>
<a id=__codelineno-78-11 name=__codelineno-78-11 href=#__codelineno-78-11></a><span class=s>    route:</span>
<a id=__codelineno-78-12 name=__codelineno-78-12 href=#__codelineno-78-12></a><span class=s>      - destination:</span>
<a id=__codelineno-78-13 name=__codelineno-78-13 href=#__codelineno-78-13></a><span class=s>          host: httpbin.org</span>
<a id=__codelineno-78-14 name=__codelineno-78-14 href=#__codelineno-78-14></a><span class=s>        weight: 100</span>
<a id=__codelineno-78-15 name=__codelineno-78-15 href=#__codelineno-78-15></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>等待几秒钟之后，再次发起 <em>curl</em> 请求：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a>$<span class=w> </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=nv>$SOURCE_POD</span><span class=w> </span>-c<span class=w> </span>sleep<span class=w> </span>sh
<a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a>$<span class=w> </span><span class=nb>time</span><span class=w> </span>curl<span class=w> </span>-o<span class=w> </span>/dev/null<span class=w> </span>-s<span class=w> </span>-w<span class=w> </span><span class=s2>&quot;%{http_code}\n&quot;</span><span class=w> </span>http://httpbin.org/delay/5
</code></pre></div> <p>这一次会在 3 秒钟之后收到一个内容为 <code>504 (Gateway Timeout)</code> 的响应。虽然 httpbin.org 还在等待他的 5 秒钟，Istio 却在 3 秒钟的时候切断了请求。</p> <h6 id=_31>直接调用外部服务<a class=headerlink href=#_31 title="Permanent link">&para;</a></h6> <p>如果想要跳过 Istio，直接访问某个 IP 范围内的外部服务，就需要对 Envoy sidecar 进行配置，阻止 Envoy 对外部请求的<a href=https://istio.io/zh/docs/concepts/traffic-management/#服务之间的通讯>劫持</a>。可以在 <a href=https://istio.io/zh/docs/reference/config/installation-options/ >Helm</a> 中设置 <code>global.proxy.includeIPRanges</code> 变量，然后使用 <code>kubectl apply</code> 命令来更新名为 <code>istio-sidecar-injector</code> 的 <code>Configmap</code>。在 <code>istio-sidecar-injector</code> 更新之后，<code>global.proxy.includeIPRanges</code> 会在所有未来部署的 Pod 中生效。</p> <p>使用 <code>global.proxy.includeIPRanges</code> 变量的最简单方式就是把内部服务的 IP 地址范围传递给它，这样就在 Sidecar proxy 的重定向列表中排除掉了外部服务的地址了。</p> <p>内部服务的 IP 范围取决于集群的部署情况。例如 Minikube 中这一范围是 <code>10.0.0.1/24</code>，这个配置中，就应该这样更新 <code>istio-sidecar-injector</code>：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a>helm<span class=w> </span>template<span class=w> </span>install/kubernetes/helm/istio<span class=w> </span>&lt;安装<span class=w> </span>Istio<span class=w> </span>时所使用的参数&gt;<span class=w> </span>--set<span class=w> </span>global.proxy.includeIPRanges<span class=o>=</span><span class=s2>&quot;10.0.0.1/24&quot;</span><span class=w> </span>-x<span class=w> </span>templates/sidecar-injector-configmap.yaml<span class=w> </span><span class=p>|</span><span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-
</code></pre></div> <p>注意这里应该使用和之前部署 Istio 的时候同样的 <a href=https://istio.io/zh/docs/setup/kubernetes/install/helm>Helm 命令</a>，尤其是 <code>--namespace</code> 参数。在安装 Istio 原有命令的基础之上，加入 <code>--set global.proxy.includeIPRanges="10.0.0.1/24" -x templates/sidecar-injector-configmap.yaml</code> 即可。</p> <p><a href=https://istio.io/zh/docs/tasks/traffic-management/egress/#开始之前>和前面一样</a>，重新部署 <code>sleep</code> 应用。</p> <p>确保已删除之前部署的 <code>ServiceEntry</code> 和 <code>VirtualService</code>。</p> <h6 id=_32>理解原理<a class=headerlink href=#_32 title="Permanent link">&para;</a></h6> <p>这个任务中，我们使用两种方式从 Istio 服务网格内部来完成对外部服务的调用：</p> <ol> <li>使用 <code>ServiceEntry</code> (推荐方式)</li> <li>配置 Istio sidecar，从它的重定向 IP 表中排除外部服务的 IP 范围</li> </ol> <p>第一种方式（<code>ServiceEntry</code>）中，网格内部的服务不论是访问内部还是外部的服务，都可以使用同样的 Istio 服务网格的特性。我们通过为外部服务访问设置超时规则的例子，来证实了这一优势。</p> <p>第二种方式越过了 Istio sidecar proxy，让服务直接访问到对应的外部地址。然而要进行这种配置，需要了解云供应商特定的知识和配置。</p> <h6 id=_33>清理<a class=headerlink href=#_33 title="Permanent link">&para;</a></h6> <ul> <li>删除规则：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a>$ kubectl delete serviceentry httpbin-ext google
<a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a>$ kubectl delete virtualservice httpbin-ext google
</code></pre></div> <ul> <li>停止 <a href=https://github.com/istio/istio/tree/release-1.2/samples/sleep>sleep</a> 服务：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a>$ kubectl delete -f samples/sleep/sleep.yaml
</code></pre></div> <ul> <li>更新 <code>ConfigMap</code> <code>istio-sidecar-injector</code>，要求 Sidecar 转发所有外发流量：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a>$ helm template install/kubernetes/helm/istio &lt;安装 Istio 时所使用的参数&gt; -x templates/sidecar-injector-configmap.yaml | kubectl apply -f -
</code></pre></div> <h5 id=_34>熔断<a class=headerlink href=#_34 title="Permanent link">&para;</a></h5> <p>本任务展示了用连接、请求以及外部检测来进行熔断配置的过程。</p> <p>断路器是创建弹性微服务应用程序的重要模式。断路器允许您编写限制故障、延迟峰值以及其他不良网络特性影响的应用程序。</p> <p>在此任务中，您将配置断路器规则，然后通过故意“跳闸”断路器来测试配置。</p> <p>启动应用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>&lt;<span class=o>(</span>istioctl<span class=w> </span>kube-inject<span class=w> </span>-f<span class=w> </span>samples/httpbin/httpbin.yaml<span class=o>)</span>
</code></pre></div> <h6 id=_35>断路器<a class=headerlink href=#_35 title="Permanent link">&para;</a></h6> <ul> <li>创建一个 <a href=https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#destinationrule>目标规则</a>，针对 <code>httpbin</code> 服务设置断路器：</li> </ul> <p>如果您的 Istio 启用了双向 TLS 身份验证，则必须在应用之前将 TLS 流量策略 <code>mode：ISTIO_MUTUAL</code> 添加到 <code>DestinationRule</code>。否则请求将产生 503 错误，如<a href=https://istio.io/zh/docs/ops/traffic-management/troubleshooting/#设置目标规则后出现-503-错误>设置目标规则后出现 503 错误</a>所述。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a><span class=s>kind: DestinationRule</span>
<a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a><span class=s>metadata:</span>
<a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a><span class=s>  name: httpbin</span>
<a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a><span class=s>spec:</span>
<a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=s>  host: httpbin</span>
<a id=__codelineno-85-8 name=__codelineno-85-8 href=#__codelineno-85-8></a><span class=s>  trafficPolicy:</span>
<a id=__codelineno-85-9 name=__codelineno-85-9 href=#__codelineno-85-9></a><span class=s>    connectionPool:</span>
<a id=__codelineno-85-10 name=__codelineno-85-10 href=#__codelineno-85-10></a><span class=s>      tcp:</span>
<a id=__codelineno-85-11 name=__codelineno-85-11 href=#__codelineno-85-11></a><span class=s>        maxConnections: 1</span>
<a id=__codelineno-85-12 name=__codelineno-85-12 href=#__codelineno-85-12></a><span class=s>      http:</span>
<a id=__codelineno-85-13 name=__codelineno-85-13 href=#__codelineno-85-13></a><span class=s>        http1MaxPendingRequests: 1</span>
<a id=__codelineno-85-14 name=__codelineno-85-14 href=#__codelineno-85-14></a><span class=s>        maxRequestsPerConnection: 1</span>
<a id=__codelineno-85-15 name=__codelineno-85-15 href=#__codelineno-85-15></a><span class=s>    outlierDetection:</span>
<a id=__codelineno-85-16 name=__codelineno-85-16 href=#__codelineno-85-16></a><span class=s>      consecutiveErrors: 1</span>
<a id=__codelineno-85-17 name=__codelineno-85-17 href=#__codelineno-85-17></a><span class=s>      interval: 1s</span>
<a id=__codelineno-85-18 name=__codelineno-85-18 href=#__codelineno-85-18></a><span class=s>      baseEjectionTime: 3m</span>
<a id=__codelineno-85-19 name=__codelineno-85-19 href=#__codelineno-85-19></a><span class=s>      maxEjectionPercent: 100</span>
<a id=__codelineno-85-20 name=__codelineno-85-20 href=#__codelineno-85-20></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>检查我们的目标规则，确定已经正确建立：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a>kubectl<span class=w> </span>get<span class=w> </span>destinationrule<span class=w> </span>httpbin<span class=w> </span>-o<span class=w> </span>yaml
<a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a>apiVersion:<span class=w> </span>networking.istio.io/v1alpha3
<a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a>kind:<span class=w> </span>DestinationRule
<a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a>metadata:
<a id=__codelineno-86-5 name=__codelineno-86-5 href=#__codelineno-86-5></a><span class=w>  </span>name:<span class=w> </span>httpbin
<a id=__codelineno-86-6 name=__codelineno-86-6 href=#__codelineno-86-6></a><span class=w>  </span>...
<a id=__codelineno-86-7 name=__codelineno-86-7 href=#__codelineno-86-7></a>spec:
<a id=__codelineno-86-8 name=__codelineno-86-8 href=#__codelineno-86-8></a><span class=w>  </span>host:<span class=w> </span>httpbin
<a id=__codelineno-86-9 name=__codelineno-86-9 href=#__codelineno-86-9></a><span class=w>  </span>trafficPolicy:
<a id=__codelineno-86-10 name=__codelineno-86-10 href=#__codelineno-86-10></a><span class=w>    </span>connectionPool:
<a id=__codelineno-86-11 name=__codelineno-86-11 href=#__codelineno-86-11></a><span class=w>      </span>http:
<a id=__codelineno-86-12 name=__codelineno-86-12 href=#__codelineno-86-12></a><span class=w>        </span>http1MaxPendingRequests:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-86-13 name=__codelineno-86-13 href=#__codelineno-86-13></a><span class=w>        </span>maxRequestsPerConnection:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-86-14 name=__codelineno-86-14 href=#__codelineno-86-14></a><span class=w>      </span>tcp:
<a id=__codelineno-86-15 name=__codelineno-86-15 href=#__codelineno-86-15></a><span class=w>        </span>maxConnections:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-86-16 name=__codelineno-86-16 href=#__codelineno-86-16></a><span class=w>    </span>outlierDetection:
<a id=__codelineno-86-17 name=__codelineno-86-17 href=#__codelineno-86-17></a><span class=w>      </span>baseEjectionTime:<span class=w> </span><span class=m>180</span>.000s
<a id=__codelineno-86-18 name=__codelineno-86-18 href=#__codelineno-86-18></a><span class=w>      </span>consecutiveErrors:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-86-19 name=__codelineno-86-19 href=#__codelineno-86-19></a><span class=w>      </span>interval:<span class=w> </span><span class=m>1</span>.000s
<a id=__codelineno-86-20 name=__codelineno-86-20 href=#__codelineno-86-20></a><span class=w>      </span>maxEjectionPercent:<span class=w> </span><span class=m>100</span>
</code></pre></div> <h6 id=_36>设置客户端<a class=headerlink href=#_36 title="Permanent link">&para;</a></h6> <p>现在我们已经设置了调用 <code>httpbin</code> 服务的规则，接下来创建一个客户端，用来向后端服务发送请求，观察是否会触发熔断策略。这里要使用一个简单的负载测试客户端，名字叫 <a href=https://github.com/istio/fortio>fortio</a>。这个客户端可以控制连接数量、并发数以及发送 HTTP 请求的延迟。使用这一客户端，能够有效的触发前面在目标规则中设置的熔断策略。</p> <ul> <li>这里我们会把给客户端也进行 Sidecar 的注入，以此保证 Istio 对网络交互的控制：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a>kubectl apply -f &lt;(istioctl kube-inject -f samples/httpbin/sample-client/fortio-deploy.yaml)
</code></pre></div> <ul> <li>接下来就可以登入客户端 Pod 并使用 Fortio 工具来调用 <code>httpbin</code>。<code>-curl</code> 参数表明只调用一次：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a>$ FORTIO_POD=$(kubectl get pod | grep fortio | awk &#39;{ print $1 }&#39;)
<a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a>$ kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -curl  http://httpbin:8000/get
<a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a>
<a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a>HTTP/1.1 200 OK
<a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a>server: envoy
<a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a>date: Tue, 16 Jan 2018 23:47:00 GMT
<a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a>content-type: application/json
<a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a>access-control-allow-origin: *
<a id=__codelineno-88-9 name=__codelineno-88-9 href=#__codelineno-88-9></a>access-control-allow-credentials: true
<a id=__codelineno-88-10 name=__codelineno-88-10 href=#__codelineno-88-10></a>content-length: 445
<a id=__codelineno-88-11 name=__codelineno-88-11 href=#__codelineno-88-11></a>x-envoy-upstream-service-time: 36
<a id=__codelineno-88-12 name=__codelineno-88-12 href=#__codelineno-88-12></a>
<a id=__codelineno-88-13 name=__codelineno-88-13 href=#__codelineno-88-13></a>{
<a id=__codelineno-88-14 name=__codelineno-88-14 href=#__codelineno-88-14></a>  &quot;args&quot;: {},
<a id=__codelineno-88-15 name=__codelineno-88-15 href=#__codelineno-88-15></a>  &quot;headers&quot;: {
<a id=__codelineno-88-16 name=__codelineno-88-16 href=#__codelineno-88-16></a>    &quot;Content-Length&quot;: &quot;0&quot;,
<a id=__codelineno-88-17 name=__codelineno-88-17 href=#__codelineno-88-17></a>    &quot;Host&quot;: &quot;httpbin:8000&quot;,
<a id=__codelineno-88-18 name=__codelineno-88-18 href=#__codelineno-88-18></a>    &quot;User-Agent&quot;: &quot;istio/fortio-0.6.2&quot;,
<a id=__codelineno-88-19 name=__codelineno-88-19 href=#__codelineno-88-19></a>    &quot;X-B3-Sampled&quot;: &quot;1&quot;,
<a id=__codelineno-88-20 name=__codelineno-88-20 href=#__codelineno-88-20></a>    &quot;X-B3-Spanid&quot;: &quot;824fbd828d809bf4&quot;,
<a id=__codelineno-88-21 name=__codelineno-88-21 href=#__codelineno-88-21></a>    &quot;X-B3-Traceid&quot;: &quot;824fbd828d809bf4&quot;,
<a id=__codelineno-88-22 name=__codelineno-88-22 href=#__codelineno-88-22></a>    &quot;X-Ot-Span-Context&quot;: &quot;824fbd828d809bf4;824fbd828d809bf4;0000000000000000&quot;,
<a id=__codelineno-88-23 name=__codelineno-88-23 href=#__codelineno-88-23></a>    &quot;X-Request-Id&quot;: &quot;1ad2de20-806e-9622-949a-bd1d9735a3f4&quot;
<a id=__codelineno-88-24 name=__codelineno-88-24 href=#__codelineno-88-24></a>  },
<a id=__codelineno-88-25 name=__codelineno-88-25 href=#__codelineno-88-25></a>  &quot;origin&quot;: &quot;127.0.0.1&quot;,
<a id=__codelineno-88-26 name=__codelineno-88-26 href=#__codelineno-88-26></a>  &quot;url&quot;: &quot;http://httpbin:8000/get&quot;
<a id=__codelineno-88-27 name=__codelineno-88-27 href=#__codelineno-88-27></a>}
</code></pre></div> <p>不难看出，调用已经成功。接下来做些变化。</p> <h6 id=_37>触发熔断机制<a class=headerlink href=#_37 title="Permanent link">&para;</a></h6> <p>在上面的熔断设置中指定了 <code>maxConnections: 1</code> 以及 <code>http1MaxPendingRequests: 1</code>。这意味着如果超过了一个连接同时发起请求，Istio 就会熔断，阻止后续的请求或连接。</p> <ul> <li>接下来尝试一下两个并发连接（<code>-c 2</code>），发送 20 请求（<code>-n 20</code>）：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=nv>$FORTIO_POD</span><span class=w>  </span>-c<span class=w> </span>fortio<span class=w> </span>/usr/bin/fortio<span class=w> </span>--<span class=w> </span>load<span class=w> </span>-c<span class=w> </span><span class=m>2</span><span class=w> </span>-qps<span class=w> </span><span class=m>0</span><span class=w> </span>-n<span class=w> </span><span class=m>20</span><span class=w> </span>-loglevel<span class=w> </span>Warning<span class=w> </span>http://httpbin:8000/get
<a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a>
<a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a><span class=o>[</span>root@VM_0_3_centos<span class=w> </span>istio-1.2.2<span class=o>]</span><span class=c1># kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a><span class=m>10</span>:31:28<span class=w> </span>I<span class=w> </span>logger.go:97&gt;<span class=w> </span>Log<span class=w> </span>level<span class=w> </span>is<span class=w> </span>now<span class=w> </span><span class=m>3</span><span class=w> </span>Warning<span class=w> </span><span class=o>(</span>was<span class=w> </span><span class=m>2</span><span class=w> </span>Info<span class=o>)</span>
<a id=__codelineno-89-5 name=__codelineno-89-5 href=#__codelineno-89-5></a>Fortio<span class=w> </span><span class=m>1</span>.3.1<span class=w> </span>running<span class=w> </span>at<span class=w> </span><span class=m>0</span><span class=w> </span>queries<span class=w> </span>per<span class=w> </span>second,<span class=w> </span><span class=m>2</span>-&gt;2<span class=w> </span>procs,<span class=w> </span><span class=k>for</span><span class=w> </span><span class=m>20</span><span class=w> </span>calls:<span class=w> </span>http://httpbin:8000/get
<a id=__codelineno-89-6 name=__codelineno-89-6 href=#__codelineno-89-6></a>Starting<span class=w> </span>at<span class=w> </span>max<span class=w> </span>qps<span class=w> </span>with<span class=w> </span><span class=m>2</span><span class=w> </span>thread<span class=o>(</span>s<span class=o>)</span><span class=w> </span><span class=o>[</span>gomax<span class=w> </span><span class=m>2</span><span class=o>]</span><span class=w> </span><span class=k>for</span><span class=w> </span>exactly<span class=w> </span><span class=m>20</span><span class=w> </span>calls<span class=w> </span><span class=o>(</span><span class=m>10</span><span class=w> </span>per<span class=w> </span>thread<span class=w> </span>+<span class=w> </span><span class=m>0</span><span class=o>)</span>
<a id=__codelineno-89-7 name=__codelineno-89-7 href=#__codelineno-89-7></a><span class=m>10</span>:31:28<span class=w> </span>W<span class=w> </span>http_client.go:679&gt;<span class=w> </span>Parsed<span class=w> </span>non<span class=w> </span>ok<span class=w> </span>code<span class=w> </span><span class=m>503</span><span class=w> </span><span class=o>(</span>HTTP/1.1<span class=w> </span><span class=m>503</span><span class=o>)</span>
<a id=__codelineno-89-8 name=__codelineno-89-8 href=#__codelineno-89-8></a>Ended<span class=w> </span>after<span class=w> </span><span class=m>37</span>.04095ms<span class=w> </span>:<span class=w> </span><span class=m>20</span><span class=w> </span>calls.<span class=w> </span><span class=nv>qps</span><span class=o>=</span><span class=m>539</span>.94
<a id=__codelineno-89-9 name=__codelineno-89-9 href=#__codelineno-89-9></a>Aggregated<span class=w> </span>Function<span class=w> </span>Time<span class=w> </span>:<span class=w> </span>count<span class=w> </span><span class=m>20</span><span class=w> </span>avg<span class=w> </span><span class=m>0</span>.0035982768<span class=w> </span>+/-<span class=w> </span><span class=m>0</span>.001634<span class=w> </span>min<span class=w> </span><span class=m>0</span>.001340763<span class=w> </span>max<span class=w> </span><span class=m>0</span>.006110438<span class=w> </span>sum<span class=w> </span><span class=m>0</span>.071965536
<a id=__codelineno-89-10 name=__codelineno-89-10 href=#__codelineno-89-10></a><span class=c1># range, mid point, percentile, count</span>
<a id=__codelineno-89-11 name=__codelineno-89-11 href=#__codelineno-89-11></a>&gt;<span class=o>=</span><span class=w> </span><span class=m>0</span>.00134076<span class=w> </span>&lt;<span class=o>=</span><span class=w> </span><span class=m>0</span>.002<span class=w> </span>,<span class=w> </span><span class=m>0</span>.00167038<span class=w> </span>,<span class=w> </span><span class=m>25</span>.00,<span class=w> </span><span class=m>5</span>
<a id=__codelineno-89-12 name=__codelineno-89-12 href=#__codelineno-89-12></a>&gt;<span class=w> </span><span class=m>0</span>.002<span class=w> </span>&lt;<span class=o>=</span><span class=w> </span><span class=m>0</span>.003<span class=w> </span>,<span class=w> </span><span class=m>0</span>.0025<span class=w> </span>,<span class=w> </span><span class=m>45</span>.00,<span class=w> </span><span class=m>4</span>
<a id=__codelineno-89-13 name=__codelineno-89-13 href=#__codelineno-89-13></a>&gt;<span class=w> </span><span class=m>0</span>.003<span class=w> </span>&lt;<span class=o>=</span><span class=w> </span><span class=m>0</span>.004<span class=w> </span>,<span class=w> </span><span class=m>0</span>.0035<span class=w> </span>,<span class=w> </span><span class=m>55</span>.00,<span class=w> </span><span class=m>2</span>
<a id=__codelineno-89-14 name=__codelineno-89-14 href=#__codelineno-89-14></a>&gt;<span class=w> </span><span class=m>0</span>.004<span class=w> </span>&lt;<span class=o>=</span><span class=w> </span><span class=m>0</span>.005<span class=w> </span>,<span class=w> </span><span class=m>0</span>.0045<span class=w> </span>,<span class=w> </span><span class=m>65</span>.00,<span class=w> </span><span class=m>2</span>
<a id=__codelineno-89-15 name=__codelineno-89-15 href=#__codelineno-89-15></a>&gt;<span class=w> </span><span class=m>0</span>.005<span class=w> </span>&lt;<span class=o>=</span><span class=w> </span><span class=m>0</span>.006<span class=w> </span>,<span class=w> </span><span class=m>0</span>.0055<span class=w> </span>,<span class=w> </span><span class=m>90</span>.00,<span class=w> </span><span class=m>5</span>
<a id=__codelineno-89-16 name=__codelineno-89-16 href=#__codelineno-89-16></a>&gt;<span class=w> </span><span class=m>0</span>.006<span class=w> </span>&lt;<span class=o>=</span><span class=w> </span><span class=m>0</span>.00611044<span class=w> </span>,<span class=w> </span><span class=m>0</span>.00605522<span class=w> </span>,<span class=w> </span><span class=m>100</span>.00,<span class=w> </span><span class=m>2</span>
<a id=__codelineno-89-17 name=__codelineno-89-17 href=#__codelineno-89-17></a><span class=c1># target 50% 0.0035</span>
<a id=__codelineno-89-18 name=__codelineno-89-18 href=#__codelineno-89-18></a><span class=c1># target 75% 0.0054</span>
<a id=__codelineno-89-19 name=__codelineno-89-19 href=#__codelineno-89-19></a><span class=c1># target 90% 0.006</span>
<a id=__codelineno-89-20 name=__codelineno-89-20 href=#__codelineno-89-20></a><span class=c1># target 99% 0.00609939</span>
<a id=__codelineno-89-21 name=__codelineno-89-21 href=#__codelineno-89-21></a><span class=c1># target 99.9% 0.00610933</span>
<a id=__codelineno-89-22 name=__codelineno-89-22 href=#__codelineno-89-22></a>Sockets<span class=w> </span>used:<span class=w> </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=k>for</span><span class=w> </span>perfect<span class=w> </span>keepalive,<span class=w> </span>would<span class=w> </span>be<span class=w> </span><span class=m>2</span><span class=o>)</span>
<a id=__codelineno-89-23 name=__codelineno-89-23 href=#__codelineno-89-23></a>Code<span class=w> </span><span class=m>200</span><span class=w> </span>:<span class=w> </span><span class=m>19</span><span class=w> </span><span class=o>(</span><span class=m>95</span>.0<span class=w> </span>%<span class=o>)</span>
<a id=__codelineno-89-24 name=__codelineno-89-24 href=#__codelineno-89-24></a>Code<span class=w> </span><span class=m>503</span><span class=w> </span>:<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span><span class=m>5</span>.0<span class=w> </span>%<span class=o>)</span>
<a id=__codelineno-89-25 name=__codelineno-89-25 href=#__codelineno-89-25></a>Response<span class=w> </span>Header<span class=w> </span>Sizes<span class=w> </span>:<span class=w> </span>count<span class=w> </span><span class=m>20</span><span class=w> </span>avg<span class=w> </span><span class=m>291</span>.65<span class=w> </span>+/-<span class=w> </span><span class=m>66</span>.91<span class=w> </span>min<span class=w> </span><span class=m>0</span><span class=w> </span>max<span class=w> </span><span class=m>307</span><span class=w> </span>sum<span class=w> </span><span class=m>5833</span>
<a id=__codelineno-89-26 name=__codelineno-89-26 href=#__codelineno-89-26></a>Response<span class=w> </span>Body/Total<span class=w> </span>Sizes<span class=w> </span>:<span class=w> </span>count<span class=w> </span><span class=m>20</span><span class=w> </span>avg<span class=w> </span><span class=m>616</span>.3<span class=w> </span>+/-<span class=w> </span><span class=m>68</span>.43<span class=w> </span>min<span class=w> </span><span class=m>318</span><span class=w> </span>max<span class=w> </span><span class=m>632</span><span class=w> </span>sum<span class=w> </span><span class=m>12326</span>
<a id=__codelineno-89-27 name=__codelineno-89-27 href=#__codelineno-89-27></a>All<span class=w> </span><span class=k>done</span><span class=w> </span><span class=m>20</span><span class=w> </span>calls<span class=w> </span><span class=o>(</span>plus<span class=w> </span><span class=m>0</span><span class=w> </span>warmup<span class=o>)</span><span class=w> </span><span class=m>3</span>.598<span class=w> </span>ms<span class=w> </span>avg,<span class=w> </span><span class=m>539</span>.9<span class=w> </span>qps
</code></pre></div> <ul> <li>接下来把并发连接数量提高到 3：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=nv>$FORTIO_POD</span><span class=w>  </span>-c<span class=w> </span>fortio<span class=w> </span>/usr/bin/fortio<span class=w> </span>--<span class=w> </span>load<span class=w> </span>-c<span class=w> </span><span class=m>3</span><span class=w> </span>-qps<span class=w> </span><span class=m>0</span><span class=w> </span>-n<span class=w> </span><span class=m>30</span><span class=w> </span>-loglevel<span class=w> </span>Warning<span class=w> </span>http://httpbin:8000/get
<a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a>
<a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a><span class=c1>#这时候会观察到，熔断行为按照之前的设计生效了，只有 63.3% 的请求获得通过，剩余请求被断路器拦截了：</span>
<a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a>Code<span class=w> </span><span class=m>200</span><span class=w> </span>:<span class=w> </span><span class=m>19</span><span class=w> </span><span class=o>(</span><span class=m>63</span>.3<span class=w> </span>%<span class=o>)</span>
<a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a>Code<span class=w> </span><span class=m>503</span><span class=w> </span>:<span class=w> </span><span class=m>11</span><span class=w> </span><span class=o>(</span><span class=m>36</span>.7<span class=w> </span>%<span class=o>)</span>
</code></pre></div> <ul> <li>我们可以查询 <code>istio-proxy</code> 的状态，获取更多相关信息：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a>$<span class=w> </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=nv>$FORTIO_POD</span><span class=w>  </span>-c<span class=w> </span>istio-proxy<span class=w>  </span>--<span class=w> </span>sh<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;curl localhost:15000/stats&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>httpbin<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>pending
<a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a>cluster.outbound<span class=p>|</span><span class=m>80</span><span class=o>||</span>httpbin.springistio.svc.cluster.local.upstream_rq_pending_active:<span class=w> </span><span class=m>0</span>
<a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a>cluster.outbound<span class=p>|</span><span class=m>80</span><span class=o>||</span>httpbin.springistio.svc.cluster.local.upstream_rq_pending_failure_eject:<span class=w> </span><span class=m>0</span>
<a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a>cluster.outbound<span class=p>|</span><span class=m>80</span><span class=o>||</span>httpbin.springistio.svc.cluster.local.upstream_rq_pending_overflow:<span class=w> </span><span class=m>12</span>
<a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a>cluster.outbound<span class=p>|</span><span class=m>80</span><span class=o>||</span>httpbin.springistio.svc.cluster.local.upstream_rq_pending_total:<span class=w> </span><span class=m>39</span>
</code></pre></div> <p><code>upstream_rq_pending_overflow</code> 的值是 <code>12</code>，说明有 <code>12</code> 次调用被标志为熔断。</p> <h6 id=_38>清理<a class=headerlink href=#_38 title="Permanent link">&para;</a></h6> <ul> <li>清理规则：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a>$ kubectl delete destinationrule httpbin
</code></pre></div> <ul> <li>关闭 <a href=https://github.com/istio/istio/tree/release-1.2/samples/httpbin>httpbin</a> 服务和客户端：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a>$ kubectl delete deploy httpbin fortio-deploy
<a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a>$ kubectl delete svc httpbin
</code></pre></div> <h5 id=_39>镜像<a class=headerlink href=#_39 title="Permanent link">&para;</a></h5> <p>此任务演示了 Istio 的流量镜像功能。</p> <p>流量镜像，也称为影子流量，是一个以尽可能低的风险为生产带来变化的强大的功能。镜像会将实时流量的副本发送到镜像服务。镜像流量发生在主服务的关键请求路径之外。</p> <p>在此任务中，首先把所有流量路由到 <code>v1</code> 测试服务。然后使用规则将一部分流量镜像到 <code>v2</code>。</p> <h6 id=_40>启动示例应用<a class=headerlink href=#_40 title="Permanent link">&para;</a></h6> <p>按照<a href=https://istio.io/zh/docs/setup/ >安装指南</a>中的说明设置 Istio。</p> <p>首先部署启用了访问日志的两个版本的 <a href=https://github.com/istio/istio/tree/release-1.2/samples/httpbin>httpbin</a> 服务：</p> <p><strong>httpbin-v1:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | istioctl kube-inject -f - | kubectl create -f -</span>
<a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a><span class=s>apiVersion: extensions/v1beta1</span>
<a id=__codelineno-94-3 name=__codelineno-94-3 href=#__codelineno-94-3></a><span class=s>kind: Deployment</span>
<a id=__codelineno-94-4 name=__codelineno-94-4 href=#__codelineno-94-4></a><span class=s>metadata:</span>
<a id=__codelineno-94-5 name=__codelineno-94-5 href=#__codelineno-94-5></a><span class=s>  name: httpbin-v1</span>
<a id=__codelineno-94-6 name=__codelineno-94-6 href=#__codelineno-94-6></a><span class=s>spec:</span>
<a id=__codelineno-94-7 name=__codelineno-94-7 href=#__codelineno-94-7></a><span class=s>  replicas: 1</span>
<a id=__codelineno-94-8 name=__codelineno-94-8 href=#__codelineno-94-8></a><span class=s>  template:</span>
<a id=__codelineno-94-9 name=__codelineno-94-9 href=#__codelineno-94-9></a><span class=s>    metadata:</span>
<a id=__codelineno-94-10 name=__codelineno-94-10 href=#__codelineno-94-10></a><span class=s>      labels:</span>
<a id=__codelineno-94-11 name=__codelineno-94-11 href=#__codelineno-94-11></a><span class=s>        app: httpbin</span>
<a id=__codelineno-94-12 name=__codelineno-94-12 href=#__codelineno-94-12></a><span class=s>        version: v1</span>
<a id=__codelineno-94-13 name=__codelineno-94-13 href=#__codelineno-94-13></a><span class=s>    spec:</span>
<a id=__codelineno-94-14 name=__codelineno-94-14 href=#__codelineno-94-14></a><span class=s>      containers:</span>
<a id=__codelineno-94-15 name=__codelineno-94-15 href=#__codelineno-94-15></a><span class=s>      - image: docker.io/kennethreitz/httpbin</span>
<a id=__codelineno-94-16 name=__codelineno-94-16 href=#__codelineno-94-16></a><span class=s>        imagePullPolicy: IfNotPresent</span>
<a id=__codelineno-94-17 name=__codelineno-94-17 href=#__codelineno-94-17></a><span class=s>        name: httpbin</span>
<a id=__codelineno-94-18 name=__codelineno-94-18 href=#__codelineno-94-18></a><span class=s>        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]</span>
<a id=__codelineno-94-19 name=__codelineno-94-19 href=#__codelineno-94-19></a><span class=s>        ports:</span>
<a id=__codelineno-94-20 name=__codelineno-94-20 href=#__codelineno-94-20></a><span class=s>        - containerPort: 80</span>
<a id=__codelineno-94-21 name=__codelineno-94-21 href=#__codelineno-94-21></a><span class=s>EOF</span>
</code></pre></div> <p><strong>httpbin-v2:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | istioctl kube-inject -f - | kubectl create -f -</span>
<a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=s>apiVersion: extensions/v1beta1</span>
<a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a><span class=s>kind: Deployment</span>
<a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a><span class=s>metadata:</span>
<a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a><span class=s>  name: httpbin-v2</span>
<a id=__codelineno-95-6 name=__codelineno-95-6 href=#__codelineno-95-6></a><span class=s>spec:</span>
<a id=__codelineno-95-7 name=__codelineno-95-7 href=#__codelineno-95-7></a><span class=s>  replicas: 1</span>
<a id=__codelineno-95-8 name=__codelineno-95-8 href=#__codelineno-95-8></a><span class=s>  template:</span>
<a id=__codelineno-95-9 name=__codelineno-95-9 href=#__codelineno-95-9></a><span class=s>    metadata:</span>
<a id=__codelineno-95-10 name=__codelineno-95-10 href=#__codelineno-95-10></a><span class=s>      labels:</span>
<a id=__codelineno-95-11 name=__codelineno-95-11 href=#__codelineno-95-11></a><span class=s>        app: httpbin</span>
<a id=__codelineno-95-12 name=__codelineno-95-12 href=#__codelineno-95-12></a><span class=s>        version: v2</span>
<a id=__codelineno-95-13 name=__codelineno-95-13 href=#__codelineno-95-13></a><span class=s>    spec:</span>
<a id=__codelineno-95-14 name=__codelineno-95-14 href=#__codelineno-95-14></a><span class=s>      containers:</span>
<a id=__codelineno-95-15 name=__codelineno-95-15 href=#__codelineno-95-15></a><span class=s>      - image: docker.io/kennethreitz/httpbin</span>
<a id=__codelineno-95-16 name=__codelineno-95-16 href=#__codelineno-95-16></a><span class=s>        imagePullPolicy: IfNotPresent</span>
<a id=__codelineno-95-17 name=__codelineno-95-17 href=#__codelineno-95-17></a><span class=s>        name: httpbin</span>
<a id=__codelineno-95-18 name=__codelineno-95-18 href=#__codelineno-95-18></a><span class=s>        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]</span>
<a id=__codelineno-95-19 name=__codelineno-95-19 href=#__codelineno-95-19></a><span class=s>        ports:</span>
<a id=__codelineno-95-20 name=__codelineno-95-20 href=#__codelineno-95-20></a><span class=s>        - containerPort: 80</span>
<a id=__codelineno-95-21 name=__codelineno-95-21 href=#__codelineno-95-21></a><span class=s>EOF</span>
</code></pre></div> <p><strong>httpbin Kubernetes service:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a><span class=s>apiVersion: v1</span>
<a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a><span class=s>kind: Service</span>
<a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a><span class=s>metadata:</span>
<a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a><span class=s>  name: httpbin</span>
<a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a><span class=s>  labels:</span>
<a id=__codelineno-96-7 name=__codelineno-96-7 href=#__codelineno-96-7></a><span class=s>    app: httpbin</span>
<a id=__codelineno-96-8 name=__codelineno-96-8 href=#__codelineno-96-8></a><span class=s>spec:</span>
<a id=__codelineno-96-9 name=__codelineno-96-9 href=#__codelineno-96-9></a><span class=s>  ports:</span>
<a id=__codelineno-96-10 name=__codelineno-96-10 href=#__codelineno-96-10></a><span class=s>  - name: http</span>
<a id=__codelineno-96-11 name=__codelineno-96-11 href=#__codelineno-96-11></a><span class=s>    port: 8000</span>
<a id=__codelineno-96-12 name=__codelineno-96-12 href=#__codelineno-96-12></a><span class=s>    targetPort: 80</span>
<a id=__codelineno-96-13 name=__codelineno-96-13 href=#__codelineno-96-13></a><span class=s>  selector:</span>
<a id=__codelineno-96-14 name=__codelineno-96-14 href=#__codelineno-96-14></a><span class=s>    app: httpbin</span>
<a id=__codelineno-96-15 name=__codelineno-96-15 href=#__codelineno-96-15></a><span class=s>EOF</span>
</code></pre></div> <p>启动 <code>sleep</code> 服务，这样就可以使用 <code>curl</code> 来提供负载了：</p> <p><strong>sleep service:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF | istioctl kube-inject -f - | kubectl create -f -</span>
<a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a><span class=s>apiVersion: extensions/v1beta1</span>
<a id=__codelineno-97-3 name=__codelineno-97-3 href=#__codelineno-97-3></a><span class=s>kind: Deployment</span>
<a id=__codelineno-97-4 name=__codelineno-97-4 href=#__codelineno-97-4></a><span class=s>metadata:</span>
<a id=__codelineno-97-5 name=__codelineno-97-5 href=#__codelineno-97-5></a><span class=s>  name: sleep</span>
<a id=__codelineno-97-6 name=__codelineno-97-6 href=#__codelineno-97-6></a><span class=s>spec:</span>
<a id=__codelineno-97-7 name=__codelineno-97-7 href=#__codelineno-97-7></a><span class=s>  replicas: 1</span>
<a id=__codelineno-97-8 name=__codelineno-97-8 href=#__codelineno-97-8></a><span class=s>  template:</span>
<a id=__codelineno-97-9 name=__codelineno-97-9 href=#__codelineno-97-9></a><span class=s>    metadata:</span>
<a id=__codelineno-97-10 name=__codelineno-97-10 href=#__codelineno-97-10></a><span class=s>      labels:</span>
<a id=__codelineno-97-11 name=__codelineno-97-11 href=#__codelineno-97-11></a><span class=s>        app: sleep</span>
<a id=__codelineno-97-12 name=__codelineno-97-12 href=#__codelineno-97-12></a><span class=s>    spec:</span>
<a id=__codelineno-97-13 name=__codelineno-97-13 href=#__codelineno-97-13></a><span class=s>      containers:</span>
<a id=__codelineno-97-14 name=__codelineno-97-14 href=#__codelineno-97-14></a><span class=s>      - name: sleep</span>
<a id=__codelineno-97-15 name=__codelineno-97-15 href=#__codelineno-97-15></a><span class=s>        image: tutum/curl</span>
<a id=__codelineno-97-16 name=__codelineno-97-16 href=#__codelineno-97-16></a><span class=s>        command: [&quot;/bin/sleep&quot;,&quot;infinity&quot;]</span>
<a id=__codelineno-97-17 name=__codelineno-97-17 href=#__codelineno-97-17></a><span class=s>        imagePullPolicy: IfNotPresent</span>
<a id=__codelineno-97-18 name=__codelineno-97-18 href=#__codelineno-97-18></a><span class=s>EOF</span>
</code></pre></div> <h6 id=_41>创建默认路由策略<a class=headerlink href=#_41 title="Permanent link">&para;</a></h6> <p>默认情况下，Kubernetes 在 <code>httpbin</code> 服务的两个版本之间进行负载均衡。在此步骤中会更改该行为，把所有流量都路由到 <code>v1</code>。</p> <ul> <li>创建一个默认路由规则，将所有流量路由到服务的 <code>v1</code> ：</li> </ul> <p>如果为 Istio 启用了双向 TLS 认证，在应用前必须将 TLS 流量策略 <code>mode: ISTIO_MUTUAL</code> 添加到 <code>DestinationRule</code>。否则，请求将发生 503 错误，如<a href=https://istio.io/zh/docs/ops/traffic-management/troubleshooting/#设置目标规则后出现-503-错误>设置目标规则后出现 503 错误</a>所述。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a>$ kubectl apply -f - &lt;&lt;EOF
<a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a>apiVersion: networking.istio.io/v1alpha3
<a id=__codelineno-98-3 name=__codelineno-98-3 href=#__codelineno-98-3></a>kind: VirtualService
<a id=__codelineno-98-4 name=__codelineno-98-4 href=#__codelineno-98-4></a>metadata:
<a id=__codelineno-98-5 name=__codelineno-98-5 href=#__codelineno-98-5></a>  name: httpbin
<a id=__codelineno-98-6 name=__codelineno-98-6 href=#__codelineno-98-6></a>spec:
<a id=__codelineno-98-7 name=__codelineno-98-7 href=#__codelineno-98-7></a>  hosts:
<a id=__codelineno-98-8 name=__codelineno-98-8 href=#__codelineno-98-8></a>    - httpbin
<a id=__codelineno-98-9 name=__codelineno-98-9 href=#__codelineno-98-9></a>  http:
<a id=__codelineno-98-10 name=__codelineno-98-10 href=#__codelineno-98-10></a>  - route:
<a id=__codelineno-98-11 name=__codelineno-98-11 href=#__codelineno-98-11></a>    - destination:
<a id=__codelineno-98-12 name=__codelineno-98-12 href=#__codelineno-98-12></a>        host: httpbin
<a id=__codelineno-98-13 name=__codelineno-98-13 href=#__codelineno-98-13></a>        subset: v1
<a id=__codelineno-98-14 name=__codelineno-98-14 href=#__codelineno-98-14></a>      weight: 100
<a id=__codelineno-98-15 name=__codelineno-98-15 href=#__codelineno-98-15></a>---
<a id=__codelineno-98-16 name=__codelineno-98-16 href=#__codelineno-98-16></a>apiVersion: networking.istio.io/v1alpha3
<a id=__codelineno-98-17 name=__codelineno-98-17 href=#__codelineno-98-17></a>kind: DestinationRule
<a id=__codelineno-98-18 name=__codelineno-98-18 href=#__codelineno-98-18></a>metadata:
<a id=__codelineno-98-19 name=__codelineno-98-19 href=#__codelineno-98-19></a>  name: httpbin
<a id=__codelineno-98-20 name=__codelineno-98-20 href=#__codelineno-98-20></a>spec:
<a id=__codelineno-98-21 name=__codelineno-98-21 href=#__codelineno-98-21></a>  host: httpbin
<a id=__codelineno-98-22 name=__codelineno-98-22 href=#__codelineno-98-22></a>  subsets:
<a id=__codelineno-98-23 name=__codelineno-98-23 href=#__codelineno-98-23></a>  - name: v1
<a id=__codelineno-98-24 name=__codelineno-98-24 href=#__codelineno-98-24></a>    labels:
<a id=__codelineno-98-25 name=__codelineno-98-25 href=#__codelineno-98-25></a>      version: v1
<a id=__codelineno-98-26 name=__codelineno-98-26 href=#__codelineno-98-26></a>  - name: v2
<a id=__codelineno-98-27 name=__codelineno-98-27 href=#__codelineno-98-27></a>    labels:
<a id=__codelineno-98-28 name=__codelineno-98-28 href=#__codelineno-98-28></a>      version: v2
<a id=__codelineno-98-29 name=__codelineno-98-29 href=#__codelineno-98-29></a>EOF
</code></pre></div> <p>现在所有流量已经都转到 <code>httpbin:v1</code> 服务。</p> <ul> <li>向服务发送一些流量：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a>$ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
<a id=__codelineno-99-2 name=__codelineno-99-2 href=#__codelineno-99-2></a>$ kubectl exec -it $SLEEP_POD -c sleep -- sh -c &#39;curl  http://httpbin:8000/headers&#39; | python -m json.tool
<a id=__codelineno-99-3 name=__codelineno-99-3 href=#__codelineno-99-3></a>
<a id=__codelineno-99-4 name=__codelineno-99-4 href=#__codelineno-99-4></a>{
<a id=__codelineno-99-5 name=__codelineno-99-5 href=#__codelineno-99-5></a>  &quot;headers&quot;: {
<a id=__codelineno-99-6 name=__codelineno-99-6 href=#__codelineno-99-6></a>    &quot;Accept&quot;: &quot;*/*&quot;,
<a id=__codelineno-99-7 name=__codelineno-99-7 href=#__codelineno-99-7></a>    &quot;Content-Length&quot;: &quot;0&quot;,
<a id=__codelineno-99-8 name=__codelineno-99-8 href=#__codelineno-99-8></a>    &quot;Host&quot;: &quot;httpbin:8000&quot;,
<a id=__codelineno-99-9 name=__codelineno-99-9 href=#__codelineno-99-9></a>    &quot;User-Agent&quot;: &quot;curl/7.35.0&quot;,
<a id=__codelineno-99-10 name=__codelineno-99-10 href=#__codelineno-99-10></a>    &quot;X-B3-Sampled&quot;: &quot;1&quot;,
<a id=__codelineno-99-11 name=__codelineno-99-11 href=#__codelineno-99-11></a>    &quot;X-B3-Spanid&quot;: &quot;eca3d7ed8f2e6a0a&quot;,
<a id=__codelineno-99-12 name=__codelineno-99-12 href=#__codelineno-99-12></a>    &quot;X-B3-Traceid&quot;: &quot;eca3d7ed8f2e6a0a&quot;,
<a id=__codelineno-99-13 name=__codelineno-99-13 href=#__codelineno-99-13></a>    &quot;X-Ot-Span-Context&quot;: &quot;eca3d7ed8f2e6a0a;eca3d7ed8f2e6a0a;0000000000000000&quot;
<a id=__codelineno-99-14 name=__codelineno-99-14 href=#__codelineno-99-14></a>  }
<a id=__codelineno-99-15 name=__codelineno-99-15 href=#__codelineno-99-15></a>}
</code></pre></div> <ul> <li>查看 <code>httpbin</code> pods 的 <code>v1</code> 和 <code>v2</code> 日志。您可以看到 <code>v1</code> 的访问日志和 <code>v2</code> 为 <code>&lt;none&gt;</code> 的日志：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a>$ export V1_POD=$(kubectl get pod -l app=httpbin,version=v1 -o jsonpath={.items..metadata.name})
<a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a>$ kubectl logs -f $V1_POD -c httpbin
<a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a>
<a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a>127.0.0.1 - - [07/Mar/2018:19:02:43 +0000] &quot;GET /headers HTTP/1.1&quot; 200 321 &quot;-&quot; &quot;curl/7.35.0&quot;
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a>$ export V2_POD=$(kubectl get pod -l app=httpbin,version=v2 -o jsonpath={.items..metadata.name})
<a id=__codelineno-101-2 name=__codelineno-101-2 href=#__codelineno-101-2></a>$ kubectl logs -f $V2_POD -c httpbin
<a id=__codelineno-101-3 name=__codelineno-101-3 href=#__codelineno-101-3></a>
<a id=__codelineno-101-4 name=__codelineno-101-4 href=#__codelineno-101-4></a>&lt;none&gt;
</code></pre></div> <h6 id=v2>镜像流量到 v2<a class=headerlink href=#v2 title="Permanent link">&para;</a></h6> <ul> <li>改变路由规则将流量镜像到 v2:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a>$ kubectl apply -f - &lt;&lt;EOF
<a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a>apiVersion: networking.istio.io/v1alpha3
<a id=__codelineno-102-3 name=__codelineno-102-3 href=#__codelineno-102-3></a>kind: VirtualService
<a id=__codelineno-102-4 name=__codelineno-102-4 href=#__codelineno-102-4></a>metadata:
<a id=__codelineno-102-5 name=__codelineno-102-5 href=#__codelineno-102-5></a>  name: httpbin
<a id=__codelineno-102-6 name=__codelineno-102-6 href=#__codelineno-102-6></a>spec:
<a id=__codelineno-102-7 name=__codelineno-102-7 href=#__codelineno-102-7></a>  hosts:
<a id=__codelineno-102-8 name=__codelineno-102-8 href=#__codelineno-102-8></a>    - httpbin
<a id=__codelineno-102-9 name=__codelineno-102-9 href=#__codelineno-102-9></a>  http:
<a id=__codelineno-102-10 name=__codelineno-102-10 href=#__codelineno-102-10></a>  - route:
<a id=__codelineno-102-11 name=__codelineno-102-11 href=#__codelineno-102-11></a>    - destination:
<a id=__codelineno-102-12 name=__codelineno-102-12 href=#__codelineno-102-12></a>        host: httpbin
<a id=__codelineno-102-13 name=__codelineno-102-13 href=#__codelineno-102-13></a>        subset: v1
<a id=__codelineno-102-14 name=__codelineno-102-14 href=#__codelineno-102-14></a>      weight: 100
<a id=__codelineno-102-15 name=__codelineno-102-15 href=#__codelineno-102-15></a>    mirror:
<a id=__codelineno-102-16 name=__codelineno-102-16 href=#__codelineno-102-16></a>      host: httpbin
<a id=__codelineno-102-17 name=__codelineno-102-17 href=#__codelineno-102-17></a>      subset: v2
<a id=__codelineno-102-18 name=__codelineno-102-18 href=#__codelineno-102-18></a>EOF
</code></pre></div> <p>此路由规则将 100％ 的流量发送到 <code>v1</code> 。最后一节指定镜像到 <code>httpbin:v2</code> 服务。当流量被镜像时，请求将通过其主机/授权报头发送到镜像服务附上 <code>-shadow</code>。例如，将 <code>cluster-1</code> 变为 <code>cluster-1-shadow</code>。</p> <p>此外，重点注意这些被镜像的请求是“即发即弃”的，也就是说这些请求引发的响应是会被丢弃的。</p> <ul> <li>发送流量：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a>$ kubectl exec -it $SLEEP_POD -c sleep -- sh -c &#39;curl  http://httpbin:8000/headers&#39; | python -m json.tool
</code></pre></div> <p>这样就可以看到 <code>v1</code> 和 <code>v2</code> 中都有了访问日志。<code>v2</code> 中的访问日志就是由镜像流量产生的，这些请求的实际目标是 <code>v1</code>：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a>$ kubectl logs -f $V1_POD -c httpbin
<a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a>
<a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a>127.0.0.1 - - [07/Mar/2018:19:02:43 +0000] &quot;GET /headers HTTP/1.1&quot; 200 321 &quot;-&quot; &quot;curl/7.35.0&quot;
<a id=__codelineno-104-4 name=__codelineno-104-4 href=#__codelineno-104-4></a>127.0.0.1 - - [07/Mar/2018:19:26:44 +0000] &quot;GET /headers HTTP/1.1&quot; 200 321 &quot;-&quot; &quot;curl/7.35.0&quot;
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a>$ kubectl logs -f $V2_POD -c httpbin
<a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a>
<a id=__codelineno-105-3 name=__codelineno-105-3 href=#__codelineno-105-3></a>127.0.0.1 - - [07/Mar/2018:19:26:44 +0000] &quot;GET /headers HTTP/1.1&quot; 200 361 &quot;-&quot; &quot;curl/7.35.0&quot;
</code></pre></div> <ul> <li>如果要检查流量内部，请在另一个控制台上运行以下命令：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a>$ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
<a id=__codelineno-106-2 name=__codelineno-106-2 href=#__codelineno-106-2></a>$ export V1_POD_IP=$(kubectl get pod -l app=httpbin -l version=v1 -o jsonpath={.items..status.podIP})
<a id=__codelineno-106-3 name=__codelineno-106-3 href=#__codelineno-106-3></a>$ export V2_POD_IP=$(kubectl get pod -l app=httpbin -l version=v2 -o jsonpath={.items..status.podIP})
<a id=__codelineno-106-4 name=__codelineno-106-4 href=#__codelineno-106-4></a>$ kubectl exec -it $SLEEP_POD -c istio-proxy -- sudo tcpdump -A -s 0 host $V1_POD_IP or host $V2_POD_IP
<a id=__codelineno-106-5 name=__codelineno-106-5 href=#__codelineno-106-5></a>
<a id=__codelineno-106-6 name=__codelineno-106-6 href=#__codelineno-106-6></a>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
<a id=__codelineno-106-7 name=__codelineno-106-7 href=#__codelineno-106-7></a>listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
<a id=__codelineno-106-8 name=__codelineno-106-8 href=#__codelineno-106-8></a>05:47:50.159513 IP sleep-7b9f8bfcd-2djx5.38836 &gt; 10-233-75-11.httpbin.default.svc.cluster.local.80: Flags [P.], seq 4039989036:4039989832, ack 3139734980, win 254, options [nop,nop,TS val 77427918 ecr 76730809], length 796: HTTP: GET /headers HTTP/1.1
<a id=__codelineno-106-9 name=__codelineno-106-9 href=#__codelineno-106-9></a>E..P2.X.X.X.
<a id=__codelineno-106-10 name=__codelineno-106-10 href=#__codelineno-106-10></a>.K.
<a id=__codelineno-106-11 name=__codelineno-106-11 href=#__codelineno-106-11></a>.K....P..W,.$.......+.....
<a id=__codelineno-106-12 name=__codelineno-106-12 href=#__codelineno-106-12></a>..t.....GET /headers HTTP/1.1
<a id=__codelineno-106-13 name=__codelineno-106-13 href=#__codelineno-106-13></a>host: httpbin:8000
<a id=__codelineno-106-14 name=__codelineno-106-14 href=#__codelineno-106-14></a>user-agent: curl/7.35.0
<a id=__codelineno-106-15 name=__codelineno-106-15 href=#__codelineno-106-15></a>accept: */*
<a id=__codelineno-106-16 name=__codelineno-106-16 href=#__codelineno-106-16></a>x-forwarded-proto: http
<a id=__codelineno-106-17 name=__codelineno-106-17 href=#__codelineno-106-17></a>x-request-id: 571c0fd6-98d4-4c93-af79-6a2fe2945847
<a id=__codelineno-106-18 name=__codelineno-106-18 href=#__codelineno-106-18></a>x-envoy-decorator-operation: httpbin.default.svc.cluster.local:8000/*
<a id=__codelineno-106-19 name=__codelineno-106-19 href=#__codelineno-106-19></a>x-b3-traceid: 82f3e0a76dcebca2
<a id=__codelineno-106-20 name=__codelineno-106-20 href=#__codelineno-106-20></a>x-b3-spanid: 82f3e0a76dcebca2
<a id=__codelineno-106-21 name=__codelineno-106-21 href=#__codelineno-106-21></a>x-b3-sampled: 0
<a id=__codelineno-106-22 name=__codelineno-106-22 href=#__codelineno-106-22></a>x-istio-attributes: Cj8KGGRlc3RpbmF0aW9uLnNlcnZpY2UuaG9zdBIjEiFodHRwYmluLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwKPQoXZGVzdGluYXRpb24uc2VydmljZS51aWQSIhIgaXN0aW86Ly9kZWZhdWx0L3NlcnZpY2VzL2h0dHBiaW4KKgodZGVzdGluYXRpb24uc2VydmljZS5uYW1lc3BhY2USCRIHZGVmYXVsdAolChhkZXN0aW5hdGlvbi5zZXJ2aWNlLm5hbWUSCRIHaHR0cGJpbgo6Cgpzb3VyY2UudWlkEiwSKmt1YmVybmV0ZXM6Ly9zbGVlcC03YjlmOGJmY2QtMmRqeDUuZGVmYXVsdAo6ChNkZXN0aW5hdGlvbi5zZXJ2aWNlEiMSIWh0dHBiaW4uZGVmYXVsdC5zdmMuY2x1c3Rlci5sb2NhbA==
<a id=__codelineno-106-23 name=__codelineno-106-23 href=#__codelineno-106-23></a>content-length: 0
<a id=__codelineno-106-24 name=__codelineno-106-24 href=#__codelineno-106-24></a>
<a id=__codelineno-106-25 name=__codelineno-106-25 href=#__codelineno-106-25></a>
<a id=__codelineno-106-26 name=__codelineno-106-26 href=#__codelineno-106-26></a>05:47:50.159609 IP sleep-7b9f8bfcd-2djx5.49560 &gt; 10-233-71-7.httpbin.default.svc.cluster.local.80: Flags [P.], seq 296287713:296288571, ack 4029574162, win 254, options [nop,nop,TS val 77427918 ecr 76732809], length 858: HTTP: GET /headers HTTP/1.1
<a id=__codelineno-106-27 name=__codelineno-106-27 href=#__codelineno-106-27></a>E.....X.X...
<a id=__codelineno-106-28 name=__codelineno-106-28 href=#__codelineno-106-28></a>.K.
<a id=__codelineno-106-29 name=__codelineno-106-29 href=#__codelineno-106-29></a>.G....P......l......e.....
<a id=__codelineno-106-30 name=__codelineno-106-30 href=#__codelineno-106-30></a>..t.....GET /headers HTTP/1.1
<a id=__codelineno-106-31 name=__codelineno-106-31 href=#__codelineno-106-31></a>host: httpbin-shadow:8000
<a id=__codelineno-106-32 name=__codelineno-106-32 href=#__codelineno-106-32></a>user-agent: curl/7.35.0
<a id=__codelineno-106-33 name=__codelineno-106-33 href=#__codelineno-106-33></a>accept: */*
<a id=__codelineno-106-34 name=__codelineno-106-34 href=#__codelineno-106-34></a>x-forwarded-proto: http
<a id=__codelineno-106-35 name=__codelineno-106-35 href=#__codelineno-106-35></a>x-request-id: 571c0fd6-98d4-4c93-af79-6a2fe2945847
<a id=__codelineno-106-36 name=__codelineno-106-36 href=#__codelineno-106-36></a>x-envoy-decorator-operation: httpbin.default.svc.cluster.local:8000/*
<a id=__codelineno-106-37 name=__codelineno-106-37 href=#__codelineno-106-37></a>x-b3-traceid: 82f3e0a76dcebca2
<a id=__codelineno-106-38 name=__codelineno-106-38 href=#__codelineno-106-38></a>x-b3-spanid: 82f3e0a76dcebca2
<a id=__codelineno-106-39 name=__codelineno-106-39 href=#__codelineno-106-39></a>x-b3-sampled: 0
<a id=__codelineno-106-40 name=__codelineno-106-40 href=#__codelineno-106-40></a>x-istio-attributes: Cj8KGGRlc3RpbmF0aW9uLnNlcnZpY2UuaG9zdBIjEiFodHRwYmluLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwKPQoXZGVzdGluYXRpb24uc2VydmljZS51aWQSIhIgaXN0aW86Ly9kZWZhdWx0L3NlcnZpY2VzL2h0dHBiaW4KKgodZGVzdGluYXRpb24uc2VydmljZS5uYW1lc3BhY2USCRIHZGVmYXVsdAolChhkZXN0aW5hdGlvbi5zZXJ2aWNlLm5hbWUSCRIHaHR0cGJpbgo6Cgpzb3VyY2UudWlkEiwSKmt1YmVybmV0ZXM6Ly9zbGVlcC03YjlmOGJmY2QtMmRqeDUuZGVmYXVsdAo6ChNkZXN0aW5hdGlvbi5zZXJ2aWNlEiMSIWh0dHBiaW4uZGVmYXVsdC5zdmMuY2x1c3Rlci5sb2NhbA==
<a id=__codelineno-106-41 name=__codelineno-106-41 href=#__codelineno-106-41></a>x-envoy-internal: true
<a id=__codelineno-106-42 name=__codelineno-106-42 href=#__codelineno-106-42></a>x-forwarded-for: 10.233.75.12
<a id=__codelineno-106-43 name=__codelineno-106-43 href=#__codelineno-106-43></a>content-length: 0
<a id=__codelineno-106-44 name=__codelineno-106-44 href=#__codelineno-106-44></a>
<a id=__codelineno-106-45 name=__codelineno-106-45 href=#__codelineno-106-45></a>
<a id=__codelineno-106-46 name=__codelineno-106-46 href=#__codelineno-106-46></a>05:47:50.166734 IP 10-233-75-11.httpbin.default.svc.cluster.local.80 &gt; sleep-7b9f8bfcd-2djx5.38836: Flags [P.], seq 1:472, ack 796, win 276, options [nop,nop,TS val 77427925 ecr 77427918], length 471: HTTP: HTTP/1.1 200 OK
<a id=__codelineno-106-47 name=__codelineno-106-47 href=#__codelineno-106-47></a>E....3X.?...
<a id=__codelineno-106-48 name=__codelineno-106-48 href=#__codelineno-106-48></a>.K.
<a id=__codelineno-106-49 name=__codelineno-106-49 href=#__codelineno-106-49></a>.K..P...$....ZH...........
<a id=__codelineno-106-50 name=__codelineno-106-50 href=#__codelineno-106-50></a>..t...t.HTTP/1.1 200 OK
<a id=__codelineno-106-51 name=__codelineno-106-51 href=#__codelineno-106-51></a>server: envoy
<a id=__codelineno-106-52 name=__codelineno-106-52 href=#__codelineno-106-52></a>date: Fri, 15 Feb 2019 05:47:50 GMT
<a id=__codelineno-106-53 name=__codelineno-106-53 href=#__codelineno-106-53></a>content-type: application/json
<a id=__codelineno-106-54 name=__codelineno-106-54 href=#__codelineno-106-54></a>content-length: 241
<a id=__codelineno-106-55 name=__codelineno-106-55 href=#__codelineno-106-55></a>access-control-allow-origin: *
<a id=__codelineno-106-56 name=__codelineno-106-56 href=#__codelineno-106-56></a>access-control-allow-credentials: true
<a id=__codelineno-106-57 name=__codelineno-106-57 href=#__codelineno-106-57></a>x-envoy-upstream-service-time: 3
<a id=__codelineno-106-58 name=__codelineno-106-58 href=#__codelineno-106-58></a>
<a id=__codelineno-106-59 name=__codelineno-106-59 href=#__codelineno-106-59></a>{
<a id=__codelineno-106-60 name=__codelineno-106-60 href=#__codelineno-106-60></a>  &quot;headers&quot;: {
<a id=__codelineno-106-61 name=__codelineno-106-61 href=#__codelineno-106-61></a>    &quot;Accept&quot;: &quot;*/*&quot;,
<a id=__codelineno-106-62 name=__codelineno-106-62 href=#__codelineno-106-62></a>    &quot;Content-Length&quot;: &quot;0&quot;,
<a id=__codelineno-106-63 name=__codelineno-106-63 href=#__codelineno-106-63></a>    &quot;Host&quot;: &quot;httpbin:8000&quot;,
<a id=__codelineno-106-64 name=__codelineno-106-64 href=#__codelineno-106-64></a>    &quot;User-Agent&quot;: &quot;curl/7.35.0&quot;,
<a id=__codelineno-106-65 name=__codelineno-106-65 href=#__codelineno-106-65></a>    &quot;X-B3-Sampled&quot;: &quot;0&quot;,
<a id=__codelineno-106-66 name=__codelineno-106-66 href=#__codelineno-106-66></a>    &quot;X-B3-Spanid&quot;: &quot;82f3e0a76dcebca2&quot;,
<a id=__codelineno-106-67 name=__codelineno-106-67 href=#__codelineno-106-67></a>    &quot;X-B3-Traceid&quot;: &quot;82f3e0a76dcebca2&quot;
<a id=__codelineno-106-68 name=__codelineno-106-68 href=#__codelineno-106-68></a>  }
<a id=__codelineno-106-69 name=__codelineno-106-69 href=#__codelineno-106-69></a>}
<a id=__codelineno-106-70 name=__codelineno-106-70 href=#__codelineno-106-70></a>
<a id=__codelineno-106-71 name=__codelineno-106-71 href=#__codelineno-106-71></a>05:47:50.166789 IP sleep-7b9f8bfcd-2djx5.38836 &gt; 10-233-75-11.httpbin.default.svc.cluster.local.80: Flags [.], ack 472, win 262, options [nop,nop,TS val 77427925 ecr 77427925], length 0
<a id=__codelineno-106-72 name=__codelineno-106-72 href=#__codelineno-106-72></a>E..42.X.X.\.
<a id=__codelineno-106-73 name=__codelineno-106-73 href=#__codelineno-106-73></a>.K.
<a id=__codelineno-106-74 name=__codelineno-106-74 href=#__codelineno-106-74></a>.K....P..ZH.$.............
<a id=__codelineno-106-75 name=__codelineno-106-75 href=#__codelineno-106-75></a>..t...t.
<a id=__codelineno-106-76 name=__codelineno-106-76 href=#__codelineno-106-76></a>05:47:50.167234 IP 10-233-71-7.httpbin.default.svc.cluster.local.80 &gt; sleep-7b9f8bfcd-2djx5.49560: Flags [P.], seq 1:512, ack 858, win 280, options [nop,nop,TS val 77429926 ecr 77427918], length 511: HTTP: HTTP/1.1 200 OK
<a id=__codelineno-106-77 name=__codelineno-106-77 href=#__codelineno-106-77></a>E..3..X.&gt;...
<a id=__codelineno-106-78 name=__codelineno-106-78 href=#__codelineno-106-78></a>.G.
<a id=__codelineno-106-79 name=__codelineno-106-79 href=#__codelineno-106-79></a>.K..P....l....;...........
<a id=__codelineno-106-80 name=__codelineno-106-80 href=#__codelineno-106-80></a>..|...t.HTTP/1.1 200 OK
<a id=__codelineno-106-81 name=__codelineno-106-81 href=#__codelineno-106-81></a>server: envoy
<a id=__codelineno-106-82 name=__codelineno-106-82 href=#__codelineno-106-82></a>date: Fri, 15 Feb 2019 05:47:49 GMT
<a id=__codelineno-106-83 name=__codelineno-106-83 href=#__codelineno-106-83></a>content-type: application/json
<a id=__codelineno-106-84 name=__codelineno-106-84 href=#__codelineno-106-84></a>content-length: 281
<a id=__codelineno-106-85 name=__codelineno-106-85 href=#__codelineno-106-85></a>access-control-allow-origin: *
<a id=__codelineno-106-86 name=__codelineno-106-86 href=#__codelineno-106-86></a>access-control-allow-credentials: true
<a id=__codelineno-106-87 name=__codelineno-106-87 href=#__codelineno-106-87></a>x-envoy-upstream-service-time: 3
<a id=__codelineno-106-88 name=__codelineno-106-88 href=#__codelineno-106-88></a>
<a id=__codelineno-106-89 name=__codelineno-106-89 href=#__codelineno-106-89></a>{
<a id=__codelineno-106-90 name=__codelineno-106-90 href=#__codelineno-106-90></a>  &quot;headers&quot;: {
<a id=__codelineno-106-91 name=__codelineno-106-91 href=#__codelineno-106-91></a>    &quot;Accept&quot;: &quot;*/*&quot;,
<a id=__codelineno-106-92 name=__codelineno-106-92 href=#__codelineno-106-92></a>    &quot;Content-Length&quot;: &quot;0&quot;,
<a id=__codelineno-106-93 name=__codelineno-106-93 href=#__codelineno-106-93></a>    &quot;Host&quot;: &quot;httpbin-shadow:8000&quot;,
<a id=__codelineno-106-94 name=__codelineno-106-94 href=#__codelineno-106-94></a>    &quot;User-Agent&quot;: &quot;curl/7.35.0&quot;,
<a id=__codelineno-106-95 name=__codelineno-106-95 href=#__codelineno-106-95></a>    &quot;X-B3-Sampled&quot;: &quot;0&quot;,
<a id=__codelineno-106-96 name=__codelineno-106-96 href=#__codelineno-106-96></a>    &quot;X-B3-Spanid&quot;: &quot;82f3e0a76dcebca2&quot;,
<a id=__codelineno-106-97 name=__codelineno-106-97 href=#__codelineno-106-97></a>    &quot;X-B3-Traceid&quot;: &quot;82f3e0a76dcebca2&quot;,
<a id=__codelineno-106-98 name=__codelineno-106-98 href=#__codelineno-106-98></a>    &quot;X-Envoy-Internal&quot;: &quot;true&quot;
<a id=__codelineno-106-99 name=__codelineno-106-99 href=#__codelineno-106-99></a>  }
<a id=__codelineno-106-100 name=__codelineno-106-100 href=#__codelineno-106-100></a>}
<a id=__codelineno-106-101 name=__codelineno-106-101 href=#__codelineno-106-101></a>
<a id=__codelineno-106-102 name=__codelineno-106-102 href=#__codelineno-106-102></a>05:47:50.167253 IP sleep-7b9f8bfcd-2djx5.49560 &gt; 10-233-71-7.httpbin.default.svc.cluster.local.80: Flags [.], ack 512, win 262, options [nop,nop,TS val 77427926 ecr 77429926], length 0
<a id=__codelineno-106-103 name=__codelineno-106-103 href=#__codelineno-106-103></a>E..4..X.X...
<a id=__codelineno-106-104 name=__codelineno-106-104 href=#__codelineno-106-104></a>.K.
<a id=__codelineno-106-105 name=__codelineno-106-105 href=#__codelineno-106-105></a>.G....P...;..n............
<a id=__codelineno-106-106 name=__codelineno-106-106 href=#__codelineno-106-106></a>..t...|.
</code></pre></div> <p>您可以查看流量的请求和响应内容。</p> <h6 id=_42>清理<a class=headerlink href=#_42 title="Permanent link">&para;</a></h6> <ul> <li>删除规则：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a>$ kubectl delete virtualservice httpbin
<a id=__codelineno-107-2 name=__codelineno-107-2 href=#__codelineno-107-2></a>$ kubectl delete destinationrule httpbin
</code></pre></div> <ul> <li>关闭 <a href=https://github.com/istio/istio/tree/release-1.2/samples/httpbin>httpbin</a> 服务和客户端：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a>$ kubectl delete deploy httpbin-v1 httpbin-v2 sleep
<a id=__codelineno-108-2 name=__codelineno-108-2 href=#__codelineno-108-2></a>$ kubectl delete svc httpbin
</code></pre></div> <h5 id=_43>边缘流量控制<a class=headerlink href=#_43 title="Permanent link">&para;</a></h5> <h6 id=1-tls-ingress-gateway>1.没有 TLS 的 Ingress gateway<a class=headerlink href=#1-tls-ingress-gateway title="Permanent link">&para;</a></h6> <p><a href=https://istio.io/zh/docs/tasks/traffic-management/secure-ingress/ >使用 HTTPS 保护网关</a>任务描述了如何配置 HTTPS 入口访问 HTTP 服务。此示例介绍如何配置对 HTTPS 服务的入口访问，即配置 Ingress Gateway 以执行 SNI 直通，而不是终止 TLS 请求的传入。</p> <p>用于此任务的示例 HTTPS 服务是一个简单的 <a href=https://www.nginx.com/ >NGINX</a> 服务器。 在以下步骤中，首先在 Kubernetes 集群中部署 NGINX 服务。 然后配置网关以通过主机 <code>nginx.example.com</code> 提供对此服务的入口访问。</p> <ul> <li> <h6 id=_44>生成客户端和服务器证书和密钥<a class=headerlink href=#_44 title="Permanent link">&para;</a></h6> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a><span class=nb>pushd</span><span class=w> </span>mtls-go-example
<a id=__codelineno-109-2 name=__codelineno-109-2 href=#__codelineno-109-2></a>./generate.sh<span class=w> </span>nginx.example.com<span class=w> </span>password
<a id=__codelineno-109-3 name=__codelineno-109-3 href=#__codelineno-109-3></a>mkdir<span class=w> </span>../nginx.example.com<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>mv<span class=w> </span>1_root<span class=w> </span>2_intermediate<span class=w> </span>3_application<span class=w> </span>4_client<span class=w> </span>../nginx.example.com
<a id=__codelineno-109-4 name=__codelineno-109-4 href=#__codelineno-109-4></a><span class=nb>popd</span>
</code></pre></div> <ul> <li>部署NGINX服务器</li> </ul> <p>创建一个kubernetes secret保存服务器的证书</p> <div class=highlight><pre><span></span><code><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>tls<span class=w> </span>nginx-server-certs<span class=w> </span>--key<span class=w> </span>nginx.example.com/3_application/private/nginx.example.com.key.pem<span class=w> </span>--cert<span class=w> </span>nginx.example.com/3_application/certs/nginx.example.com.cert.pem
</code></pre></div> <p>创建NGINX服务器配置文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a>cat<span class=w> </span><span class=s>&lt;&lt;EOF &gt; ./nginx.conf</span>
<a id=__codelineno-111-2 name=__codelineno-111-2 href=#__codelineno-111-2></a><span class=s>events {</span>
<a id=__codelineno-111-3 name=__codelineno-111-3 href=#__codelineno-111-3></a><span class=s>}</span>
<a id=__codelineno-111-4 name=__codelineno-111-4 href=#__codelineno-111-4></a>
<a id=__codelineno-111-5 name=__codelineno-111-5 href=#__codelineno-111-5></a><span class=s>http {</span>
<a id=__codelineno-111-6 name=__codelineno-111-6 href=#__codelineno-111-6></a><span class=s>  log_format main &#39;$remote_addr - $remote_user [$time_local]  $status &#39;</span>
<a id=__codelineno-111-7 name=__codelineno-111-7 href=#__codelineno-111-7></a><span class=s>  &#39;&quot;$request&quot; $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
<a id=__codelineno-111-8 name=__codelineno-111-8 href=#__codelineno-111-8></a><span class=s>  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span>
<a id=__codelineno-111-9 name=__codelineno-111-9 href=#__codelineno-111-9></a><span class=s>  access_log /var/log/nginx/access.log main;</span>
<a id=__codelineno-111-10 name=__codelineno-111-10 href=#__codelineno-111-10></a><span class=s>  error_log  /var/log/nginx/error.log;</span>
<a id=__codelineno-111-11 name=__codelineno-111-11 href=#__codelineno-111-11></a>
<a id=__codelineno-111-12 name=__codelineno-111-12 href=#__codelineno-111-12></a><span class=s>  server {</span>
<a id=__codelineno-111-13 name=__codelineno-111-13 href=#__codelineno-111-13></a><span class=s>    listen 443 ssl;</span>
<a id=__codelineno-111-14 name=__codelineno-111-14 href=#__codelineno-111-14></a>
<a id=__codelineno-111-15 name=__codelineno-111-15 href=#__codelineno-111-15></a><span class=s>    root /usr/share/nginx/html;</span>
<a id=__codelineno-111-16 name=__codelineno-111-16 href=#__codelineno-111-16></a><span class=s>    index index.html;</span>
<a id=__codelineno-111-17 name=__codelineno-111-17 href=#__codelineno-111-17></a>
<a id=__codelineno-111-18 name=__codelineno-111-18 href=#__codelineno-111-18></a><span class=s>    server_name nginx.example.com;</span>
<a id=__codelineno-111-19 name=__codelineno-111-19 href=#__codelineno-111-19></a><span class=s>    ssl_certificate /etc/nginx-server-certs/tls.crt;</span>
<a id=__codelineno-111-20 name=__codelineno-111-20 href=#__codelineno-111-20></a><span class=s>    ssl_certificate_key /etc/nginx-server-certs/tls.key;</span>
<a id=__codelineno-111-21 name=__codelineno-111-21 href=#__codelineno-111-21></a><span class=s>  }</span>
<a id=__codelineno-111-22 name=__codelineno-111-22 href=#__codelineno-111-22></a><span class=s>}</span>
<a id=__codelineno-111-23 name=__codelineno-111-23 href=#__codelineno-111-23></a><span class=s>EOF</span>
</code></pre></div> <p>创建 Kubernetes <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/ >ConfigMap</a> 保持 NGINX 服务器的配置：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a>kubectl<span class=w> </span>create<span class=w> </span>configmap<span class=w> </span>nginx-configmap<span class=w> </span>--from-file<span class=o>=</span>nginx.conf<span class=o>=</span>./nginx.conf
</code></pre></div> <p>部署NGINX服务器：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-113-2 name=__codelineno-113-2 href=#__codelineno-113-2></a><span class=s>apiVersion: v1</span>
<a id=__codelineno-113-3 name=__codelineno-113-3 href=#__codelineno-113-3></a><span class=s>kind: Service</span>
<a id=__codelineno-113-4 name=__codelineno-113-4 href=#__codelineno-113-4></a><span class=s>metadata:</span>
<a id=__codelineno-113-5 name=__codelineno-113-5 href=#__codelineno-113-5></a><span class=s>  name: my-nginx</span>
<a id=__codelineno-113-6 name=__codelineno-113-6 href=#__codelineno-113-6></a><span class=s>  labels:</span>
<a id=__codelineno-113-7 name=__codelineno-113-7 href=#__codelineno-113-7></a><span class=s>    run: my-nginx</span>
<a id=__codelineno-113-8 name=__codelineno-113-8 href=#__codelineno-113-8></a><span class=s>spec:</span>
<a id=__codelineno-113-9 name=__codelineno-113-9 href=#__codelineno-113-9></a><span class=s>  ports:</span>
<a id=__codelineno-113-10 name=__codelineno-113-10 href=#__codelineno-113-10></a><span class=s>  - port: 443</span>
<a id=__codelineno-113-11 name=__codelineno-113-11 href=#__codelineno-113-11></a><span class=s>    protocol: TCP</span>
<a id=__codelineno-113-12 name=__codelineno-113-12 href=#__codelineno-113-12></a><span class=s>  selector:</span>
<a id=__codelineno-113-13 name=__codelineno-113-13 href=#__codelineno-113-13></a><span class=s>    run: my-nginx</span>
<a id=__codelineno-113-14 name=__codelineno-113-14 href=#__codelineno-113-14></a><span class=s>---</span>
<a id=__codelineno-113-15 name=__codelineno-113-15 href=#__codelineno-113-15></a><span class=s>apiVersion: apps/v1</span>
<a id=__codelineno-113-16 name=__codelineno-113-16 href=#__codelineno-113-16></a><span class=s>kind: Deployment</span>
<a id=__codelineno-113-17 name=__codelineno-113-17 href=#__codelineno-113-17></a><span class=s>metadata:</span>
<a id=__codelineno-113-18 name=__codelineno-113-18 href=#__codelineno-113-18></a><span class=s>  name: my-nginx</span>
<a id=__codelineno-113-19 name=__codelineno-113-19 href=#__codelineno-113-19></a><span class=s>spec:</span>
<a id=__codelineno-113-20 name=__codelineno-113-20 href=#__codelineno-113-20></a><span class=s>  selector:</span>
<a id=__codelineno-113-21 name=__codelineno-113-21 href=#__codelineno-113-21></a><span class=s>    matchLabels:</span>
<a id=__codelineno-113-22 name=__codelineno-113-22 href=#__codelineno-113-22></a><span class=s>      run: my-nginx</span>
<a id=__codelineno-113-23 name=__codelineno-113-23 href=#__codelineno-113-23></a><span class=s>  replicas: 1</span>
<a id=__codelineno-113-24 name=__codelineno-113-24 href=#__codelineno-113-24></a><span class=s>  template:</span>
<a id=__codelineno-113-25 name=__codelineno-113-25 href=#__codelineno-113-25></a><span class=s>    metadata:</span>
<a id=__codelineno-113-26 name=__codelineno-113-26 href=#__codelineno-113-26></a><span class=s>      labels:</span>
<a id=__codelineno-113-27 name=__codelineno-113-27 href=#__codelineno-113-27></a><span class=s>        run: my-nginx</span>
<a id=__codelineno-113-28 name=__codelineno-113-28 href=#__codelineno-113-28></a><span class=s>    spec:</span>
<a id=__codelineno-113-29 name=__codelineno-113-29 href=#__codelineno-113-29></a><span class=s>      containers:</span>
<a id=__codelineno-113-30 name=__codelineno-113-30 href=#__codelineno-113-30></a><span class=s>      - name: my-nginx</span>
<a id=__codelineno-113-31 name=__codelineno-113-31 href=#__codelineno-113-31></a><span class=s>        image: nginx</span>
<a id=__codelineno-113-32 name=__codelineno-113-32 href=#__codelineno-113-32></a><span class=s>        ports:</span>
<a id=__codelineno-113-33 name=__codelineno-113-33 href=#__codelineno-113-33></a><span class=s>        - containerPort: 443</span>
<a id=__codelineno-113-34 name=__codelineno-113-34 href=#__codelineno-113-34></a><span class=s>        volumeMounts:</span>
<a id=__codelineno-113-35 name=__codelineno-113-35 href=#__codelineno-113-35></a><span class=s>        - name: nginx-config</span>
<a id=__codelineno-113-36 name=__codelineno-113-36 href=#__codelineno-113-36></a><span class=s>          mountPath: /etc/nginx</span>
<a id=__codelineno-113-37 name=__codelineno-113-37 href=#__codelineno-113-37></a><span class=s>          readOnly: true</span>
<a id=__codelineno-113-38 name=__codelineno-113-38 href=#__codelineno-113-38></a><span class=s>        - name: nginx-server-certs</span>
<a id=__codelineno-113-39 name=__codelineno-113-39 href=#__codelineno-113-39></a><span class=s>          mountPath: /etc/nginx-server-certs</span>
<a id=__codelineno-113-40 name=__codelineno-113-40 href=#__codelineno-113-40></a><span class=s>          readOnly: true</span>
<a id=__codelineno-113-41 name=__codelineno-113-41 href=#__codelineno-113-41></a><span class=s>      volumes:</span>
<a id=__codelineno-113-42 name=__codelineno-113-42 href=#__codelineno-113-42></a><span class=s>      - name: nginx-config</span>
<a id=__codelineno-113-43 name=__codelineno-113-43 href=#__codelineno-113-43></a><span class=s>        configMap:</span>
<a id=__codelineno-113-44 name=__codelineno-113-44 href=#__codelineno-113-44></a><span class=s>          name: nginx-configmap</span>
<a id=__codelineno-113-45 name=__codelineno-113-45 href=#__codelineno-113-45></a><span class=s>      - name: nginx-server-certs</span>
<a id=__codelineno-113-46 name=__codelineno-113-46 href=#__codelineno-113-46></a><span class=s>        secret:</span>
<a id=__codelineno-113-47 name=__codelineno-113-47 href=#__codelineno-113-47></a><span class=s>          secretName: nginx-server-certs</span>
<a id=__codelineno-113-48 name=__codelineno-113-48 href=#__codelineno-113-48></a><span class=s>EOF</span>
</code></pre></div> <p>要测试 NGINX 服务器是否已成功部署，请从其 sidecar 代理向服务器发送请求， 而不检查服务器的证书（使用 <code>curl</code> 的 <code>-k</code> 选项）。确保正确打印服务器的证书， 即 <code>common name</code> 等于 <code>nginx.example.com</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=k>$(</span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w>  </span>-l<span class=w> </span><span class=nv>run</span><span class=o>=</span>my-nginx<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>={</span>.items..metadata.name<span class=o>}</span><span class=k>)</span><span class=w> </span>-c<span class=w> </span>istio-proxy<span class=w> </span>--<span class=w> </span>curl<span class=w> </span>-v<span class=w> </span>-k<span class=w> </span>--resolve<span class=w> </span>nginx.example.com:443:127.0.0.1<span class=w> </span>https://nginx.example.com
</code></pre></div> <ul> <li>配置 Ingress Gateway</li> </ul> <p>为端口 443 定义一个带有 <code>server</code> 部分的 <code>Gateway</code> 。注意 <code>PASSTHROUGH</code> <code>tls</code> <code>mode</code> 指示网关按原样传递入口流量， 而不终止 TLS。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-115-2 name=__codelineno-115-2 href=#__codelineno-115-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-115-3 name=__codelineno-115-3 href=#__codelineno-115-3></a><span class=s>kind: Gateway</span>
<a id=__codelineno-115-4 name=__codelineno-115-4 href=#__codelineno-115-4></a><span class=s>metadata:</span>
<a id=__codelineno-115-5 name=__codelineno-115-5 href=#__codelineno-115-5></a><span class=s>  name: mygateway</span>
<a id=__codelineno-115-6 name=__codelineno-115-6 href=#__codelineno-115-6></a><span class=s>spec:</span>
<a id=__codelineno-115-7 name=__codelineno-115-7 href=#__codelineno-115-7></a><span class=s>  selector:</span>
<a id=__codelineno-115-8 name=__codelineno-115-8 href=#__codelineno-115-8></a><span class=s>    istio: ingressgateway # 使用 istio 默认的 ingress gateway</span>
<a id=__codelineno-115-9 name=__codelineno-115-9 href=#__codelineno-115-9></a><span class=s>  servers:</span>
<a id=__codelineno-115-10 name=__codelineno-115-10 href=#__codelineno-115-10></a><span class=s>  - port:</span>
<a id=__codelineno-115-11 name=__codelineno-115-11 href=#__codelineno-115-11></a><span class=s>      number: 443</span>
<a id=__codelineno-115-12 name=__codelineno-115-12 href=#__codelineno-115-12></a><span class=s>      name: https</span>
<a id=__codelineno-115-13 name=__codelineno-115-13 href=#__codelineno-115-13></a><span class=s>      protocol: HTTPS</span>
<a id=__codelineno-115-14 name=__codelineno-115-14 href=#__codelineno-115-14></a><span class=s>    tls:</span>
<a id=__codelineno-115-15 name=__codelineno-115-15 href=#__codelineno-115-15></a><span class=s>      mode: PASSTHROUGH</span>
<a id=__codelineno-115-16 name=__codelineno-115-16 href=#__codelineno-115-16></a><span class=s>    hosts:</span>
<a id=__codelineno-115-17 name=__codelineno-115-17 href=#__codelineno-115-17></a><span class=s>    - nginx.example.com</span>
<a id=__codelineno-115-18 name=__codelineno-115-18 href=#__codelineno-115-18></a><span class=s>EOF</span>
</code></pre></div> <p>配置通过 <code>Gateway</code> 进入的流量路由：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-116-2 name=__codelineno-116-2 href=#__codelineno-116-2></a><span class=s>apiVersion: networking.istio.io/v1alpha3</span>
<a id=__codelineno-116-3 name=__codelineno-116-3 href=#__codelineno-116-3></a><span class=s>kind: VirtualService</span>
<a id=__codelineno-116-4 name=__codelineno-116-4 href=#__codelineno-116-4></a><span class=s>metadata:</span>
<a id=__codelineno-116-5 name=__codelineno-116-5 href=#__codelineno-116-5></a><span class=s>  name: nginx</span>
<a id=__codelineno-116-6 name=__codelineno-116-6 href=#__codelineno-116-6></a><span class=s>spec:</span>
<a id=__codelineno-116-7 name=__codelineno-116-7 href=#__codelineno-116-7></a><span class=s>  hosts:</span>
<a id=__codelineno-116-8 name=__codelineno-116-8 href=#__codelineno-116-8></a><span class=s>  - nginx.example.com</span>
<a id=__codelineno-116-9 name=__codelineno-116-9 href=#__codelineno-116-9></a><span class=s>  gateways:</span>
<a id=__codelineno-116-10 name=__codelineno-116-10 href=#__codelineno-116-10></a><span class=s>  - mygateway</span>
<a id=__codelineno-116-11 name=__codelineno-116-11 href=#__codelineno-116-11></a><span class=s>  tls:</span>
<a id=__codelineno-116-12 name=__codelineno-116-12 href=#__codelineno-116-12></a><span class=s>  - match:</span>
<a id=__codelineno-116-13 name=__codelineno-116-13 href=#__codelineno-116-13></a><span class=s>    - port: 443</span>
<a id=__codelineno-116-14 name=__codelineno-116-14 href=#__codelineno-116-14></a><span class=s>      sni_hosts:</span>
<a id=__codelineno-116-15 name=__codelineno-116-15 href=#__codelineno-116-15></a><span class=s>      - nginx.example.com</span>
<a id=__codelineno-116-16 name=__codelineno-116-16 href=#__codelineno-116-16></a><span class=s>    route:</span>
<a id=__codelineno-116-17 name=__codelineno-116-17 href=#__codelineno-116-17></a><span class=s>    - destination:</span>
<a id=__codelineno-116-18 name=__codelineno-116-18 href=#__codelineno-116-18></a><span class=s>        host: my-nginx</span>
<a id=__codelineno-116-19 name=__codelineno-116-19 href=#__codelineno-116-19></a><span class=s>        port:</span>
<a id=__codelineno-116-20 name=__codelineno-116-20 href=#__codelineno-116-20></a><span class=s>          number: 443</span>
<a id=__codelineno-116-21 name=__codelineno-116-21 href=#__codelineno-116-21></a><span class=s>EOF</span>
</code></pre></div> <p>按照<a href=https://istio.io/zh/docs/tasks/traffic-management/ingress/#确定入口-ip-和端口>确定入口IP和端口</a>中的说明定义 <code>SECURE_INGRESS_PORT</code> 和 <code>INGRESS_HOST</code> 环境变量。</p> <p>从群集外部访问 NGINX 服务。请注意，服务器返回正确的证书并成功验证（打印 <em>SSL certificate verify ok</em> ）</p> <div class=highlight><pre><span></span><code><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a>curl<span class=w> </span>-v<span class=w> </span>--resolve<span class=w> </span>nginx.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>:<span class=nv>$INGRESS_HOST</span><span class=w> </span>--cacert<span class=w> </span>nginx.example.com/2_intermediate/certs/ca-chain.cert.pem<span class=w> </span>https://nginx.example.com:<span class=nv>$SECURE_INGRESS_PORT</span>
</code></pre></div> <ul> <li> <p>清理</p> </li> <li> <p>删除创建的 Kubernetes 资源：</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a>$ kubectl delete secret nginx-server-certs
<a id=__codelineno-118-2 name=__codelineno-118-2 href=#__codelineno-118-2></a>$ kubectl delete configmap nginx-configmap
<a id=__codelineno-118-3 name=__codelineno-118-3 href=#__codelineno-118-3></a>$ kubectl delete service my-nginx
<a id=__codelineno-118-4 name=__codelineno-118-4 href=#__codelineno-118-4></a>$ kubectl delete deployment my-nginx
<a id=__codelineno-118-5 name=__codelineno-118-5 href=#__codelineno-118-5></a>$ kubectl delete gateway mygateway
<a id=__codelineno-118-6 name=__codelineno-118-6 href=#__codelineno-118-6></a>$ kubectl delete virtualservice nginx
</code></pre></div> <ol> <li>删除包含证书的目录和用于生成证书的存储库：</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a>$ rm -rf nginx.example.com mtls-go-example
</code></pre></div> <ol> <li>删除此示例中使用的生成的配置文件：</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-120-1 name=__codelineno-120-1 href=#__codelineno-120-1></a>$ rm -f ./nginx.conf
</code></pre></div> <ul> <li></li> </ul> <h6 id=2egress-tls>2.Egress 网关的 TLS 发起过程<a class=headerlink href=#2egress-tls title="Permanent link">&para;</a></h6> <h6 id=3-tls>3.出口流量的 TLS<a class=headerlink href=#3-tls title="Permanent link">&para;</a></h6> <h6 id=4-egress-gateway>4.配置 Egress gateway<a class=headerlink href=#4-egress-gateway title="Permanent link">&para;</a></h6> <h6 id=5-egress>5.使用通配符主机配置 Egress 流量<a class=headerlink href=#5-egress title="Permanent link">&para;</a></h6> <h6 id=6egress-tls-sni>6.Egress TLS 流量中的 SNI 监控及策略<a class=headerlink href=#6egress-tls-sni title="Permanent link">&para;</a></h6> <h6 id=7-https>7.连接到外部 HTTPS 代理<a class=headerlink href=#7-https title="Permanent link">&para;</a></h6> <h6 id=8-cert-manager-kubernetes-ingress>8.使用 cert-manager 加密 Kubernetes Ingress<a class=headerlink href=#8-cert-manager-kubernetes-ingress title="Permanent link">&para;</a></h6> <h4 id=_45>安全<a class=headerlink href=#_45 title="Permanent link">&para;</a></h4> <h5 id=http_1>HTTP 服务的访问控制<a class=headerlink href=#http_1 title="Permanent link">&para;</a></h5> <p>Istio 采用基于角色的访问控制方式，本文内容涵盖了为 HTTP 设置访问控制的各个环节。在<a href=https://istio.io/zh/docs/concepts/security/ >认证概念</a>一文中提供了 Istio 安全方面的入门教程。</p> <h4 id=_46>遥测<a class=headerlink href=#_46 title="Permanent link">&para;</a></h4> <h5 id=_47>指标度量<a class=headerlink href=#_47 title="Permanent link">&para;</a></h5> <h6 id=_48>收集指标和日志<a class=headerlink href=#_48 title="Permanent link">&para;</a></h6> <h6 id=tcp_2>获取 TCP 服务指标<a class=headerlink href=#tcp_2 title="Permanent link">&para;</a></h6> <h6 id=prometheus>查询 Prometheus 的指标<a class=headerlink href=#prometheus title="Permanent link">&para;</a></h6> <h6 id=grafana>使用 Grafana 可视化指标度量<a class=headerlink href=#grafana title="Permanent link">&para;</a></h6> <h5 id=_49>分布式追踪<a class=headerlink href=#_49 title="Permanent link">&para;</a></h5> <h6 id=_50>概述<a class=headerlink href=#_50 title="Permanent link">&para;</a></h6> <h6 id=jaeger>Jaeger<a class=headerlink href=#jaeger title="Permanent link">&para;</a></h6> <h6 id=zipkin>Zipkin<a class=headerlink href=#zipkin title="Permanent link">&para;</a></h6> <h6 id=lightstep-xpm>使用 LightStep [𝑥]PM 进行分布式追踪<a class=headerlink href=#lightstep-xpm title="Permanent link">&para;</a></h6> <h5 id=_51>日志<a class=headerlink href=#_51 title="Permanent link">&para;</a></h5> <h6 id=envoy>获取 Envoy 访问日志<a class=headerlink href=#envoy title="Permanent link">&para;</a></h6> <h6 id=_52>收集日志<a class=headerlink href=#_52 title="Permanent link">&para;</a></h6> <h6 id=fluentd>使用 Fluentd 记录日志<a class=headerlink href=#fluentd title="Permanent link">&para;</a></h6> <h5 id=_53>网格可视化<a class=headerlink href=#_53 title="Permanent link">&para;</a></h5> <h5 id=_54>遥测插件的远程访问<a class=headerlink href=#_54 title="Permanent link">&para;</a></h5> <h2 id=43-k8s-istio>4.3 k8s 集群上安装istio<a class=headerlink href=#43-k8s-istio title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-121-1 name=__codelineno-121-1 href=#__codelineno-121-1></a><span class=c1># 下载istio</span>
<a id=__codelineno-121-2 name=__codelineno-121-2 href=#__codelineno-121-2></a>curl<span class=w> </span>-L<span class=w> </span>https://git.io/getLatestIstio<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>ISTIO_VERSION</span><span class=o>=</span><span class=m>1</span>.2.2<span class=w> </span>sh<span class=w> </span>-
<a id=__codelineno-121-3 name=__codelineno-121-3 href=#__codelineno-121-3></a>
<a id=__codelineno-121-4 name=__codelineno-121-4 href=#__codelineno-121-4></a><span class=nb>export</span><span class=w> </span><span class=nv>PATH</span><span class=o>=</span><span class=nv>$PWD</span>/bin:<span class=nv>$PATH</span>
<a id=__codelineno-121-5 name=__codelineno-121-5 href=#__codelineno-121-5></a>
<a id=__codelineno-121-6 name=__codelineno-121-6 href=#__codelineno-121-6></a><span class=c1># 创建ns</span>
<a id=__codelineno-121-7 name=__codelineno-121-7 href=#__codelineno-121-7></a>kubectl<span class=w> </span>create<span class=w> </span>namespace<span class=w> </span>istio-system
<a id=__codelineno-121-8 name=__codelineno-121-8 href=#__codelineno-121-8></a>
<a id=__codelineno-121-9 name=__codelineno-121-9 href=#__codelineno-121-9></a><span class=c1># 使用 kubectl apply 安装所有的 Istio CRD，命令执行之后，会隔一段时间才能被 Kubernetes API Server 收到：</span>
<a id=__codelineno-121-10 name=__codelineno-121-10 href=#__codelineno-121-10></a>helm<span class=w> </span>template<span class=w> </span>install/kubernetes/helm/istio-init<span class=w> </span>--name<span class=w> </span>istio-init<span class=w> </span>--namespace<span class=w> </span>istio-system<span class=w> </span><span class=p>|</span><span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-
</code></pre></div> <p><img alt=image-20190804183420404 src="/Users/xuel/Library/Application Support/typora-user-images/image-20190804183420404.png"></p> <h1 id=_55>相关链接<a class=headerlink href=#_55 title="Permanent link">&para;</a></h1> <ul> <li><a href=https://codelabs.developers.google.com/codelabs/cloud-hello-istio/#0>codelab</a></li> <li><a href=https://jimmysong.io/posts/deploy-bookinfo-microservices-on-kubernetes-with-istio/ >在kubernetes集群上安装istio并测试bookinfo示例微服务</a></li> <li><a href=https://istio.io/zh/ >istio中文文档</a></li> <li><a href=https://skyao.io/learning-istio/ >istio 学习笔记</a></li> <li><a href=https://www.katacoda.com/courses/istio/deploy-istio-on-kubernetes>https://www.katacoda.com/courses/istio/deploy-istio-on-kubernetes</a></li> <li><a href=https://skyao.io/talk/201811-knative-redefine-serverless/ >https://skyao.io/talk/201811-knative-redefine-serverless/</a></li> <li><a href=https://yq.aliyun.com/articles/221687>https://yq.aliyun.com/articles/221687</a></li> <li><a href=https://jimmysong.io/kubernetes-handbook/develop/minikube.html>https://jimmysong.io/kubernetes-handbook/develop/minikube.html</a></li> <li><a href=https://www.cnblogs.com/163yun/p/8962278.html>深入解读 Service Mesh 背后的技术细节 by 刘超</a></li> <li><a href=https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/ >Istio流量管理实现机制深度解析 by 赵化冰</a></li> <li><a href=https://skyao.io/post/201804-servicemesh-architecture-introspection/ >Service Mesh架构反思：数据平面和控制平面的界线该如何划定？by 敖小剑</a></li> <li><a href=https://jimmysong.io/posts/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/ >理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持 by 宋净超</a></li> <li><a href=http://www.servicemesher.com/blog/istio-service-mesh-source-code-pilot-agent-deepin>Service Mesh 深度学习系列——Istio源码分析之pilot-agent模块分析 by 丁轶群</a></li> <li><a href=https://qii404.me/2018/01/06/minukube.html>https://qii404.me/2018/01/06/minukube.html</a></li> <li><a href="https://mp.weixin.qq.com/s?__biz=MzI3MTI2NzkxMA==&mid=2247486226&idx=1&sn=9573a9ce3d1665da2440ac80a971d2ae&chksm=eac52a3bddb2a32d90a610b247800826152d47889a8ce29635857c19eb84e4f1cbe124a8291f&token=1276805921&lang=zh_CN#rd">https://mp.weixin.qq.com/s?__biz=MzI3MTI2NzkxMA==&amp;mid=2247486226&amp;idx=1&amp;sn=9573a9ce3d1665da2440ac80a971d2ae&amp;chksm=eac52a3bddb2a32d90a610b247800826152d47889a8ce29635857c19eb84e4f1cbe124a8291f&amp;token=1276805921&amp;lang=zh_CN#rd</a></li> <li><a href=https://zhaohuabing.com/istio-practice/ >https://zhaohuabing.com/istio-practice/</a></li> <li><a href=https://skyao.io/learning-istio/introduction/information.html>https://skyao.io/learning-istio/introduction/information.html</a></li> <li><a href=https://github.com/servicemesher/istio-knowledge-map>https://github.com/servicemesher/istio-knowledge-map</a></li> </ul> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/redhatxl/redhatxl.github.io/issues/new/?title=[Feedback]+istio%E7%AC%94%E8%AE%B0+-+/cloud-native/servicemesh/istio/istio%E7%AC%94%E8%AE%B0/" target=_blank>feedback form</a>. </div> </div> </div> </fieldset> </form> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2016 - 2024 kaliarch </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/redhatxl target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220125122524.png target=_blank rel=noopener title=kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154zm-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4zm-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2zM563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4zm-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6zm107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">同意</button> <label class=md-button for=__settings>管理设定</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../../../..", "features": ["content.code.annotate", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../../assets/javascripts/bundle.bd41221c.min.js></script> </body> </html>
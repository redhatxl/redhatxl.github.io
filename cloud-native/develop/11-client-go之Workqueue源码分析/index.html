<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="stay hungry,stay foolish"><meta name=author content=Kaliarch><link href=https://redhatxl.github.io/cloud-native/develop/11-client-go%E4%B9%8BWorkqueue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ rel=canonical><link href=../10-client-go%E4%B9%8BIndexer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ rel=prev><link href=../12-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0Controller/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.16"><title>11.Client-go源码分析之WorkQueue - Kaliarch Blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.bcfcd587.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-G9D2HRH134"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-G9D2HRH134",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-G9D2HRH134",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#11client-goworkqueue class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="Kaliarch Blog" class="md-header__button md-logo" aria-label="Kaliarch Blog" data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kaliarch Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 11.Client-go源码分析之WorkQueue </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=light-blue data-md-color-accent=purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/redhatxl/redhatxl.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> redhatxl.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> 首页 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../01-k8s%20%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D/ class=md-tabs__link> 云原生 </a> </li> <li class=md-tabs__item> <a href=../../../devops/Gitlab%20CI/01%E6%95%8F%E6%8D%B7%E6%97%A0%E6%95%8C%E4%B9%8B%E5%AE%9E%E6%88%98Gitlab%20CI/ class=md-tabs__link> devops </a> </li> <li class=md-tabs__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/ class=md-tabs__link> 开发技术 </a> </li> <li class=md-tabs__item> <a href=../../../linux/system/Linux%20grub%3Agrub2%E8%AF%A6%E8%A7%A3/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../other/ class=md-tabs__link> 其他 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Kaliarch Blog" class="md-nav__button md-logo" aria-label="Kaliarch Blog" data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> Kaliarch Blog </label> <div class=md-nav__source> <a href=https://github.com/redhatxl/redhatxl.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> redhatxl.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> 云原生 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> 云原生 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> 开发 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../01-k8s%20%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D/ class=md-nav__link> <span class=md-ellipsis> 1.K8s 开发概念简介 </span> </a> </li> <li class=md-nav__item> <a href=../02-K8s%20API%20%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.K8s API访问方式 </span> </a> </li> <li class=md-nav__item> <a href=../03-Client-go%20%E4%BD%BF%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 3.Client-go 的使用 </span> </a> </li> <li class=md-nav__item> <a href=../04-Cobra%20%2B%20Client-go%E5%AE%9E%E7%8E%B0K8s%E7%AE%80%E5%8D%95%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 4.Cobra+Client-go实现K8s插件开发 </span> </a> </li> <li class=md-nav__item> <a href=../05-client-go%E4%B9%8BListWatcher%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 5.Client-go源码分析之ListerWatcher </span> </a> </li> <li class=md-nav__item> <a href=../06-client-go%E4%B9%8BReflector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 6.Client-go源码分析之Reflector </span> </a> </li> <li class=md-nav__item> <a href=../07-client-go%E4%B9%8BDeltaFIFO%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 7.Client-go源码分析之DeltaFIFO </span> </a> </li> <li class=md-nav__item> <a href=../08-client-go%E4%B9%8BInformer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 8.Client-go源码分析之Informer </span> </a> </li> <li class=md-nav__item> <a href=../09-client-go%E4%B9%8BSharedInformer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 9.Client-go源码分析之SharedInformer </span> </a> </li> <li class=md-nav__item> <a href=../10-client-go%E4%B9%8BIndexer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 10.Client-go源码分析之Indexer </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 11.Client-go源码分析之WorkQueue </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 11.Client-go源码分析之WorkQueue </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 一 前言 </span> </a> </li> <li class=md-nav__item> <a href=#workqueue class=md-nav__link> <span class=md-ellipsis> 二 WorkQueue相关概念及构成 </span> </a> <nav class=md-nav aria-label="二 WorkQueue相关概念及构成"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21 class=md-nav__link> <span class=md-ellipsis> 2.1 分类 </span> </a> </li> <li class=md-nav__item> <a href=#22 class=md-nav__link> <span class=md-ellipsis> 2.2 特征 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 三 源码分析 </span> </a> <nav class=md-nav aria-label="三 源码分析"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31 class=md-nav__link> <span class=md-ellipsis> 3.1 通用队列 </span> </a> <nav class=md-nav aria-label="3.1 通用队列"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#311 class=md-nav__link> <span class=md-ellipsis> 3.1.1 队列接口 </span> </a> </li> <li class=md-nav__item> <a href=#312 class=md-nav__link> <span class=md-ellipsis> 3.1.2 队列实现 </span> </a> </li> <li class=md-nav__item> <a href=#313 class=md-nav__link> <span class=md-ellipsis> 3.1.3 通用队列方法 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> <span class=md-ellipsis> 3.2 延迟队列 </span> </a> <nav class=md-nav aria-label="3.2 延迟队列"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#321 class=md-nav__link> <span class=md-ellipsis> 3.2.1 延迟队列接口 </span> </a> </li> <li class=md-nav__item> <a href=#322 class=md-nav__link> <span class=md-ellipsis> 3.2.2 延迟队列实现 </span> </a> </li> <li class=md-nav__item> <a href=#323 class=md-nav__link> <span class=md-ellipsis> 3.2.3 延迟队列方法 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#33 class=md-nav__link> <span class=md-ellipsis> 3.3 限速队列 </span> </a> <nav class=md-nav aria-label="3.3 限速队列"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#331 class=md-nav__link> <span class=md-ellipsis> 3.3.1 限速队列接口 </span> </a> </li> <li class=md-nav__item> <a href=#332 class=md-nav__link> <span class=md-ellipsis> 3.3.2 限速队列实现 </span> </a> </li> <li class=md-nav__item> <a href=#333 class=md-nav__link> <span class=md-ellipsis> 3.3.3 限速器方法 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 四 小试牛刀 </span> </a> <nav class=md-nav aria-label="四 小试牛刀"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41 class=md-nav__link> <span class=md-ellipsis> 4.1 通用队列 </span> </a> </li> <li class=md-nav__item> <a href=#42 class=md-nav__link> <span class=md-ellipsis> 4.2 延迟队列 </span> </a> </li> <li class=md-nav__item> <a href=#43 class=md-nav__link> <span class=md-ellipsis> 4.3 限速队列 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 参考链接 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../12-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0Controller/ class=md-nav__link> <span class=md-ellipsis> 12.自定义实现Controller </span> </a> </li> <li class=md-nav__item> <a href=../13-%E8%AE%A4%E8%AF%86CRD/ class=md-nav__link> <span class=md-ellipsis> 13.认识CRD </span> </a> </li> <li class=md-nav__item> <a href=../x-Informer%E5%AE%9E%E6%88%98%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96K8s%E4%BA%8B%E4%BB%B6%E8%87%B3ElasticSearch/ class=md-nav__link> <span class=md-ellipsis> x-Informer实战之持久化K8s事件至ElasticSearch </span> </a> </li> <li class=md-nav__item> <a href=../x-DeltaFIFO%E5%92%8Cindexer%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AF%B9%E6%AF%94/ class=md-nav__link> <span class=md-ellipsis> x-DeltaFIFO 与 Indexer关系 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> 运维 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 运维 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1> <label class=md-nav__link for=__nav_2_2_1 id=__nav_2_2_1_label tabindex=0> <span class=md-ellipsis> 工具 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1> <span class="md-nav__icon md-icon"></span> 工具 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operator/tools/K8s%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E4%B9%8BKUR8/ class=md-nav__link> <span class=md-ellipsis> K8s可视化工具之KUR8 </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/K8s%E5%BF%AB%E6%8D%B7%E6%93%8D%E4%BD%9C%E5%B7%A5%E5%85%B7%E4%B9%8BK9s/ class=md-nav__link> <span class=md-ellipsis> K8s快捷操作工具之K9s </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/K8s%E8%89%B2%E5%BD%A9%E8%BE%93%E5%87%BA%E5%B7%A5%E5%85%B7%E4%B9%8Bkubecolor/ class=md-nav__link> <span class=md-ellipsis> K8s色彩输出工具之kubecolor </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/K8s%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B%E7%A5%9E%E5%99%A8%E4%B9%8Bkubetail/ class=md-nav__link> <span class=md-ellipsis> K8s日志查看利器之kubetail </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/K8s%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7%E4%B9%8Bsniff/ class=md-nav__link> <span class=md-ellipsis> K8s 网络抓包之sniff </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/Kubernetes%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> Kubernetes 六款备份还原工具 </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/k8s%E6%8F%92%E4%BB%B6%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E4%B9%8Bkrew/ class=md-nav__link> <span class=md-ellipsis> k8s 插件管理工具之krew </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/%E6%9E%B6%E6%9E%84%E5%9B%BE%E7%A5%9E%E5%99%A8DaC%E4%B9%8BDiagram/ class=md-nav__link> <span class=md-ellipsis> 架构图神器DaC之Diagram </span> </a> </li> <li class=md-nav__item> <a href=../../operator/tools/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E4%B9%8Bvelero%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 云原生备份恢复之velero实战 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2 id=__nav_2_2_2_label tabindex=0> <span class=md-ellipsis> 部署 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> 部署 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operator/deploy/Ceph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/ class=md-nav__link> <span class=md-ellipsis> Ceph机器安装部署 </span> </a> </li> <li class=md-nav__item> <a href=../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E4%B9%8Bminikube/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之Minikube </span> </a> </li> <li class=md-nav__item> <a href=../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B9%8BK3s/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之K3s </span> </a> </li> <li class=md-nav__item> <a href=../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B9%8BKind/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之Kind </span> </a> </li> <li class=md-nav__item> <a href=../../operator/deploy/%E6%9C%80%E5%B0%8F%E5%8C%96K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B9%8BMicroK8s/ class=md-nav__link> <span class=md-ellipsis> 最小化K8s环境部署之MicroK8s </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3> <label class=md-nav__link for=__nav_2_2_3 id=__nav_2_2_3_label tabindex=0> <span class=md-ellipsis> servicemesh </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3> <span class="md-nav__icon md-icon"></span> servicemesh </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_1> <label class=md-nav__link for=__nav_2_2_3_1 id=__nav_2_2_3_1_label tabindex=0> <span class=md-ellipsis> istio </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3_1> <span class="md-nav__icon md-icon"></span> istio </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../servicemesh/istio/Envoy%E7%AC%94%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> Envoy笔记 </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/服务网格进阶实战.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/详解.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio%E4%B9%8BXDS%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> Istio之XDS协议解析 </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio%E7%AC%94%E8%AE%B0%E4%B9%8BGateway/ class=md-nav__link> <span class=md-ellipsis> Istio笔记之Gateway </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio%E7%AC%94%E8%AE%B0%E4%B9%8Bpilot/ class=md-nav__link> <span class=md-ellipsis> Istio笔记之pilot </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/ class=md-nav__link> <span class=md-ellipsis> Istio灰度发布 </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio之流量管理.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio%E7%AE%80%E4%BB%8B%E5%8F%8A%E6%9E%B6%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> Istio简介及架构 </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E7%AC%94%E8%AE%B0%28%E4%B8%80%29/ class=md-nav__link> <span class=md-ellipsis> Istio微服务治理笔记(一) </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/Istio%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%BB%9C/ class=md-nav__link> <span class=md-ellipsis> Istio基础之服务网络 </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/微服务金丝雀发布.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../servicemesh/istio/istio%E7%AC%94%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> istio笔记 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_4> <label class=md-nav__link for=__nav_2_2_4 id=__nav_2_2_4_label tabindex=0> <span class=md-ellipsis> 排错 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_4> <span class="md-nav__icon md-icon"></span> 排错 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operator/other/k8s%20%E9%9B%86%E7%BE%A4etcd%E6%8E%92%E9%94%99/ class=md-nav__link> <span class=md-ellipsis> k8s 集群etcd排错 </span> </a> </li> <li class=md-nav__item> <a href=../../operator/other/CronHPA/ class=md-nav__link> <span class=md-ellipsis> CronHPA初探 </span> </a> </li> <li class=md-nav__item> <a href=../../operator/other/%E8%AE%B0%E4%B8%80%E6%AC%A1K8smaster%20%E8%8A%82%E7%82%B9%E4%B8%80%E6%AC%A1%E6%8E%92%E9%94%99%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 记一次K8smaster 节点一次排错实战 </span> </a> </li> <li class=md-nav__item> <a href=../../operator/other/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8Ak8s%E8%8A%82%E7%82%B9%E7%BB%B4%E6%8A%A4/ class=md-nav__link> <span class=md-ellipsis> 记一次线上k8s节点维护 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_5> <label class=md-nav__link for=__nav_2_2_5 id=__nav_2_2_5_label tabindex=0> <span class=md-ellipsis> 容器 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_5> <span class="md-nav__icon md-icon"></span> 容器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E5%AE%B9%E5%99%A8/Dockerfile%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Dockerfile 最佳实践 </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%B9%E5%99%A8/Docker%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> Docker底层原理 </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%B9%E5%99%A8/podman%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Podman详解 </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%B9%E5%99%A8/%E5%88%A9%E7%94%A8katacoda%20%E5%AE%9E%E7%8E%B0%E6%8B%89%E5%8F%96%E5%9B%BD%E5%A4%96%E9%95%9C%E5%83%8F/ class=md-nav__link> <span class=md-ellipsis> 利用katacoda实现拉取国外镜像 </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%B9%E5%99%A8/%E9%95%9C%E5%83%8F%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 镜像底层原理 </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%B9%E5%99%A8/Harbor%E5%92%8Cregistry%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/ class=md-nav__link> <span class=md-ellipsis> Harbor/registry镜像仓库部署 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> 安全 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 安全 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BKube-bench/ class=md-nav__link> <span class=md-ellipsis> K8s 安全之Kube-bench </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/Kubeeye%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> KubeEye源码分析 </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BKubeeye/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全之KubeEye </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BNPD/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全之NPD </span> </a> </li> <li class=md-nav__item> <a href="../../安全/Kubernetes安全之Open/ Policy/ Agent.md" class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8Bopenebs/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全之openebs </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全分析 </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/kubernetes%E5%AE%89%E5%85%A8%E4%B9%8BPolaris/ class=md-nav__link> <span class=md-ellipsis> kubernetes安全之Polaris </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/Kubernetes%E5%AE%89%E5%85%A8%E4%B9%8Bkubescape/ class=md-nav__link> <span class=md-ellipsis> Kubernetes安全扫描之kubescape </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%AE%89%E5%85%A8%E4%B9%8BTrivy/ class=md-nav__link> <span class=md-ellipsis> 镜像安全扫描之Trivy </span> </a> </li> <li class=md-nav__item> <a href=../../%E5%AE%89%E5%85%A8/%E5%BC%80%E6%BA%90%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8%E5%B9%B3%E5%8F%B0%E4%B9%8BNeuVector/ class=md-nav__link> <span class=md-ellipsis> 开源容器安全平台之NeuVector </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/inside-kubernetes%20controller/ class=md-nav__link> <span class=md-ellipsis> Inside Kubernetes controller </span> </a> </li> <li class=md-nav__item> <a href=../../other/Kubectl插件开发及开业分享.md class=md-nav__link> <span class=md-ellipsis> None </span> </a> </li> <li class=md-nav__item> <a href=../../other/KubeEdge/ class=md-nav__link> <span class=md-ellipsis> KubeEdge初探 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Kubernetes%E5%BC%80%E5%8F%91%E6%8E%92%E9%94%99%E6%9D%82%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> Kubernetes开发排错杂记 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Kubernetes%E7%94%9F%E6%88%90kubeconfig/ class=md-nav__link> <span class=md-ellipsis> Kubernetes生成kubeconfig </span> </a> </li> <li class=md-nav__item> <a href=../../other/%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%8E%9F%E7%94%9FCCE%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 华为云原生CCE实战 </span> </a> </li> <li class=md-nav__item> <a href=../../other/%E5%BE%AE%E6%9C%8D%E5%8A%A1API%E7%BD%91%E5%85%B3-Kong/ class=md-nav__link> <span class=md-ellipsis> 微服务API网关-Kong </span> </a> </li> <li class=md-nav__item> <a href=../../other/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%AD10%E7%A7%8D%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 微服务架构中10种常用设计模式 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> devops </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> devops </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> GitLab CI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> GitLab CI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/Gitlab%20CI/01%E6%95%8F%E6%8D%B7%E6%97%A0%E6%95%8C%E4%B9%8B%E5%AE%9E%E6%88%98Gitlab%20CI/ class=md-nav__link> <span class=md-ellipsis> 1.敏捷无敌之Gitlab CI </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/Gitlab%20CI/02%E6%95%8F%E6%8D%B7%E6%97%A0%E6%95%8C%E4%B9%8BGitlab%20CI%E6%9E%B6%E6%9E%84%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> 2.敏捷无敌之Gitlab CI架构流程详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/Gitlab%20CI/03%E5%AE%9E%E6%88%98Gitlab%20CI%20%2B%20Supervisor%20%E5%8F%91%E5%B8%83Python%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> 3.实战Gitlab CI + Supervisor 发布Python项目 </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/Gitlab%20CI/04%E5%AE%9E%E6%88%98%E5%89%8D%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE%E5%8F%8A%E6%B7%B7%E5%90%88%E7%8E%AF%E5%A2%83Gitlab%20CI/ class=md-nav__link> <span class=md-ellipsis> 4.实战前后端项目及混合环境Gitlab CI </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/Gitlab%20CI/05%E5%AE%9E%E6%88%98Gitlab%20CI%20%2B%20Kubernetes%20%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83/ class=md-nav__link> <span class=md-ellipsis> 5.实战Kubernetes Gitlab CI </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/Gitlab%20CI/Gitlab%20CI%E4%B9%8B%20%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E4%BB%A3%E7%A0%81%E6%89%AB%E6%8F%8F/ class=md-nav__link> <span class=md-ellipsis> Gitlab CI之单元测试和代码扫描 </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/Gitlab%20CI/Gitlab%20CI%E8%BF%9B%E9%98%B6%E4%B9%8B%E5%85%B1%E4%BA%ABCI%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> Gitlab CI进阶之共享CI库 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> IaC </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> IaC </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/IaC/Terraform/IaC%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7%E4%B9%8BTerrascan/ class=md-nav__link> <span class=md-ellipsis> IaC扫描工具之Terrascan </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/IaC/Terraform/IaC%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E4%B9%8BTerratest/ class=md-nav__link> <span class=md-ellipsis> IaC测试工具之Terratest </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/IaC/Terraform/terraform-book/ class=md-nav__link> <span class=md-ellipsis> Terraform book </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/IaC/Terraform/Terraform%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> Terraform 相关概念及函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/IaC/Terraform/terraform%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Terraform 最佳实践 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/other/Argo%20CD/ class=md-nav__link> <span class=md-ellipsis> Argo CD </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/other/IaC%E4%B9%8BTerraform%20%E4%B8%8EPulumi%E4%BD%BF%E7%94%A8%E5%AF%B9%E6%AF%94/ class=md-nav__link> <span class=md-ellipsis> IaC之Terraform 与Pulumi使用对比 </span> </a> </li> <li class=md-nav__item> <a href=../../../devops/other/Packer/ class=md-nav__link> <span class=md-ellipsis> 镜像定义工具Packer实战 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> 开发技术 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 开发技术 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> 设计模式 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> 设计模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_1> <label class=md-nav__link for=__nav_4_1_1 id=__nav_4_1_1_label tabindex=0> <span class=md-ellipsis> 创建型 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_1> <span class="md-nav__icon md-icon"></span> 创建型 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 1.简单工厂模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/02-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.工厂方法模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/03-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 3.抽象工厂模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/04-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 4.建造者(生成器)模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B/05-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 5.单例模式 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_2> <label class=md-nav__link for=__nav_4_1_2 id=__nav_4_1_2_label tabindex=0> <span class=md-ellipsis> 结构型 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_2> <span class="md-nav__icon md-icon"></span> 结构型 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 1.装饰器模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/02-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.代理模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/03-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 3.桥接模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B/04-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 4.适配器模式 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_3> <label class=md-nav__link for=__nav_4_1_3 id=__nav_4_1_3_label tabindex=0> <span class=md-ellipsis> 行为型 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_3> <span class="md-nav__icon md-icon"></span> 行为型 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/01-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 1.策略模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/02-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.观察者模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/03-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%A8%A1%E7%89%88%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 2.模版模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B/04-golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%81%8C%E8%B4%A3%E9%93%BE%E6%A8%A1%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 4.职责链模式 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Golang </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_1> <label class=md-nav__link for=__nav_4_2_1 id=__nav_4_2_1_label tabindex=0> <span class=md-ellipsis> Gin </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_1> <span class="md-nav__icon md-icon"></span> Gin </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../develop/Golang/gin/gin%20%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E7%83%AD%E5%8A%A0%E8%BD%BD/ class=md-nav__link> <span class=md-ellipsis> Gin框架热加载 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/Golang/gin/gin-swagger/ class=md-nav__link> <span class=md-ellipsis> Gin + Swagger快速生成API文档 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/Golang/gin/gin-validator%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/ class=md-nav__link> <span class=md-ellipsis> gin-validator参数校验 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/Golang/gin/gin%E6%A1%86%E6%9E%B6%E4%BC%98%E9%9B%85%E5%85%B3%E6%9C%BA%E9%87%8D%E5%90%AF/ class=md-nav__link> <span class=md-ellipsis> Gin框架优雅关机和重启 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_2> <label class=md-nav__link for=__nav_4_2_2 id=__nav_4_2_2_label tabindex=0> <span class=md-ellipsis> 开发规范 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_2> <span class="md-nav__icon md-icon"></span> 开发规范 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%80%A7%E8%83%BD01/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之性能01 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8301/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范01 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8302/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范02 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8303/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范03 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E8%A7%84%E8%8C%8304/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之规范04 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9901/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则01 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F01/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之编程模式01 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9902/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则02 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9903/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则03 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9904/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则04 </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/%E8%A7%84%E8%8C%83/uber-go%20%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/Golang%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E4%B9%8B%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%9905/ class=md-nav__link> <span class=md-ellipsis> Golang编码规范之指导原则05 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_3> <label class=md-nav__link for=__nav_4_2_3 id=__nav_4_2_3_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_3> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../develop/Golang/golang%20%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E6%9C%80%E7%BB%88%E4%B9%8Bjaeger/ class=md-nav__link> <span class=md-ellipsis> Golang 分布式链路追踪之jaeger </span> </a> </li> <li class=md-nav__item> <a href=../../../develop/Golang/golang%20%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/ class=md-nav__link> <span class=md-ellipsis> Go 内存对齐 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1 id=__nav_5_1_label tabindex=0> <span class=md-ellipsis> 系统相关 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> 系统相关 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/system/Linux%20grub%3Agrub2%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Linux grub/grub2详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/system/Linux%20%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Linux 内核引导详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Linux 系统安全加固最佳实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/system/virtio%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Virtio 详解 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> Shell </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/shell/Shell%E7%AE%80%E4%BB%8B/ class=md-nav__link> <span class=md-ellipsis> Shell 教程概述 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/ class=md-nav__link> <span class=md-ellipsis> 1.第一个 Shell 程序 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/2.Shell%E5%8F%98%E9%87%8F/ class=md-nav__link> <span class=md-ellipsis> 2.Shell 变量 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/3.Shell%E5%8F%82%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 3.Shell 参数 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/4.Shell%E6%95%B0%E7%BB%84/ class=md-nav__link> <span class=md-ellipsis> 4.Shell数组 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/ class=md-nav__link> <span class=md-ellipsis> 5.Shell 运算符 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/6.Shell%20echo%3Aprintf%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 6.Shell echo/printf 命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 7.Shell test 命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> 8.Shell 流程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/9.Shell%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 8.Shell 函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/10.Shell%E8%BE%93%E5%85%A5%3A%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/ class=md-nav__link> <span class=md-ellipsis> 10.Shell输入/输出重定向 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 11.Shell 正则表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/ class=md-nav__link> <span class=md-ellipsis> 12.Shell 三剑客之grep </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/ class=md-nav__link> <span class=md-ellipsis> 13.Shell三剑客之sed </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/ class=md-nav__link> <span class=md-ellipsis> 14.Shell三剑客之awk </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> 15.Shell常用工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> 16.Shell实战项目 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../other/ class=md-nav__link> <span class=md-ellipsis> 工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../other/ class=md-nav__link> <span class=md-ellipsis> 杂记 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 一 前言 </span> </a> </li> <li class=md-nav__item> <a href=#workqueue class=md-nav__link> <span class=md-ellipsis> 二 WorkQueue相关概念及构成 </span> </a> <nav class=md-nav aria-label="二 WorkQueue相关概念及构成"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21 class=md-nav__link> <span class=md-ellipsis> 2.1 分类 </span> </a> </li> <li class=md-nav__item> <a href=#22 class=md-nav__link> <span class=md-ellipsis> 2.2 特征 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 三 源码分析 </span> </a> <nav class=md-nav aria-label="三 源码分析"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31 class=md-nav__link> <span class=md-ellipsis> 3.1 通用队列 </span> </a> <nav class=md-nav aria-label="3.1 通用队列"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#311 class=md-nav__link> <span class=md-ellipsis> 3.1.1 队列接口 </span> </a> </li> <li class=md-nav__item> <a href=#312 class=md-nav__link> <span class=md-ellipsis> 3.1.2 队列实现 </span> </a> </li> <li class=md-nav__item> <a href=#313 class=md-nav__link> <span class=md-ellipsis> 3.1.3 通用队列方法 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> <span class=md-ellipsis> 3.2 延迟队列 </span> </a> <nav class=md-nav aria-label="3.2 延迟队列"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#321 class=md-nav__link> <span class=md-ellipsis> 3.2.1 延迟队列接口 </span> </a> </li> <li class=md-nav__item> <a href=#322 class=md-nav__link> <span class=md-ellipsis> 3.2.2 延迟队列实现 </span> </a> </li> <li class=md-nav__item> <a href=#323 class=md-nav__link> <span class=md-ellipsis> 3.2.3 延迟队列方法 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#33 class=md-nav__link> <span class=md-ellipsis> 3.3 限速队列 </span> </a> <nav class=md-nav aria-label="3.3 限速队列"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#331 class=md-nav__link> <span class=md-ellipsis> 3.3.1 限速队列接口 </span> </a> </li> <li class=md-nav__item> <a href=#332 class=md-nav__link> <span class=md-ellipsis> 3.3.2 限速队列实现 </span> </a> </li> <li class=md-nav__item> <a href=#333 class=md-nav__link> <span class=md-ellipsis> 3.3.3 限速器方法 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 四 小试牛刀 </span> </a> <nav class=md-nav aria-label="四 小试牛刀"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41 class=md-nav__link> <span class=md-ellipsis> 4.1 通用队列 </span> </a> </li> <li class=md-nav__item> <a href=#42 class=md-nav__link> <span class=md-ellipsis> 4.2 延迟队列 </span> </a> </li> <li class=md-nav__item> <a href=#43 class=md-nav__link> <span class=md-ellipsis> 4.3 限速队列 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 参考链接 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=11client-goworkqueue>11.Client-go源码分析之WorkQueue<a class=headerlink href=#11client-goworkqueue title="Permanent link">&para;</a></h1> <h2 id=_1>一 前言<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>在上文SharedInformer中，最后将资源对象已经写入到事件回调函数中，此后我们直接处理这些数据即可，但是我们使用golang中的chanel来处理会存在处理效率低，存在数据大并发量，数据积压等其他异常情况，为此client-go单独将workqueue提出来，作为公共组件，不仅可以在Kubernetes内部使用，还可以供Client-go使用，用户侧可以通过Workqueue相关方法进行更加灵活的队列处理，如失败重试，延迟入队，限速控制等，实现非阻塞异步逻辑处理。</p> <h2 id=workqueue>二 WorkQueue相关概念及构成<a class=headerlink href=#workqueue title="Permanent link">&para;</a></h2> <h3 id=21>2.1 分类<a class=headerlink href=#21 title="Permanent link">&para;</a></h3> <p>WorkQueue 支持 3 种队列，并提供了 3 种接口，不同队列实现可应对不同的使用场景，分别介绍如下。</p> <ul> <li><strong>Interface</strong>：通用队FIFO 队列接口，先进先出队列，并支持去重机制。</li> <li><strong>DelayingInterface</strong>：延迟队列接口，基于 Interface 接口封装，延迟一段时间后再将元素存入队列。</li> <li><strong>RateLimitingInterface</strong>：限速队列接口，基于 DelayingInterface 接口封装，支持元素存入队列时进行速率限制。</li> </ul> <p><img alt src=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220202134307.png></p> <p>从图中可以看到，workqueue.RateLimitingInterface 集成了 DelayingInterface，DelayingInterface 集成了 Interface，最终由 rateLimitingType 进行实现，提供了 rateLimit 限速、delay 延时入队(由优先级队列通过小顶堆实现)、queue 队列处理 三大核心能力，另外，在代码中可看到 K8s 实现了三种 RateLimiter：BucketRateLimiter, ItemExponentialFailureRateLimiter, ItemFastSlowRateLimiter。</p> <h3 id=22>2.2 特征<a class=headerlink href=#22 title="Permanent link">&para;</a></h3> <p>WorkQueue 称为工作队列，Kubernetes 的 WorkQueue 队列与普通 FIFO（先进先出，First-In, First-Out）队列相比，实现略显复杂，它的主要功能在于标记和去重，并支持如下特性。</p> <ul> <li><strong>有序</strong>：按照添加顺序处理元素（item）。</li> <li><strong>去重</strong>：相同元素在同一时间不会被重复处理，例如一个元素在处理之前被添加了多次，它只会被处理一次。</li> <li><strong>并发性</strong>：多生产者和多消费者。</li> <li><strong>标记机制</strong>：支持标记功能，标记一个元素是否被处理，也允许元素在处理时重新排队。</li> <li><strong>通知机制</strong>：ShutDown 方法通过信号量通知队列不再接收新的元素，并通知 metric goroutine 退出。</li> <li><strong>延迟</strong>：支持延迟队列，延迟一段时间后再将元素存入队列。</li> <li><strong>限速</strong>：支持限速队列，元素存入队列时进行速率限制。限制一个元素被重新排队（Reenqueued）的次数。</li> <li><strong>Metric</strong>：支持 metric 监控指标，可用于 Prometheus 监控。</li> </ul> <h2 id=_2>三 源码分析<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <h3 id=31>3.1 通用队列<a class=headerlink href=#31 title="Permanent link">&para;</a></h3> <h4 id=311>3.1.1 队列接口<a class=headerlink href=#311 title="Permanent link">&para;</a></h4> <p>通用队列FIFO 队列支持最基本的队列方法，例如插入元素、获取元素、获取队列长度等。另外，WorkQueue 中的限速及延迟队列都基于 Interface 接口实现，其提供如下方法：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1>// k8s.io/client-go/util/workqueue/queue.go</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kd>type</span><span class=w> </span><span class=nx>Interface</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>  </span><span class=c1>// 为队列添添加一个元素</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=nx>Add</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>  </span><span class=c1>// 获取队列长度</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>    </span><span class=nx>Len</span><span class=p>()</span><span class=w> </span><span class=kt>int</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>  </span><span class=c1>// 从头部获取一个元素</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>    </span><span class=nx>Get</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{},</span><span class=w> </span><span class=nx>shutdown</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>  </span><span class=c1>// 标记一个元素处理完成</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>    </span><span class=nx>Done</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>  </span><span class=c1>// 关闭队列</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>    </span><span class=nx>ShutDown</span><span class=p>()</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>  </span><span class=c1>// 获取队列是否正在关闭</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>    </span><span class=nx>ShuttingDown</span><span class=p>()</span><span class=w> </span><span class=kt>bool</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=p>}</span>
</code></pre></div> <h4 id=312>3.1.2 队列实现<a class=headerlink href=#312 title="Permanent link">&para;</a></h4> <p>通用队列具体实现为Type，其中有非常重要的三个属性，queue为一个任意类型元素的slice，是具体存储元素的地方，其实一个；dirty表示元素在内存中，可以对元素进行去重；processing表示当前正在处理中的元素。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1>// 具体queue的实现</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kd>type</span><span class=w> </span><span class=nx>Type</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=c1>// 存储具体元素，类型为slice</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span><span class=nx>queue</span><span class=w> </span><span class=p>[]</span><span class=nx>t</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span><span class=c1>// 定义所有的元素被处理，是以map类型，可以对元素去重</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>    </span><span class=nx>dirty</span><span class=w> </span><span class=nx>set</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span><span class=c1>// 标记元素是否正在处理。</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=c1>// 有些元素可能同时存在processing和dirty中，当处理完这个元素，从集合删除的时候，如果发现元素还在dirty集合中，在此将其添加至queue队列中</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span><span class=nx>processing</span><span class=w> </span><span class=nx>set</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>    </span><span class=nx>cond</span><span class=w> </span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>    </span><span class=nx>shuttingDown</span><span class=w> </span><span class=kt>bool</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=w>    </span><span class=nx>metrics</span><span class=w> </span><span class=nx>queueMetrics</span>
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>
<a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=w>    </span><span class=nx>unfinishedWorkUpdatePeriod</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
<a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=w>    </span><span class=nx>clock</span><span class=w>                      </span><span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
<a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=p>}</span>
<a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>
<a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a><span class=c1>// 空结构体</span>
<a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=kd>type</span><span class=w> </span><span class=nx>empty</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span>
<a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=c1>// t为空接口类型，表示任意类型</span>
<a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a><span class=kd>type</span><span class=w> </span><span class=nx>t</span><span class=w> </span><span class=kd>interface</span><span class=p>{}</span><span class=w>  </span>
<a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a><span class=c1>// set 集合，用 map 来模拟 set 集合（元素不重复），更快效率的查找元素</span>
<a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a><span class=kd>type</span><span class=w> </span><span class=nx>set</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=nx>t</span><span class=p>]</span><span class=nx>empty</span>
</code></pre></div> <h4 id=313>3.1.3 通用队列方法<a class=headerlink href=#313 title="Permanent link">&para;</a></h4> <ul> <li>Add</li> </ul> <p>Add方法为添加一个元素到item中，首先会判断队列是否关闭，其次会判断元素是否以及存在dirty中，如果在则返回实现去重，同时判断元素是否正在处理中，如果存在元素处理中，则不将其添加进queue中，而是等后期标记Done时候，将dirty中的元素添加进入queue中，如果没有正在处理，则元素成功添加进queue中。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>Type</span><span class=p>)</span><span class=w> </span><span class=nx>Add</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>  </span><span class=c1>// 如果队列已经关闭则直接返回</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>shuttingDown</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>        </span><span class=k>return</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>  </span><span class=c1>// 如果dirty中已经有该元素，则直接返回，目的是实现去重</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>dirty</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>        </span><span class=k>return</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>  </span><span class=c1>// 添加元素到dirty中</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>dirty</span><span class=p>.</span><span class=nx>insert</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>  </span><span class=c1>// 如果元素正在处理，则直接返回</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>processing</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=w>        </span><span class=k>return</span>
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=w>  </span><span class=c1>// 添加元素到queue中</span>
<a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=p>,</span><span class=w> </span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=w>  </span><span class=c1>// 通知其他协程接触阻塞</span>
<a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>Signal</span><span class=p>()</span>
<a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=p>}</span>
</code></pre></div> <ul> <li>Get</li> </ul> <p>Get方法，从队列头部弹出一个元素将放到proocessing集合中，从dirty集合中移除。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>Type</span><span class=p>)</span><span class=w> </span><span class=nx>Get</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{},</span><span class=w> </span><span class=nx>shutdown</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>  </span><span class=c1>// 如果队列为关闭，且队列长度为0，则进行阻塞，待元素添加进队列发送解除阻塞通知执行</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>!</span><span class=nx>q</span><span class=p>.</span><span class=nx>shuttingDown</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>        </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>Wait</span><span class=p>()</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>  </span><span class=c1>// 如果队列长度为0，则关闭队列</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>        </span><span class=c1>// We must be shutting down.</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>true</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>  </span><span class=c1>// 从队列头部填出第一个元素</span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>    </span><span class=nx>item</span><span class=p>,</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>  </span><span class=c1>// 将元素插入到processing中，标记为正在处理</span>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>processing</span><span class=p>.</span><span class=nx>insert</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>  </span><span class=c1>// 从dirty中删除队列</span>
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>dirty</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>item</span><span class=p>,</span><span class=w> </span><span class=kc>false</span>
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=p>}</span>
</code></pre></div> <ul> <li>Done</li> </ul> <p>Done方法标示元素以处理完成，该方法为了保证同一时刻不能有两个相同的元素被处理，如果正在处理一个元素，由添加进来同样的一个，先将其添加进dirty中，在Done方法中，再检查dirty将新元素重新入队列。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>Type</span><span class=p>)</span><span class=w> </span><span class=nx>Done</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>done</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>    </span><span class=c1>// 将processing中的元素移除</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>processing</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>  </span><span class=c1>// 判断元素是否还在dirty中，如果在则将其重新添加至queue中</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>dirty</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>        </span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>queue</span><span class=p>,</span><span class=w> </span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>        </span><span class=nx>q</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>Signal</span><span class=p>()</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=p>}</span>
</code></pre></div> <p>比较重要的就这三个方法，其他的Len/ShutDown比较简单，可以自己去参考源码。</p> <p><img alt src=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220204193947.png></p> <p>可以看到，在正常处理1元素时候，新添加进来的1不会立即被存入到queue中，而是待processing中1标记Done的时候，再将其插入到queue中，进行后续处理，注意dirty和processing都是Hash Map类型，其不用考虑无序，只保证去重即可。</p> <h3 id=32>3.2 延迟队列<a class=headerlink href=#32 title="Permanent link">&para;</a></h3> <h4 id=321>3.2.1 延迟队列接口<a class=headerlink href=#321 title="Permanent link">&para;</a></h4> <p>该接口涉及的目的就是可以避免某些失败的<code>items</code>陷入热循环. 因为某些<code>item</code>在出队列进行处理有可能失败, 失败了用户就有可能将该失败的<code>item</code>重新进队列, 如果短时间内又出队列有可能还是会失败(因为短时间内整个环境可能没有改变等等), 所以可能又重新进队列等等, 因此陷入了一种<code>hot-loop</code>. 所以就为用户提供了<code>AddAfter</code>方法, 可以允许用户告诉<code>DelayingInterface</code>过多长时间把该<code>item</code>加入队列中.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kd>type</span><span class=w> </span><span class=nx>DelayingInterface</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=nx>Interface</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>  </span><span class=c1>// 在此刻过duration时间后再加入到queue中 </span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>    </span><span class=nx>AddAfter</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{},</span><span class=w> </span><span class=nx>duration</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=p>}</span>
</code></pre></div> <h4 id=322>3.2.2 延迟队列实现<a class=headerlink href=#322 title="Permanent link">&para;</a></h4> <p>延迟队列的实现为delayingType，其继承了通用接口，在其基础上主要新增了waitingForAddCh字段，来实现延迟的功能</p> <p>waitingForAddCh：其默认初始大小为 1000，通过 AddAfter 方法插入元素时，是非阻塞状态的，只有当插入的元素大于或等于 1000 时，延迟队列才会处于阻塞状态。waitingForAddCh 字段中的数据通过 goroutine 运行的 waitingLoop 函数持久运行。</p> <p>waitFor: 保存了包括数据<code>data</code>和该<code>item</code>什么时间起(<code>readyAt</code>)就可以进入队列了. waitForPriorityQueue:waitForPriorityQueue 为 waitFor 项目实现优先级队列，是用于保存<code>waitFor</code>的优先队列, 按<code>readyAt</code>时间从早到晚排序，形成一个优先级队列， 先<code>ready</code>的<code>item</code>先出队列.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kd>type</span><span class=w> </span><span class=nx>delayingType</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=nx>Interface</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=c1>// clock tracks time for delayed firing</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=nx>clock</span><span class=w> </span><span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>    </span><span class=c1>// stopCh lets us signal a shutdown to the waiting loop</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=nx>stopCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>  </span><span class=c1>// 保证仅仅发送一次关闭信号</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>    </span><span class=nx>stopOnce</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>  </span><span class=c1>// 在触发之前确保等待的时间不超过maxWait</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>    </span><span class=nx>heartbeat</span><span class=w> </span><span class=nx>clock</span><span class=p>.</span><span class=nx>Ticker</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>  </span><span class=c1>// waitingForAddCh是一个缓冲channel</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>    </span><span class=nx>waitingForAddCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=o>*</span><span class=nx>waitFor</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>    </span><span class=c1>// 记录重试次数</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>    </span><span class=nx>metrics</span><span class=w> </span><span class=nx>retryMetrics</span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=p>}</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=c1>// 保存了包括数据`data`和该`item`什么时间起(`readyAt`)就可以进入队列了.</span>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=kd>type</span><span class=w> </span><span class=nx>waitFor</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>    </span><span class=nx>data</span><span class=w>    </span><span class=nx>t</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=w>    </span><span class=nx>readyAt</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=w>    </span><span class=c1>// index in the priority queue (heap)</span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=w>    </span><span class=nx>index</span><span class=w> </span><span class=kt>int</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=p>}</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=c1>// waitForPriorityQueue 为 waitFor 项目实现优先级队列</span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=c1>// 是用于保存`waitFor`的优先队列, 按`readyAt`时间从早到晚排序. 先`ready`的`item`先出队列.</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=kd>type</span><span class=w> </span><span class=nx>waitForPriorityQueue</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>waitFor</span>
</code></pre></div> <h4 id=323>3.2.3 延迟队列方法<a class=headerlink href=#323 title="Permanent link">&para;</a></h4> <ul> <li>AddAfter</li> </ul> <p>AddAfter方法为延迟队列添加元素，除了具体元素外，还需要传入延迟多长时间。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>delayingType</span><span class=p>)</span><span class=w> </span><span class=nx>AddAfter</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{},</span><span class=w> </span><span class=nx>duration</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>    </span><span class=c1>// don&#39;t add if we&#39;re already shutting down</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>ShuttingDown</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>        </span><span class=k>return</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>retry</span><span class=p>()</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>    </span><span class=c1>// 如果传入的时间小于等于0则立即添加</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>duration</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>        </span><span class=nx>q</span><span class=p>.</span><span class=nx>Add</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>        </span><span class=k>return</span>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>stopCh</span><span class=p>:</span>
<a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=w>        </span><span class=c1>// unblock if ShutDown() is called</span>
<a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=w>    </span><span class=c1>// 构造一个waitFor对象传入到waitingForAddCh通道中</span>
<a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>waitingForAddCh</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=o>&amp;</span><span class=nx>waitFor</span><span class=p>{</span><span class=nx>data</span><span class=p>:</span><span class=w> </span><span class=nx>item</span><span class=p>,</span><span class=w> </span><span class=nx>readyAt</span><span class=p>:</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nx>Now</span><span class=p>().</span><span class=nx>Add</span><span class=p>(</span><span class=nx>duration</span><span class=p>)}:</span>
<a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=p>}</span>
</code></pre></div> <ul> <li>waitingLoop</li> </ul> <p>waitingLoop 方法一直运行到工作队列关闭，并检查要添加的项目列表，利用channel(q.waitingForAddCh)一直接受从AddAfter过来的waitFor，将已经ready的item添加到队列中。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>delayingType</span><span class=p>)</span><span class=w> </span><span class=nx>waitingLoop</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>utilruntime</span><span class=p>.</span><span class=nx>HandleCrash</span><span class=p>()</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>  </span><span class=c1>// 创建一个占位channel，当list没有元素的时候，利用其实现等待</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>    </span><span class=nx>never</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>    </span><span class=c1>// 构造一个定时器，当等待队列头部的元素准备好后，该定时器失效</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=nx>nextReadyAtTimer</span><span class=w> </span><span class=nx>clock</span><span class=p>.</span><span class=nx>Timer</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>  </span><span class=c1>// 构造一个优先队列</span>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>    </span><span class=nx>waitingForQueue</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>waitForPriorityQueue</span><span class=p>{}</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>    </span><span class=nx>heap</span><span class=p>.</span><span class=nx>Init</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>)</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>    </span><span class=c1>// 利用map实现去重，如果在此添加相同元素，仅实现更新时间</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>    </span><span class=nx>waitingEntryByData</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=nx>t</span><span class=p>]</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>{}</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>Interface</span><span class=p>.</span><span class=nx>ShuttingDown</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>            </span><span class=k>return</span>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=w>        </span><span class=nx>now</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nx>Now</span><span class=p>()</span>
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=w>        </span><span class=c1>// 如果优先队列有元素</span>
<a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>waitingForQueue</span><span class=p>.</span><span class=nx>Len</span><span class=p>()</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=w>            </span><span class=nx>entry</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>waitingForQueue</span><span class=p>.</span><span class=nx>Peek</span><span class=p>().(</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span>
<a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=w>      </span><span class=c1>// 如果队列头部的元素时间已经大于现在时间，则表明整个优先级队列中的元素都大于当前时间，还没到插入元素的时间，则直接break</span>
<a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=w>      </span><span class=c1>// 第一个元素时间是最小的</span>
<a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>entry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nx>After</span><span class=p>(</span><span class=nx>now</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a><span class=w>                </span><span class=k>break</span>
<a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a><span class=w>            </span><span class=c1>// 否则说明以及改到了插入数据时间了，执行插入到通用队列中</span>
<a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a><span class=w>            </span><span class=nx>entry</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>heap</span><span class=p>.</span><span class=nx>Pop</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>).(</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span>
<a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a><span class=w>            </span><span class=nx>q</span><span class=p>.</span><span class=nx>Add</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
<a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a><span class=w>      </span><span class=c1>// 并从优先级队列删除</span>
<a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a><span class=w>            </span><span class=nb>delete</span><span class=p>(</span><span class=nx>waitingEntryByData</span><span class=p>,</span><span class=w> </span><span class=nx>entry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
<a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a><span class=w>        </span><span class=c1>// 当优先级队列中没有元素，则在后面进行等待</span>
<a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a><span class=w>        </span><span class=nx>nextReadyAt</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>never</span>
<a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a><span class=w>    </span><span class=c1>// 如果优先级队列中有元素</span>
<a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>waitingForQueue</span><span class=p>.</span><span class=nx>Len</span><span class=p>()</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>nextReadyAtTimer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a><span class=w>                </span><span class=nx>nextReadyAtTimer</span><span class=p>.</span><span class=nx>Stop</span><span class=p>()</span>
<a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a>
<a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a><span class=w>      </span><span class=c1>// 获取第一个元素</span>
<a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a><span class=w>            </span><span class=nx>entry</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>waitingForQueue</span><span class=p>.</span><span class=nx>Peek</span><span class=p>().(</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span>
<a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a><span class=w>      </span><span class=c1>// 构造一个nextReady时间等待器</span>
<a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a><span class=w>            </span><span class=nx>nextReadyAtTimer</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nx>NewTimer</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nx>Sub</span><span class=p>(</span><span class=nx>now</span><span class=p>))</span>
<a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a><span class=w>            </span><span class=nx>nextReadyAt</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>nextReadyAtTimer</span><span class=p>.</span><span class=nx>C</span><span class=p>()</span>
<a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a>
<a id=__codelineno-8-50 name=__codelineno-8-50 href=#__codelineno-8-50></a><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-51 name=__codelineno-8-51 href=#__codelineno-8-51></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>stopCh</span><span class=p>:</span>
<a id=__codelineno-8-52 name=__codelineno-8-52 href=#__codelineno-8-52></a><span class=w>            </span><span class=k>return</span>
<a id=__codelineno-8-53 name=__codelineno-8-53 href=#__codelineno-8-53></a><span class=w>        </span><span class=c1>// 定时器，如果过一段时间在没有任何数据，则进行一次大循环</span>
<a id=__codelineno-8-54 name=__codelineno-8-54 href=#__codelineno-8-54></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>heartbeat</span><span class=p>.</span><span class=nx>C</span><span class=p>():</span>
<a id=__codelineno-8-55 name=__codelineno-8-55 href=#__codelineno-8-55></a><span class=w>            </span><span class=c1>// continue the loop, which will add ready items</span>
<a id=__codelineno-8-56 name=__codelineno-8-56 href=#__codelineno-8-56></a>
<a id=__codelineno-8-57 name=__codelineno-8-57 href=#__codelineno-8-57></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>nextReadyAt</span><span class=p>:</span>
<a id=__codelineno-8-58 name=__codelineno-8-58 href=#__codelineno-8-58></a><span class=w>            </span><span class=c1>// continue the loop, which will add ready items</span>
<a id=__codelineno-8-59 name=__codelineno-8-59 href=#__codelineno-8-59></a>
<a id=__codelineno-8-60 name=__codelineno-8-60 href=#__codelineno-8-60></a><span class=w>    </span><span class=c1>// addAfter放入的元素从该处获取</span>
<a id=__codelineno-8-61 name=__codelineno-8-61 href=#__codelineno-8-61></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=nx>waitEntry</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>waitingForAddCh</span><span class=p>:</span>
<a id=__codelineno-8-62 name=__codelineno-8-62 href=#__codelineno-8-62></a><span class=w>      </span><span class=c1>// 如果元素时间大于当前时间，则添加到优先级队列中</span>
<a id=__codelineno-8-63 name=__codelineno-8-63 href=#__codelineno-8-63></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>waitEntry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nx>After</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nx>Now</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-64 name=__codelineno-8-64 href=#__codelineno-8-64></a><span class=w>                </span><span class=nx>insert</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>,</span><span class=w> </span><span class=nx>waitingEntryByData</span><span class=p>,</span><span class=w> </span><span class=nx>waitEntry</span><span class=p>)</span>
<a id=__codelineno-8-65 name=__codelineno-8-65 href=#__codelineno-8-65></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-66 name=__codelineno-8-66 href=#__codelineno-8-66></a><span class=w>        </span><span class=c1>// 时间到了则添加进通用队列</span>
<a id=__codelineno-8-67 name=__codelineno-8-67 href=#__codelineno-8-67></a><span class=w>                </span><span class=nx>q</span><span class=p>.</span><span class=nx>Add</span><span class=p>(</span><span class=nx>waitEntry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
<a id=__codelineno-8-68 name=__codelineno-8-68 href=#__codelineno-8-68></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-8-69 name=__codelineno-8-69 href=#__codelineno-8-69></a><span class=w>            </span><span class=c1>// 将channel中的元素全部取出来</span>
<a id=__codelineno-8-70 name=__codelineno-8-70 href=#__codelineno-8-70></a><span class=w>            </span><span class=nx>drained</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kc>false</span>
<a id=__codelineno-8-71 name=__codelineno-8-71 href=#__codelineno-8-71></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>!</span><span class=nx>drained</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-72 name=__codelineno-8-72 href=#__codelineno-8-72></a><span class=w>                </span><span class=k>select</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-73 name=__codelineno-8-73 href=#__codelineno-8-73></a><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=nx>waitEntry</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>waitingForAddCh</span><span class=p>:</span>
<a id=__codelineno-8-74 name=__codelineno-8-74 href=#__codelineno-8-74></a><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=nx>waitEntry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nx>After</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nx>Now</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-75 name=__codelineno-8-75 href=#__codelineno-8-75></a><span class=w>                        </span><span class=nx>insert</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>,</span><span class=w> </span><span class=nx>waitingEntryByData</span><span class=p>,</span><span class=w> </span><span class=nx>waitEntry</span><span class=p>)</span>
<a id=__codelineno-8-76 name=__codelineno-8-76 href=#__codelineno-8-76></a><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-77 name=__codelineno-8-77 href=#__codelineno-8-77></a><span class=w>                        </span><span class=nx>q</span><span class=p>.</span><span class=nx>Add</span><span class=p>(</span><span class=nx>waitEntry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
<a id=__codelineno-8-78 name=__codelineno-8-78 href=#__codelineno-8-78></a><span class=w>                    </span><span class=p>}</span>
<a id=__codelineno-8-79 name=__codelineno-8-79 href=#__codelineno-8-79></a><span class=w>                </span><span class=k>default</span><span class=p>:</span>
<a id=__codelineno-8-80 name=__codelineno-8-80 href=#__codelineno-8-80></a><span class=w>                    </span><span class=nx>drained</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span>
<a id=__codelineno-8-81 name=__codelineno-8-81 href=#__codelineno-8-81></a><span class=w>                </span><span class=p>}</span>
<a id=__codelineno-8-82 name=__codelineno-8-82 href=#__codelineno-8-82></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-8-83 name=__codelineno-8-83 href=#__codelineno-8-83></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-8-84 name=__codelineno-8-84 href=#__codelineno-8-84></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-8-85 name=__codelineno-8-85 href=#__codelineno-8-85></a><span class=p>}</span>
<a id=__codelineno-8-86 name=__codelineno-8-86 href=#__codelineno-8-86></a>
<a id=__codelineno-8-87 name=__codelineno-8-87 href=#__codelineno-8-87></a><span class=c1>// 添加元素至优先级队列，如果元素相同则进行更新时间</span>
<a id=__codelineno-8-88 name=__codelineno-8-88 href=#__codelineno-8-88></a><span class=kd>func</span><span class=w> </span><span class=nx>insert</span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>waitForPriorityQueue</span><span class=p>,</span><span class=w> </span><span class=nx>knownEntries</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=nx>t</span><span class=p>]</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>,</span><span class=w> </span><span class=nx>entry</span><span class=w> </span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-89 name=__codelineno-8-89 href=#__codelineno-8-89></a><span class=w>    </span><span class=c1>// 判断队列中是否已经存在该元素</span>
<a id=__codelineno-8-90 name=__codelineno-8-90 href=#__codelineno-8-90></a><span class=w>    </span><span class=nx>existing</span><span class=p>,</span><span class=w> </span><span class=nx>exists</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>knownEntries</span><span class=p>[</span><span class=nx>entry</span><span class=p>.</span><span class=nx>data</span><span class=p>]</span>
<a id=__codelineno-8-91 name=__codelineno-8-91 href=#__codelineno-8-91></a><span class=w>  </span><span class=c1>// 如果存则，则直接更新元素</span>
<a id=__codelineno-8-92 name=__codelineno-8-92 href=#__codelineno-8-92></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>exists</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-93 name=__codelineno-8-93 href=#__codelineno-8-93></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nx>After</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-94 name=__codelineno-8-94 href=#__codelineno-8-94></a><span class=w>            </span><span class=nx>existing</span><span class=p>.</span><span class=nx>readyAt</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>entry</span><span class=p>.</span><span class=nx>readyAt</span>
<a id=__codelineno-8-95 name=__codelineno-8-95 href=#__codelineno-8-95></a><span class=w>            </span><span class=nx>heap</span><span class=p>.</span><span class=nx>Fix</span><span class=p>(</span><span class=nx>q</span><span class=p>,</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>index</span><span class=p>)</span>
<a id=__codelineno-8-96 name=__codelineno-8-96 href=#__codelineno-8-96></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-8-97 name=__codelineno-8-97 href=#__codelineno-8-97></a>
<a id=__codelineno-8-98 name=__codelineno-8-98 href=#__codelineno-8-98></a><span class=w>        </span><span class=k>return</span>
<a id=__codelineno-8-99 name=__codelineno-8-99 href=#__codelineno-8-99></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-8-100 name=__codelineno-8-100 href=#__codelineno-8-100></a><span class=w>    </span><span class=c1>// 不存在则添加进优先级队列</span>
<a id=__codelineno-8-101 name=__codelineno-8-101 href=#__codelineno-8-101></a><span class=w>    </span><span class=nx>heap</span><span class=p>.</span><span class=nx>Push</span><span class=p>(</span><span class=nx>q</span><span class=p>,</span><span class=w> </span><span class=nx>entry</span><span class=p>)</span>
<a id=__codelineno-8-102 name=__codelineno-8-102 href=#__codelineno-8-102></a><span class=w>    </span><span class=nx>knownEntries</span><span class=p>[</span><span class=nx>entry</span><span class=p>.</span><span class=nx>data</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>entry</span>
<a id=__codelineno-8-103 name=__codelineno-8-103 href=#__codelineno-8-103></a><span class=p>}</span>
</code></pre></div> <p>至此就完成了限速队列的源码分析，其在通用队列之上构造优先级队列，如果时间没到的添加到优先级队列中，待时间到了添加到通用队列中进行正常处理，其中优先级队列实现利用了golang底层库heap，又兴趣的可以进一步阅读源码。</p> <h3 id=33>3.3 限速队列<a class=headerlink href=#33 title="Permanent link">&para;</a></h3> <h4 id=331>3.3.1 限速队列接口<a class=headerlink href=#331 title="Permanent link">&para;</a></h4> <p>限速队列，顾名思义就是在元素入对速度有一定限制，其利用延迟队列的特性实现对元素插入队列的速度控制，因此限速队列也是扩展的延迟队列，新增有AddRateLimited、Forget、NumRequeues 3个方法。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=kd>type</span><span class=w> </span><span class=nx>RateLimitingInterface</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>    </span><span class=nx>DelayingInterface</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>    </span><span class=c1>// 增加一个元素大限速队列</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>    </span><span class=nx>AddRateLimited</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>  </span><span class=c1>// 表示完成该元素重试，丢弃掉该元素</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>    </span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>    </span><span class=c1>// 查询元素入队列的次数</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>    </span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>int</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=p>}</span>
</code></pre></div> <h4 id=332>3.3.2 限速队列实现<a class=headerlink href=#332 title="Permanent link">&para;</a></h4> <p>我们看其中主要还是调用rateLimiter 的接口方法，</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1>// rateLimitingType 是限速队列的具体实现</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=kd>type</span><span class=w> </span><span class=nx>rateLimitingType</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>  </span><span class=c1>// 继承延迟队列</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=nx>DelayingInterface</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span><span class=c1>// 新增限速接口</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=nx>rateLimiter</span><span class=w> </span><span class=nx>RateLimiter</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=p>}</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=c1>// 获取到限速器延迟时间，然后加入到延迟队列</span>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>rateLimitingType</span><span class=p>)</span><span class=w> </span><span class=nx>AddRateLimited</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>DelayingInterface</span><span class=p>.</span><span class=nx>AddAfter</span><span class=p>(</span><span class=nx>item</span><span class=p>,</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>rateLimiter</span><span class=p>.</span><span class=nx>When</span><span class=p>(</span><span class=nx>item</span><span class=p>))</span>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=p>}</span>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=c1>// 通过限速器获取元素加入队列的次数</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>rateLimitingType</span><span class=p>)</span><span class=w> </span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>rateLimiter</span><span class=p>.</span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=p>}</span>
<a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>
<a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=c1>// 通过限速器丢弃元素</span>
<a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>rateLimitingType</span><span class=p>)</span><span class=w> </span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=w>    </span><span class=nx>q</span><span class=p>.</span><span class=nx>rateLimiter</span><span class=p>.</span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a><span class=p>}</span>
</code></pre></div> <h4 id=333>3.3.3 限速器方法<a class=headerlink href=#333 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1>// 限速器接口</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=kd>type</span><span class=w> </span><span class=nx>RateLimiter</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>    </span><span class=c1>// 获取元素等待时间</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>    </span><span class=nx>When</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>    </span><span class=c1>// 释放指定元素</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>    </span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>    </span><span class=c1>// 返回某个对象重新入队列次数</span>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>    </span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>int</span>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=p>}</span>
</code></pre></div> <p><img alt src=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220206194921.png> </p> <ul> <li>BucketRateLimiter</li> </ul> <p>令牌桶算法是通过 Go 语言的第三方库 golang.org/x/time/rate 实现的。令牌桶算法内部实现了一个存放 token（令牌）的“桶”，初始时“桶”是空的，token 会以固定速率往“桶”里填充，直到将其填满为止，多余的 token 会被丢弃。每个元素都会从令牌桶得到一个 token，只有得到 token 的元素才允许通过（accept），而没有得到 token 的元素处于等待状态。令牌桶算法通过控制发放 token 来达到限速目的。</p> <p><img alt src=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220206212915.png></p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=kd>type</span><span class=w> </span><span class=nx>BucketRateLimiter</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>    </span><span class=o>*</span><span class=nx>rate</span><span class=p>.</span><span class=nx>Limiter</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=p>}</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>BucketRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>When</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Limiter</span><span class=p>.</span><span class=nx>Reserve</span><span class=p>().</span><span class=nx>Delay</span><span class=p>()</span>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=p>}</span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>BucketRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=p>}</span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>
<a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>BucketRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=p>}</span>
</code></pre></div> <p>在实例化 rate.NewLimiter 后，传入 r 和 b 两个参数，其中 r 参数表示每秒往“桶”里填充的 token 数量，b 参数表示令牌桶的大小（即令牌桶最多存放的 token 数量）。我们假定 r 为 10，b 为 100。假设在一个限速周期内插入了 1000 个元素，通过 r.Limiter.Reserve().Delay 函数返回指定元素应该等待的时间，那么前 b（即 100）个元素会被立刻处理，而后面元素的延迟时间分别为 item100/100ms、item101/200ms、item102/300ms、item103/400ms，以此类推。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=kd>func</span><span class=w> </span><span class=nx>DefaultControllerRateLimiter</span><span class=p>()</span><span class=w> </span><span class=nx>RateLimiter</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NewMaxOfRateLimiter</span><span class=p>(</span>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>        </span><span class=nx>NewItemExponentialFailureRateLimiter</span><span class=p>(</span><span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>,</span><span class=w> </span><span class=mi>1000</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>        </span><span class=c1>// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>    </span><span class=c1>// 默认令牌桶限速器</span>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>        </span><span class=o>&amp;</span><span class=nx>BucketRateLimiter</span><span class=p>{</span><span class=nx>Limiter</span><span class=p>:</span><span class=w> </span><span class=nx>rate</span><span class=p>.</span><span class=nx>NewLimiter</span><span class=p>(</span><span class=nx>rate</span><span class=p>.</span><span class=nx>Limit</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span><span class=w> </span><span class=mi>100</span><span class=p>)},</span>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>    </span><span class=p>)</span>
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=p>}</span>
</code></pre></div> <ul> <li>ItemExponentialFailureRateLimiter</li> </ul> <p>排队指数算法将相同元素的排队数作为指数，排队数增大，速率限制呈指数级增长，但其最大值不会超过 maxDelay。元素的排队数统计是有限速周期的，一个限速周期是指从执行 AddRateLimited 方法到执行完 Forget 方法之间的时间。如果该元素被 Forget 方法处理完，则清空排队数。排队指数算法的核心实现代码示例如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ItemExponentialFailureRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>When</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>    </span><span class=nx>exp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>    </span><span class=c1>// The backoff is capped such that &#39;calculated&#39; value never overflows.</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>    </span><span class=nx>backoff</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>baseDelay</span><span class=p>.</span><span class=nx>Nanoseconds</span><span class=p>())</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>math</span><span class=p>.</span><span class=nx>Pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>exp</span><span class=p>))</span>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>backoff</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>math</span><span class=p>.</span><span class=nx>MaxInt64</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>maxDelay</span>
<a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a>
<a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=w>    </span><span class=nx>calculated</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>(</span><span class=nx>backoff</span><span class=p>)</span>
<a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>calculated</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>maxDelay</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>maxDelay</span>
<a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>
<a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>calculated</span>
<a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=p>}</span>
<a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a>
<a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ItemExponentialFailureRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a>
<a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span>
<a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=p>}</span>
<a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a>
<a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ItemExponentialFailureRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-14-31 name=__codelineno-14-31 href=#__codelineno-14-31></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-14-32 name=__codelineno-14-32 href=#__codelineno-14-32></a>
<a id=__codelineno-14-33 name=__codelineno-14-33 href=#__codelineno-14-33></a><span class=w>    </span><span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>,</span><span class=w> </span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-14-34 name=__codelineno-14-34 href=#__codelineno-14-34></a><span class=p>}</span>
</code></pre></div> <p>failures 字段用于统计元素排队数，每当 AddRateLimited 方法插入新元素时，会为该字段加 1；另外，baseDelay 字段是最初的限速单位（默认为 5ms），maxDelay 字段是最大限速单位（默认为 1000s）</p> <p>限速队列利用延迟队列的特性，延迟多个相同元素的插入时间，达到限速目的。</p> <p>我们假定 baseDelay 是 1 * time.Millisecond，maxDelay 是 1000 * time.Second。假设在一个限速周期内通过 AddRateLimited 方法插入 10 个相同元素，那么第 1 个元素会通过延迟队列的 AddAfter 方法插入并设置延迟时间为 1ms（即 baseDelay），第 2 个相同元素的延迟时间为 2ms，第 3 个相同元素的延迟时间为 4ms，第 4 个相同元素的延迟时间为 8ms，第 5 个相同元素的延迟时间为 16ms……第 10 个相同元素的延迟时间为 512ms，最长延迟时间不超过 1000s（即 maxDelay）。</p> <ul> <li>ItemFastSlowRateLimiter</li> </ul> <p>计数器算法是限速算法中最简单的一种，其原理是：限制一段时间内允许通过的元素数量，例如在 1 分钟内只允许通过 100 个元素，每插入一个元素，计数器自增 1，当计数器数到 100 的阈值且还在限速周期内时，则不允许元素再通过。但 WorkQueue 在此基础上扩展了 fast 和 slow 速率。</p> <p>计数器算法提供了 4 个主要字段：failures、fastDelay、slowDelay 及 maxFastAttempts。其中，failures 字段用于统计元素排队数，每当 AddRateLimited 方法插入新元素时，会为该字段加 1；而 fastDelay 和 slowDelay 字段是用于定义 fast、slow 速率的；另外，maxFastAttempts 字段用于控制从 fast 速率转换到 slow 速率。计数器算法核心实现的代码示例如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=kd>type</span><span class=w> </span><span class=nx>ItemFastSlowRateLimiter</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>    </span><span class=nx>failuresLock</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>    </span><span class=nx>failures</span><span class=w>     </span><span class=kd>map</span><span class=p>[</span><span class=kd>interface</span><span class=p>{}]</span><span class=kt>int</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=nx>maxFastAttempts</span><span class=w> </span><span class=kt>int</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=nx>fastDelay</span><span class=w>       </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>    </span><span class=nx>slowDelay</span><span class=w>       </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=p>}</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ItemFastSlowRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>When</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a>
<a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span>
<a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a>
<a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>maxFastAttempts</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>fastDelay</span>
<a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a>
<a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>slowDelay</span>
<a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=p>}</span>
<a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a>
<a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ItemFastSlowRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a>
<a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span>
<a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a><span class=p>}</span>
<a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a>
<a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ItemFastSlowRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a><span class=w>    </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Lock</span><span class=p>()</span>
<a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nx>Unlock</span><span class=p>()</span>
<a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a>
<a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a><span class=w>    </span><span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>,</span><span class=w> </span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-15-35 name=__codelineno-15-35 href=#__codelineno-15-35></a><span class=p>}</span>
</code></pre></div> <p>假设 fastDelay 是 5 * time.Millisecond，slowDelay 是 10 * time.Second，maxFastAttempts 是 3。在一个限速周期内通过 AddRateLimited 方法插入 4 个相同的元素，那么前 3 个元素使用 fastDelay 定义的 fast 速率，当触发 maxFastAttempts 字段时，第 4 个元素使用 slowDelay 定义的 slow 速率。</p> <ul> <li>MaxOfRateLimiter</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=kd>type</span><span class=w> </span><span class=nx>MaxOfRateLimiter</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=w>    </span><span class=nx>limiters</span><span class=w> </span><span class=p>[]</span><span class=nx>RateLimiter</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=p>}</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>MaxOfRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>When</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span><span class=nx>ret</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>limiter</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>limiters</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>        </span><span class=nx>curr</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>limiter</span><span class=p>.</span><span class=nx>When</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>curr</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>ret</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>            </span><span class=nx>ret</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>curr</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>ret</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=p>}</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>MaxOfRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>    </span><span class=nx>ret</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>limiter</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>limiters</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>        </span><span class=nx>curr</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>limiter</span><span class=p>.</span><span class=nx>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>curr</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>ret</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=w>            </span><span class=nx>ret</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>curr</span>
<a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a>
<a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>ret</span>
<a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a><span class=p>}</span>
<a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a>
<a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>MaxOfRateLimiter</span><span class=p>)</span><span class=w> </span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>limiter</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>limiters</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=w>        </span><span class=nx>limiter</span><span class=p>.</span><span class=nx>Forget</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
<a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a><span class=p>}</span>
</code></pre></div> <p>混合模式是将多种限速算法混合使用，即多种限速算法同时生效。例如，同时使用排队指数算法和令牌桶算法，代码示例如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=kd>func</span><span class=w> </span><span class=nx>DefaultControllerRateLimiter</span><span class=p>()</span><span class=w> </span><span class=nx>RateLimiter</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NewMaxOfRateLimiter</span><span class=p>(</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=w>        </span><span class=nx>NewItemExponentialFailureRateLimiter</span><span class=p>(</span><span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>,</span><span class=w> </span><span class=mi>1000</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=w>        </span><span class=c1>// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>        </span><span class=o>&amp;</span><span class=nx>BucketRateLimiter</span><span class=p>{</span><span class=nx>Limiter</span><span class=p>:</span><span class=w> </span><span class=nx>rate</span><span class=p>.</span><span class=nx>NewLimiter</span><span class=p>(</span><span class=nx>rate</span><span class=p>.</span><span class=nx>Limit</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span><span class=w> </span><span class=mi>100</span><span class=p>)},</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=w>    </span><span class=p>)</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=p>}</span>
</code></pre></div> <h2 id=_3>四 小试牛刀<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <h3 id=41>4.1 通用队列<a class=headerlink href=#41 title="Permanent link">&para;</a></h3> <h3 id=42>4.2 延迟队列<a class=headerlink href=#42 title="Permanent link">&para;</a></h3> <h3 id=43>4.3 限速队列<a class=headerlink href=#43 title="Permanent link">&para;</a></h3> <h2 id=_4>参考链接<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <ul> <li><a href=https://mp.weixin.qq.com/s/-qiB1KilhwtcjI61m_x3jA>https://mp.weixin.qq.com/s/-qiB1KilhwtcjI61m_x3jA</a></li> <li><a href=https://xie.infoq.cn/article/63258ead84821bc3e276de1f7>https://xie.infoq.cn/article/63258ead84821bc3e276de1f7</a></li> <li><a href=https://www.jianshu.com/p/d42da5d5f586>https://www.jianshu.com/p/d42da5d5f586</a></li> </ul> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/redhatxl/redhatxl.github.io/issues/new/?title=[Feedback]+11.Client-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BWorkQueue+-+/cloud-native/develop/11-client-go%E4%B9%8BWorkqueue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target=_blank>feedback form</a>. </div> </div> </div> </fieldset> </form> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2016 - 2024 kaliarch </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/redhatxl target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220125122524.png target=_blank rel=noopener title=kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154zm-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4zm-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2zM563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4zm-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6zm107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">同意</button> <label class=md-button for=__settings>管理设定</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.annotate", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.bd41221c.min.js></script> </body> </html>